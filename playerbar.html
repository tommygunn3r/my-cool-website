<div id="player-bar-wrapper" style="
    width:100%;
    padding:12px 22px;
    background:rgba(10,10,10,0.92);
    border-bottom:3px solid #e94560;
    display:flex;
    justify-content:space-between;
    align-items:center;
    color:#fff;
    font-family:'Segoe UI', sans-serif;
    position:sticky;
    top:0;
    z-index:2000;
">
    <div style="display:flex; align-items:center; gap:12px;">
        <span id="pb-player-name" style="font-size:1.2rem; font-weight:bold;">
            PLAYER
        </span>
        <span style="font-size:1.2rem;">ðŸª™</span>
        <span id="pb-player-coins" style="font-size:1.1rem;">
            0
        </span>
    </div>

    <div style="display:flex; align-items:center; gap:8px;">
        <!-- LOGIN button for guests -->
        <button id="pb-login-btn" type="button"
            style="
                padding:8px 14px;
                background:rgba(233,69,96,0.2);
                border:2px solid #e94560;
                color:white;
                border-radius:8px;
                cursor:pointer;
                font-weight:bold;
                display:none;
            "
            onclick="pbOpenLogin()">
            Login
        </button>

        <!-- SETTINGS button for logged-in users -->
        <button type="button" class="pb-settings-btn"
            style="
                padding:8px 16px;
                background:rgba(233,69,96,0.2);
                border:2px solid #e94560;
                color:white;
                border-radius:8px;
                cursor:pointer;
                font-weight:bold;
                display:none;
            "
            onclick="togglePBMenu(event)">
            âš™ Settings
        </button>
    </div>

    <div id="pb-settings-menu" style="
        position:absolute;
        top:56px;
        right:22px;
        background:#111;
        border:1px solid #333;
        border-radius:10px;
        padding:8px 0;
        display:none;
        width:200px;
        z-index:3000;
    ">
        <div onclick="pbOpenChangeName()" style="padding:10px 16px; cursor:pointer;">Change Player Name</div>
        <div onclick="pbOpenResetPassword()" style="padding:10px 16px; cursor:pointer;">Reset Password</div>
        <div onclick="pbDeleteAccount()" style="padding:10px 16px; cursor:pointer;">Delete Account</div>
        <div onclick="pbLogout()" style="padding:10px 16px; cursor:pointer;">Log Out</div>
    </div>
</div>

<script>
async function pbGetSession() {
    try {
        if (typeof supabase === "undefined") return null;
        const { data: { session } } = await supabase.auth.getSession();
        return session;
    } catch (e) {
        console.error("pbGetSession error", e);
        return null;
    }
}

async function pbLoadPlayerData() {
    const nameSpan = document.getElementById("pb-player-name");
    const coinSpan = document.getElementById("pb-player-coins");
    const loginBtn = document.getElementById("pb-login-btn");
    const settingsBtn = document.querySelector(".pb-settings-btn");

    if (!nameSpan || !coinSpan) return;

    const session = await pbGetSession();

    if (!session) {
        // guest
        nameSpan.textContent = "GUEST";
        coinSpan.textContent = "0";
        if (loginBtn) loginBtn.style.display = "inline-flex";
        if (settingsBtn) settingsBtn.style.display = "none";
        return;
    }

    if (typeof supabase === "undefined") {
        nameSpan.textContent = "PLAYER";
        if (loginBtn) loginBtn.style.display = "none";
        if (settingsBtn) settingsBtn.style.display = "inline-flex";
        return;
    }

    const { data, error } = await supabase
        .from("profiles")
        .select("player_name, gunnercoins")
        .eq("id", session.user.id)
        .single();

    if (error || !data) {
        console.error("pbLoadPlayerData profile error", error);
        nameSpan.textContent = "PLAYER";
        coinSpan.textContent = "0";
    } else {
        nameSpan.textContent = data.player_name || "PLAYER";
        coinSpan.textContent = data.gunnercoins != null ? data.gunnercoins : 0;
    }

    if (loginBtn) loginBtn.style.display = "none";
    if (settingsBtn) settingsBtn.style.display = "inline-flex";
}

function togglePBMenu(e) {
    e.stopPropagation(); // don't trigger document click
    const menu = document.getElementById("pb-settings-menu");
    if (!menu) return;
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

document.addEventListener("click", (e) => {
    const menu = document.getElementById("pb-settings-menu");
    if (!menu) return;
    if (!e.target.closest("#pb-settings-menu") &&
        !e.target.closest(".pb-settings-btn")) {
        menu.style.display = "none";
    }
});

// Actions wired into your existing functions on index.html
function pbOpenLogin() {
    if (typeof openModal === "function") {
        openModal("login");
    } else {
        window.location.href = "index.html";
    }
}

function pbOpenChangeName() {
    if (typeof openChangeName === "function") {
        openChangeName();
    } else {
        window.location.href = "index.html";
    }
}

function pbOpenResetPassword() {
    if (typeof openResetPasswordModal === "function") {
        openResetPasswordModal();
    } else {
        window.location.href = "index.html";
    }
}

function pbDeleteAccount() {
    if (typeof confirmDeleteAccount === "function") {
        confirmDeleteAccount();
    } else {
        window.location.href = "index.html";
    }
}

async function pbLogout() {
    if (typeof handleLogout === "function") {
        await handleLogout();
    } else if (typeof supabase !== "undefined") {
        await supabase.auth.signOut();
    }
    localStorage.removeItem("supabase.auth.token");
    window.location.href = "index.html";
}

// periodically refresh display
pbLoadPlayerData();
setInterval(pbLoadPlayerData, 15000);
</script>
