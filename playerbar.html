<!-- =======================
     GLOBAL PLAYER BAR
     + GLOBAL AUTH MODALS
     ======================= -->

<div id="player-bar-wrapper" style="
    width:100%;
    padding:12px 22px;
    background:rgba(10,10,10,0.92);
    border-bottom:0px solid #e94560;
    display:flex;
    justify-content:space-between;
    align-items:center;
    color:#fff;
    font-family:'Segoe UI', sans-serif;
    position:fixed;
    top:0;
    z-index:2000;
">
    <div style="display:flex; align-items:center; gap:12px;">
        <span id="pb-player-name" style="font-size:1.2rem; font-weight:bold;">
            PLAYER
        </span>
        <span style="font-size:1.2rem;">ü™ô</span>
        <span id="pb-player-coins" style="font-size:1.1rem;">
            0
        </span>
    </div>

    <div style="display:flex; align-items:center; gap:8px;">
        <button id="pb-login-btn" type="button"
            style="
                padding:8px 14px;
                background:rgba(233,69,96,0.2);
                border:2px solid #e94560;
                color:white;
                border-radius:8px;
                cursor:pointer;
                font-weight:bold;
                display:none;
            "
            onclick="openModal()">
            Login
        </button>

        <button type="button" class="pb-settings-btn"
            style="
                padding:8px 16px;
                background:rgba(233,69,96,0.2);
                border:2px solid #e94560;
                color:white;
                border-radius:8px;
                cursor:pointer;
                font-weight:bold;
                display:none;
            "
            onclick="togglePBMenu(event)">
            ‚öô Settings
        </button>
    </div>

    <div id="pb-settings-menu" style="
        position:absolute;
        top:56px;
        right:22px;
        background:#000;
        border:1px solid #333;
        border-radius:10px;
        padding:8px 0;
        display:none;
        width:200px;
        z-index:3000;
    ">
        <div onclick="openChangeName()" style="padding:10px 16px; cursor:pointer;">Change Player Name</div>
        <div onclick="openResetPasswordModal()" style="padding:10px 16px; cursor:pointer;">Reset Password</div>
        <div onclick="pbDeleteAccount()" style="padding:10px 16px; cursor:pointer;">Delete Account</div>
        <div onclick="pbLogout()" style="padding:10px 16px; cursor:pointer;">Log Out</div>
    </div>
</div>



<!-- ================================
     GLOBAL AUTH MODALS LIVE HERE NOW
     ================================ -->

<!-- LOGIN MODAL -->
<div id="authModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #e94560; position:relative;">
        <span class="close-modal" onclick="closeModal()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#e94560;">Login</h2>

        <div class="input-group">
            <label>Email</label>
            <input id="loginEmail" class="input-field" type="email">
        </div>
        <div class="input-group">
            <label>Password</label>
            <input id="loginPass" class="input-field" type="password">
        </div>

        <div id="loginError" style="color:#ff4444; display:none;"></div>

        <button id="btnLogin" type="button" class="submit-btn"
            style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:6px; margin-top:10px;">
            LOGIN
        </button>

        <div class="switch-link" style="text-align:center; margin-top:12px;">
            <span style="color:#bbb;">No account? </span>
            <span style="color:#e94560; cursor:pointer;" onclick="openSignup()">Create one</span>
        </div>

        <div style="text-align:center; margin-top:12px;">
            <span style="color:#e94560; cursor:pointer;" onclick="openResetPasswordModal()">Forgot Password?</span>
        </div>
    </div>
</div>

<!-- SIGNUP MODAL -->
<div id="signupModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #e94560; position:relative;">
        <span class="close-modal" onclick="closeModal()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#e94560;">Create Account</h2>

        <div class="input-group">
            <label>Name</label>
            <input id="regName" class="input-field">
        </div>

        <div class="input-group">
            <label>Email</label>
            <input id="regEmail" class="input-field" type="email">
        </div>

        <div class="input-group">
            <label>Password</label>
            <input id="regPass" class="input-field" type="password">
        </div>

        <div id="signupError" style="color:#ff4444; display:none;"></div>

        <button id="btnSignup" type="button" class="submit-btn"
            style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:6px; margin-top:10px;">
            CREATE ACCOUNT
        </button>

        <div class="switch-link" style="text-align:center; margin-top:12px;">
            <span style="color:#bbb;">Already have an account? </span>
            <span style="color:#e94560; cursor:pointer;" onclick="openModal()">Login</span>
        </div>
    </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div id="resetPasswordModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #e94560; position:relative;">
        <span class="close-modal" onclick="closeResetPasswordModal()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#e94560;">Reset Password</h2>

        <div class="input-group">
            <label>Email</label>
            <input id="resetEmail" class="input-field" type="email">
        </div>

        <div id="resetError" style="color:#ff4444; display:none;"></div>
        <div id="resetSuccess" style="color:#44ff44; display:none;"></div>

        <button type="button" onclick="sendPasswordReset()" class="submit-btn"
            style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:6px; margin-top:10px;">
            Send Reset Email
        </button>
    </div>
</div>

<!-- CHANGE NAME MODAL -->
<div id="changeNameModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #e94560; position:relative;">
        <span class="close-modal" onclick="closeChangeName()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#e94560;">Change Name</h2>

        <div class="input-group">
            <label>New Name</label>
            <input id="newPlayerName" class="input-field">
        </div>

        <div id="nameChangeError" style="color:#ff4444; display:none;"></div>

        <button type="button" onclick="changePlayerName()" class="submit-btn"
            style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:6px; margin-top:10px;">
            Update Name
        </button>
    </div>
</div>

<!-- LOW COINS MODAL -->
<div id="lowCoinsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #ffd700; position:relative;">
        <span class="close-modal" onclick="closeLowCoinsModal()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#ffd700;">‚ö†Ô∏è Not Enough Coins!</h2>
        
        <p style="text-align:center; color:#fff; margin:20px 0;">
            You need <strong>1 GunnerCoin</strong> to play arcade games.<br>
            Play casino games to earn more coins!
        </p>

        <button type="button" onclick="closeLowCoinsModal()" class="submit-btn"
            style="width:100%; padding:12px; background:#ffd700; color:#111; border:none; border-radius:6px; margin-top:10px; font-weight:bold;">
            OK
        </button>
    </div>
</div>


<!-- ================================
     PLAYER BAR + MODAL JS
     ================================ -->

<script>
/* ---------- UI Open/Close Functions ---------- */
function openModal() {
    document.getElementById("authModal").style.display = "flex";
}
function closeModal() {
    document.getElementById("authModal").style.display = "none";
    document.getElementById("signupModal").style.display = "none";
}
function openSignup() {
    document.getElementById("signupModal").style.display = "flex";
}
function openResetPasswordModal() {
    document.getElementById("resetPasswordModal").style.display = "flex";
}
function closeResetPasswordModal() {
    document.getElementById("resetPasswordModal").style.display = "none";
}
function openChangeName() {
    document.getElementById("changeNameModal").style.display = "flex";
}
function closeChangeName() {
    document.getElementById("changeNameModal").style.display = "none";
}
function closeLowCoinsModal() {
    document.getElementById("lowCoinsModal").style.display = "none";
}


/* ---------- Player Bar Logic ---------- */
async function pbGetSession() {
    if (typeof supabase === "undefined") return null;
    const { data: { session } } = await supabase.auth.getSession();
    return session;
}

async function pbLoadPlayerData() {
    const nameSpan = document.getElementById("pb-player-name");
    const coinSpan = document.getElementById("pb-player-coins");
    const loginBtn = document.getElementById("pb-login-btn");
    const settingsBtn = document.querySelector(".pb-settings-btn");

    const session = await pbGetSession();

    if (!session) {
        nameSpan.textContent = "GUEST";
        coinSpan.textContent = "0";
        loginBtn.style.display = "inline-flex";
        settingsBtn.style.display = "none";
        return;
    }

    const { data } = await supabase
        .from("profiles")
        .select("player_name, gunnercoins")
        .eq("id", session.user.id)
        .single();

    if (data) {
        nameSpan.textContent = data.player_name || "PLAYER";
        coinSpan.textContent = data.gunnercoins ?? 0;
    }

    loginBtn.style.display = "none";
    settingsBtn.style.display = "inline-flex";
}

function togglePBMenu(e) {
    e.stopPropagation();
    const menu = document.getElementById("pb-settings-menu");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

document.addEventListener("click", (e) => {
    const menu = document.getElementById("pb-settings-menu");
    if (!e.target.closest("#pb-settings-menu") &&
        !e.target.closest(".pb-settings-btn")) {
        menu.style.display = "none";
    }
});

async function pbLogout() {
    await supabase.auth.signOut();
    localStorage.removeItem("supabase.auth.token");
    window.location.reload();
}


/* ============================================
   ARCADE COIN SYSTEM
   ============================================ */

/**
 * Deduct 1 GunnerCoin for playing an arcade game
 * Returns true if successful, false if not enough coins or not logged in
 */
async function deductArcadeCoin() {
    const session = await pbGetSession();
    
    // Guests cannot play arcade games - show login modal
    if (!session) {
        console.log("Guest cannot play - must login");
        openModal();
        return false;
    }

    try {
        // Get current coin balance
        const { data: profile, error: fetchError } = await supabase
            .from("profiles")
            .select("gunnercoins")
            .eq("id", session.user.id)
            .single();

        if (fetchError) throw fetchError;

        const currentCoins = profile.gunnercoins ?? 0;

        // Check if player has enough coins
        if (currentCoins < 1) {
            console.log("Not enough coins!");
            document.getElementById("lowCoinsModal").style.display = "flex";
            return false;
        }

        // Deduct 1 coin
        const { error: updateError } = await supabase
            .from("profiles")
            .update({ gunnercoins: currentCoins - 1 })
            .eq("id", session.user.id);

        if (updateError) throw updateError;

        // Update UI immediately
        document.getElementById("pb-player-coins").textContent = currentCoins - 1;
        
        console.log(`Coin deducted! ${currentCoins - 1} coins remaining`);
        return true;

    } catch (error) {
        console.error("Error deducting coin:", error);
        return false;
    }
}

/**
 * Add coins (for casino winnings, rewards, etc.)
 */
async function addGunnerCoins(amount) {
    const session = await pbGetSession();
    if (!session) return false;

    try {
        const { data: profile } = await supabase
            .from("profiles")
            .select("gunnercoins")
            .eq("id", session.user.id)
            .single();

        const newBalance = (profile.gunnercoins ?? 0) + amount;

        await supabase
            .from("profiles")
            .update({ gunnercoins: newBalance })
            .eq("id", session.user.id);

        document.getElementById("pb-player-coins").textContent = newBalance;
        return true;
    } catch (error) {
        console.error("Error adding coins:", error);
        return false;
    }
}

/**
 * Get current coin balance
 */
async function getCurrentCoins() {
    const session = await pbGetSession();
    if (!session) return 0;

    try {
        const { data } = await supabase
            .from("profiles")
            .select("gunnercoins")
            .eq("id", session.user.id)
            .single();

        return data?.gunnercoins ?? 0;
    } catch (error) {
        console.error("Error getting coins:", error);
        return 0;
    }
}


/* ---------- Initialize ---------- */
pbLoadPlayerData();
setInterval(pbLoadPlayerData, 15000);
</script>