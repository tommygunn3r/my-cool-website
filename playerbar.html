<!-- =======================
     GLOBAL PLAYER BAR
     + GLOBAL AUTH MODALS
     + MULTIPLAYER ROOM CONTROLS
     ======================= -->

<div id="player-bar-wrapper" style="
    width:100%;
    padding:12px 22px;
    background:transparent;
    border-bottom:0px solid #e94560;
    display:flex;
    justify-content:space-between;
    align-items:center;
    color:#fff;
    font-family:'Segoe UI', sans-serif;
    position:fixed;
    top:0;
    z-index:2000;
">
    <div style="display:flex; align-items:center; gap:12px;">
        <span id="pb-player-name" style="font-size:1.2rem; font-weight:bold;">
            PLAYER
        </span>
        <span style="font-size:1.2rem;">ü™ô</span>
        <span id="pb-player-coins" style="font-size:1.1rem;">
            0
        </span>
    </div>

    <!-- Music Player Controls -->
    <div id="music-controls" style="display: none; align-items: center; gap: 10px;">
        <button id="music-prev" style="
            background: #0ff;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            font-weight: bold;
        ">‚èÆ</button>
        
        <button id="music-play-pause" style="
            background: #00ff00;
            color: #000;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
        ">‚ñ∂</button>
        
        <button id="music-next" style="
            background: #0ff;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            font-weight: bold;
        ">‚è≠</button>
        
        <div style="margin-left: 15px; color: #0ff; font-size: 12px; min-width: 200px;">
            <div id="music-title" style="font-weight: bold; margin-bottom: 2px;">No song playing</div>
            <div id="music-artist" style="font-size: 10px; color: #88ddff;"></div>
        </div>
        
        <div style="width: 150px; height: 4px; background: rgba(0, 255, 255, 0.2); margin-left: 15px; border-radius: 2px; overflow: hidden;">
            <div id="music-progress" style="width: 0%; height: 100%; background: #0ff; transition: width 0.1s;"></div>
        </div>

        <!-- Volume Control -->
        <div style="display: flex; align-items: center; gap: 8px; margin-left: 15px;">
            <span style="color: #0ff; font-size: 14px;">üîä</span>
            <input type="range" id="music-volume" min="0" max="100" value="70" style="
                width: 80px;
                height: 4px;
                -webkit-appearance: none;
                appearance: none;
                background: rgba(0, 255, 255, 0.3);
                border-radius: 2px;
                outline: none;
                cursor: pointer;
            ">
        </div>
    </div>

    <style>
        #music-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #0ff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.8);
        }
        #music-volume::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #0ff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.8);
        }
        #music-volume:hover::-webkit-slider-thumb {
            box-shadow: 0 0 12px rgba(0, 255, 255, 1);
        }
        #music-volume:hover::-moz-range-thumb {
            box-shadow: 0 0 12px rgba(0, 255, 255, 1);
        }
    </style>

    <div style="display:flex; align-items:center; gap:8px;">
        <!-- Multiplayer Room Button -->
        <button id="pb-room-toggle" type="button" onclick="toggleRoomPanel()" style="
            padding: 8px 16px;
            background: linear-gradient(180deg, #4CAF50, #2d7a32);
            border: 2px solid #4CAF50;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
            display: none;
        ">
            üéÆ ROOM
        </button>

        <!-- Jukebox Button -->
        <button type="button" onclick="openJukebox()" style="
            padding: 8px 16px;
            background: linear-gradient(180deg, #ff00ff, #aa00aa);
            border: 2px solid #ff00ff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
            display: none;
        " class="pb-jukebox-btn">
            ‚ô´ JUKE BOX
        </button>

        <button id="pb-login-btn" type="button"
            style="
                padding:8px 14px;
                background:rgba(233,69,96,0.2);
                border:2px solid #e94560;
                color:white;
                border-radius:8px;
                cursor:pointer;
                font-weight:bold;
                display:none;
            "
            onclick="openModal()">
            Login
        </button>

        <button type="button" class="pb-settings-btn"
            style="
                padding:8px 16px;
                background:rgba(233,69,96,0.2);
                border:2px solid #e94560;
                color:white;
                border-radius:8px;
                cursor:pointer;
                font-weight:bold;
                display:none;
            "
            onclick="togglePBMenu(event)">
            ‚öô Settings
        </button>
    </div>

    <!-- Settings Menu -->
    <div id="pb-settings-menu" style="
        position:absolute;
        top:56px;
        right:22px;
        background:#000;
        border:1px solid #333;
        border-radius:10px;
        padding:8px 0;
        display:none;
        width:200px;
        z-index:3000;
    ">
        <div onclick="openChangeName()" style="padding:10px 16px; cursor:pointer;">Change Player Name</div>
        <div onclick="openResetPasswordModal()" style="padding:10px 16px; cursor:pointer;">Reset Password</div>
        <div onclick="pbDeleteAccount()" style="padding:10px 16px; cursor:pointer;">Delete Account</div>
        <div onclick="pbLogout()" style="padding:10px 16px; cursor:pointer;">Log Out</div>
    </div>

    <!-- Multiplayer Room Panel -->
    <div id="pb-room-panel" style="
        position: absolute;
        top: 56px;
        right: 22px;
        background: #1a1a1a;
        border: 2px solid #4CAF50;
        border-radius: 10px;
        padding: 15px;
        display: none;
        width: 320px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 3000;
        box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
    ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #4CAF50; padding-bottom: 8px;">
            <h3 style="margin: 0; color: #4CAF50; font-size: 1.1rem;">Room Info</h3>
            <button onclick="leaveMultiplayerRoom()" style="
                padding: 5px 12px;
                background: #ff4444;
                border: none;
                color: white;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: bold;
            ">Leave</button>
        </div>

        <div id="pb-room-pot" style="
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 12px;
            display: none;
        ">
            üí∞ Pot: <span id="pb-pot-amount">0</span> Coins
        </div>

        <div style="margin-bottom: 12px;">
            <div style="color: #4CAF50; font-size: 0.9rem; font-weight: bold; margin-bottom: 6px;">Players:</div>
            <div id="pb-room-players" style="display: grid; gap: 6px;"></div>
        </div>

        <div>
            <div style="color: #4CAF50; font-size: 0.9rem; font-weight: bold; margin-bottom: 6px;">Quick Chat:</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="sendRoomEmoji('üëç')" class="pb-emoji-btn">üëç</button>
                <button onclick="sendRoomEmoji('üëé')" class="pb-emoji-btn">üëé</button>
                <button onclick="sendRoomEmoji('üòÇ')" class="pb-emoji-btn">üòÇ</button>
                <button onclick="sendRoomEmoji('üòé')" class="pb-emoji-btn">üòé</button>
                <button onclick="sendRoomEmoji('üî•')" class="pb-emoji-btn">üî•</button>
                <button onclick="sendRoomEmoji('üí™')" class="pb-emoji-btn">üí™</button>
                <button onclick="sendRoomEmoji('üéÆ')" class="pb-emoji-btn">üéÆ</button>
                <button onclick="sendRoomEmoji('‚úåÔ∏è')" class="pb-emoji-btn">‚úåÔ∏è</button>
            </div>
        </div>
    </div>

    <style>
        .pb-emoji-btn {
            background: #2a2a2a;
            border: 1px solid #555;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pb-emoji-btn:hover {
            background: #4CAF50;
            transform: scale(1.1);
        }
        #pb-room-panel::-webkit-scrollbar {
            width: 8px;
        }
        #pb-room-panel::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 4px;
        }
        #pb-room-panel::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 4px;
        }
    </style>
</div>

<!-- [REST OF THE AUTH MODALS STAY THE SAME - I'll include them at the end] -->

<script>
/* ================================================
   MULTIPLAYER ROOM INTEGRATION
   ================================================ */

let pbMultiplayerRoom = {
    roomId: null,
    players: [],
    pot: 0,
    channel: null
};

// Call this function from your multiplayer games to activate the room panel
window.initMultiplayerPanel = async function(roomId) {
    pbMultiplayerRoom.roomId = roomId;
    
    // Show the room button
    document.getElementById('pb-room-toggle').style.display = 'inline-flex';
    
    // Load room data
    await loadRoomData();
    
    // Subscribe to room updates
    subscribeToRoomUpdates();
};

async function loadRoomData() {
    if (!pbMultiplayerRoom.roomId) return;
    
    try {
        // Get room info
        const { data: room } = await supabase
            .from('rooms')
            .select('buy_in')
            .eq('id', pbMultiplayerRoom.roomId)
            .single();
        
        if (room && room.buy_in > 0) {
            pbMultiplayerRoom.pot = room.buy_in;
            
            // Get player count for total pot
            const { data: players } = await supabase
                .from('room_players')
                .select('user_id, player_name')
                .eq('room_id', pbMultiplayerRoom.roomId);
            
            pbMultiplayerRoom.players = players || [];
            
            const totalPot = room.buy_in * players.length;
            document.getElementById('pb-pot-amount').textContent = totalPot;
            document.getElementById('pb-room-pot').style.display = 'block';
        } else {
            document.getElementById('pb-room-pot').style.display = 'none';
        }
        
        renderRoomPlayers();
        
    } catch (error) {
        console.error('Error loading room data:', error);
    }
}

function renderRoomPlayers() {
    const container = document.getElementById('pb-room-players');
    if (!pbMultiplayerRoom.players || pbMultiplayerRoom.players.length === 0) {
        container.innerHTML = '<div style="color: #888; text-align: center; padding: 8px;">No players</div>';
        return;
    }
    
    container.innerHTML = pbMultiplayerRoom.players.map(p => `
        <div style="
            background: #2a2a2a;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #444;
        ">
            ${p.player_name}
        </div>
    `).join('');
}

function subscribeToRoomUpdates() {
    if (pbMultiplayerRoom.channel) {
        pbMultiplayerRoom.channel.unsubscribe();
    }
    
    pbMultiplayerRoom.channel = supabase
        .channel(`playerbar-room-${pbMultiplayerRoom.roomId}`)
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'room_players', filter: `room_id=eq.${pbMultiplayerRoom.roomId}` },
            () => loadRoomData()
        )
        .subscribe();
}

function toggleRoomPanel() {
    const panel = document.getElementById('pb-room-panel');
    const menu = document.getElementById('pb-settings-menu');
    
    // Close settings menu if open
    menu.style.display = 'none';
    
    // Toggle room panel
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
}

async function leaveMultiplayerRoom() {
    if (!pbMultiplayerRoom.roomId) return;
    
    if (!confirm('Leave this room? You will be redirected to the lobby.')) return;
    
    const session = await pbGetSession();
    if (!session) return;
    
    try {
        // Remove from room
        await supabase
            .from('room_players')
            .delete()
            .eq('room_id', pbMultiplayerRoom.roomId)
            .eq('user_id', session.user.id);
        
        // Cleanup
        if (pbMultiplayerRoom.channel) {
            pbMultiplayerRoom.channel.unsubscribe();
        }
        
        // Hide room button
        document.getElementById('pb-room-toggle').style.display = 'none';
        document.getElementById('pb-room-panel').style.display = 'none';
        
        // Redirect to lobby
        window.location.href = '/multiplayer.html';
        
    } catch (error) {
        console.error('Error leaving room:', error);
        alert('Failed to leave room');
    }
}

function sendRoomEmoji(emoji) {
    // You can implement a simple notification system or just log it
    console.log('Sent emoji:', emoji);
    
    // Optional: Show a quick toast notification
    const toast = document.createElement('div');
    toast.textContent = `You sent ${emoji}`;
    toast.style.cssText = `
        position: fixed;
        top: 70px;
        right: 30px;
        background: #4CAF50;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 9999;
        animation: fadeOut 2s forwards;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 2000);
}

// Add fadeOut animation
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeOut {
        0% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0; }
    }
`;
document.head.appendChild(style);

// Close room panel when clicking outside
document.addEventListener('click', (e) => {
    const panel = document.getElementById('pb-room-panel');
    const button = document.getElementById('pb-room-toggle');
    
    if (!e.target.closest('#pb-room-panel') && !e.target.closest('#pb-room-toggle')) {
        panel.style.display = 'none';
    }
});

/* ================================================
   [ORIGINAL PLAYERBAR CODE CONTINUES BELOW]
   ================================================ */
     GLOBAL AUTH MODALS LIVE HERE NOW
     ================================ -->

<!-- LOGIN MODAL -->
<div id="authModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #e94560; position:relative;">
        <span class="close-modal" onclick="closeModal()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#e94560; margin-bottom:8px;">Login</h2>
        <p style="text-align:center; color:#888; font-size:13px; margin-bottom:20px; font-style:italic;">
            Come on, you know the drill...
        </p>

        <div class="input-group" style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:6px; color:#ddd; font-size:14px;">Email</label>
            <input id="loginEmail" class="input-field" type="email" style="
                width:100%;
                padding:10px;
                background:#222;
                border:1px solid #444;
                border-radius:6px;
                color:#fff;
                font-size:14px;
                box-sizing:border-box;
            ">
        </div>
        <div class="input-group" style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:6px; color:#ddd; font-size:14px;">Password</label>
            <input id="loginPass" class="input-field" type="password" style="
                width:100%;
                padding:10px;
                background:#222;
                border:1px solid #444;
                border-radius:6px;
                color:#fff;
                font-size:14px;
                box-sizing:border-box;
            ">
        </div>

        <div id="loginError" style="color:#ff4444; display:none; margin-bottom:10px; font-size:13px;"></div>

        <button id="btnLogin" type="button" class="submit-btn"
            style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:6px; margin-top:10px; font-weight:bold; cursor:pointer; font-size:15px;">
            LOGIN
        </button>

        <div class="switch-link" style="text-align:center; margin-top:12px;">
            <span style="color:#bbb;">No account? </span>
            <span style="color:#e94560; cursor:pointer; text-decoration:underline;" onclick="openSignup()">Create one</span>
        </div>

        <div style="text-align:center; margin-top:12px;">
            <span style="color:#e94560; cursor:pointer; text-decoration:underline;" onclick="openResetPasswordModal()">Forgot Password?</span>
        </div>
    </div>
</div>

<!-- SIGNUP MODAL -->
<div id="signupModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #e94560; position:relative;">
        <span class="close-modal" onclick="closeModal()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#e94560;">Create Account</h2>

        <div class="input-group">
            <label>Name</label>
            <input id="regName" class="input-field">
        </div>

        <div class="input-group">
            <label>Email</label>
            <input id="regEmail" class="input-field" type="email">
        </div>

        <div class="input-group">
            <label>Password</label>
            <input id="regPass" class="input-field" type="password">
        </div>

        <div id="signupError" style="color:#ff4444; display:none;"></div>

        <button id="btnSignup" type="button" class="submit-btn"
            style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:6px; margin-top:10px;">
            CREATE ACCOUNT
        </button>

        <div class="switch-link" style="text-align:center; margin-top:12px;">
            <span style="color:#bbb;">Already have an account? </span>
            <span style="color:#e94560; cursor:pointer;" onclick="openModal()">Login</span>
        </div>
    </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div id="resetPasswordModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #e94560; position:relative;">
        <span class="close-modal" onclick="closeResetPasswordModal()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#e94560;">Reset Password</h2>

        <div class="input-group">
            <label>Email</label>
            <input id="resetEmail" class="input-field" type="email">
        </div>

        <div id="resetError" style="color:#ff4444; display:none;"></div>
        <div id="resetSuccess" style="color:#44ff44; display:none;"></div>

        <button type="button" onclick="sendPasswordReset()" class="submit-btn"
            style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:6px; margin-top:10px;">
            Send Reset Email
        </button>
    </div>
</div>

<!-- CHANGE NAME MODAL -->
<div id="changeNameModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #e94560; position:relative;">
        <span class="close-modal" onclick="closeChangeName()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#e94560;">Change Name</h2>

        <div class="input-group">
            <label>New Name</label>
            <input id="newPlayerName" class="input-field">
        </div>

        <div id="nameChangeError" style="color:#ff4444; display:none;"></div>

        <button type="button" onclick="changePlayerName()" class="submit-btn"
            style="width:100%; padding:12px; background:#e94560; color:white; border:none; border-radius:6px; margin-top:10px;">
            Update Name
        </button>
    </div>
</div>

<!-- LOW COINS MODAL -->
<div id="lowCoinsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:99999; align-items:center; justify-content:center;">
    <div class="modal-content" style="background:#111; padding:28px; width:90%; max-width:380px; border-radius:12px; border:2px solid #ffd700; position:relative;">
        <span class="close-modal" onclick="closeLowCoinsModal()" style="position:absolute; top:10px; right:14px; font-size:28px; cursor:pointer;">√ó</span>

        <h2 style="text-align:center; color:#ffd700;">‚ö†Ô∏è Not Enough Coins!</h2>
        
        <p style="text-align:center; color:#fff; margin:20px 0;">
            You need <strong>1 GunnerCoin</strong> to play arcade games.<br>
            Play casino games to earn more coins!
        </p>

        <button type="button" onclick="closeLowCoinsModal()" class="submit-btn"
            style="width:100%; padding:12px; background:#ffd700; color:#111; border:none; border-radius:6px; margin-top:10px; font-weight:bold;">
            OK
        </button>
    </div>
</div>


<!-- ================================
     JUKEBOX + MUSIC PLAYER SCRIPTS
     ================================ -->
<script src="songs.js"></script>
<script src="playerbar-music.js"></script>
<script src="jukebox-modal.js"></script>


<!-- ================================
     PLAYER BAR + MODAL JS
     ================================ -->

<script>
/* ---------- UI Open/Close Functions ---------- */
function openModal() {
    document.getElementById("authModal").style.display = "flex";
}
function closeModal() {
    document.getElementById("authModal").style.display = "none";
    document.getElementById("signupModal").style.display = "none";
}
function openSignup() {
    document.getElementById("signupModal").style.display = "flex";
}
function openResetPasswordModal() {
    document.getElementById("resetPasswordModal").style.display = "flex";
}
function closeResetPasswordModal() {
    document.getElementById("resetPasswordModal").style.display = "none";
}
function openChangeName() {
    document.getElementById("changeNameModal").style.display = "flex";
}
function closeChangeName() {
    document.getElementById("changeNameModal").style.display = "none";
}
function closeLowCoinsModal() {
    document.getElementById("lowCoinsModal").style.display = "none";
}

/* ---------- Post-Login Handler ---------- */
// This function can be called by index-auth.js after successful login
window.onLoginSuccess = function() {
    closeModal();
    pbLoadPlayerData(); // Immediately update the playerbar
    if (typeof enableGames === "function") enableGames();
};

window.onSignupSuccess = function() {
    closeModal();
    pbLoadPlayerData(); // Immediately update the playerbar
    if (typeof enableGames === "function") enableGames();
};


/* ---------- Player Bar Logic ---------- */
async function pbGetSession() {
    if (typeof supabase === "undefined") return null;
    const { data: { session } } = await supabase.auth.getSession();
    return session;
}

async function pbLoadPlayerData() {
    const nameSpan = document.getElementById("pb-player-name");
    const coinSpan = document.getElementById("pb-player-coins");
    const loginBtn = document.getElementById("pb-login-btn");
    const settingsBtn = document.querySelector(".pb-settings-btn");
    const jukeboxBtn = document.querySelector(".pb-jukebox-btn");

    const session = await pbGetSession();

    if (!session) {
        nameSpan.textContent = "GUEST";
        coinSpan.textContent = "0";
        loginBtn.style.display = "inline-flex";
        settingsBtn.style.display = "none";
        if (jukeboxBtn) jukeboxBtn.style.display = "none";
        return;
    }

    const { data } = await supabase
        .from("profiles")
        .select("player_name, gunnercoins")
        .eq("id", session.user.id)
        .single();

    if (data) {
        nameSpan.textContent = data.player_name || "PLAYER";
        coinSpan.textContent = data.gunnercoins ?? 0;
    }

    loginBtn.style.display = "none";
    settingsBtn.style.display = "inline-flex";
    if (jukeboxBtn) jukeboxBtn.style.display = "inline-flex";
}

function togglePBMenu(e) {
    e.stopPropagation();
    const menu = document.getElementById("pb-settings-menu");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

document.addEventListener("click", (e) => {
    const menu = document.getElementById("pb-settings-menu");
    if (!e.target.closest("#pb-settings-menu") &&
        !e.target.closest(".pb-settings-btn")) {
        menu.style.display = "none";
    }
});

async function pbLogout() {
    await supabase.auth.signOut();
    localStorage.removeItem("supabase.auth.token");
    window.location.reload();
}


/* ============================================
   ARCADE COIN SYSTEM
   ============================================ */

/**
 * Deduct 1 GunnerCoin for playing an arcade game
 * Returns true if successful, false if not enough coins or not logged in
 */
async function deductArcadeCoin() {
    const session = await pbGetSession();
    
    // Guests cannot play arcade games - show login modal
    if (!session) {
        console.log("Guest cannot play - must login");
        openModal();
        return false;
    }

    try {
        // Get current coin balance
        const { data: profile, error: fetchError } = await supabase
            .from("profiles")
            .select("gunnercoins")
            .eq("id", session.user.id)
            .single();

        if (fetchError) throw fetchError;

        const currentCoins = profile.gunnercoins ?? 0;

        // Check if player has enough coins
        if (currentCoins < 1) {
            console.log("Not enough coins!");
            document.getElementById("lowCoinsModal").style.display = "flex";
            return false;
        }

        // Deduct 1 coin
        const { error: updateError } = await supabase
            .from("profiles")
            .update({ gunnercoins: currentCoins - 1 })
            .eq("id", session.user.id);

        if (updateError) throw updateError;

        // Update UI immediately
        document.getElementById("pb-player-coins").textContent = currentCoins - 1;
        
        console.log(`Coin deducted! ${currentCoins - 1} coins remaining`);
        return true;

    } catch (error) {
        console.error("Error deducting coin:", error);
        return false;
    }
}

/**
 * Add coins (for casino winnings, rewards, etc.)
 */
async function addGunnerCoins(amount) {
    const session = await pbGetSession();
    if (!session) return false;

    try {
        const { data: profile } = await supabase
            .from("profiles")
            .select("gunnercoins")
            .eq("id", session.user.id)
            .single();

        const newBalance = (profile.gunnercoins ?? 0) + amount;

        await supabase
            .from("profiles")
            .update({ gunnercoins: newBalance })
            .eq("id", session.user.id);

        document.getElementById("pb-player-coins").textContent = newBalance;
        return true;
    } catch (error) {
        console.error("Error adding coins:", error);
        return false;
    }
}

/**
 * Get current coin balance
 */
async function getCurrentCoins() {
    const session = await pbGetSession();
    if (!session) return 0;

    try {
        const { data } = await supabase
            .from("profiles")
            .select("gunnercoins")
            .eq("id", session.user.id)
            .single();

        return data?.gunnercoins ?? 0;
    } catch (error) {
        console.error("Error getting coins:", error);
        return 0;
    }
}


/* ---------- Initialize ---------- */
pbLoadPlayerData();
setInterval(pbLoadPlayerData, 15000);

/* ---------- Auth State Listener ---------- */
if (typeof supabase !== "undefined") {
    supabase.auth.onAuthStateChange((event, session) => {
        console.log("Auth state changed:", event);
        
        if (event === 'SIGNED_IN' || event === 'SIGNED_OUT' || event === 'TOKEN_REFRESHED') {
            // Reload playerbar data immediately when auth state changes
            pbLoadPlayerData();
            
            // Also enable/disable games based on auth state
            if (session?.user) {
                window.currentUser = session.user;
                if (typeof enableGames === "function") enableGames();
            } else {
                window.currentUser = null;
                if (typeof disableGames === "function") disableGames();
            }
        }
    });
}
</script>