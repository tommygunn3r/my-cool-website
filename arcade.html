<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arcade Games - Gunner's Games</title>
<!-- (ALL STYLES UNCHANGED â€” omitted here for brevity, you keep your full original) -->
</head>
<body>

<!-- GLOBAL PLAYER BAR -->
<div id="playerbar"></div>

<script type="module">
    import { supabase as client } from "/assets/js/supabaseClient.js";
    window.supabase = client;
</script>

<!-- YOUR FULL PAGE CONTENT / PARALLAX / CAROUSEL (unchanged) -->

<script>
/* --- SAME game list, carousel, overlay code --- */

/* ðŸ”¥ FIXED getUser(): Supabase v2 compatible */
async function getUser() {
    if (typeof supabase === "undefined") return null;
    const { data: { session } } = await supabase.auth.getSession();
    return session?.user ?? null;
}

/* ðŸ”¥ FIXED chargeOneCoin(): now uses session.user correctly */
async function chargeOneCoin() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
        alert("You must be logged in to play.");
        return false;
    }

    const user = session.user;

    const { data, error } = await supabase
        .from("profiles")
        .select("gunnercoins")
        .eq("id", user.id)
        .single();

    if (error) {
        console.error(error);
        alert("Coin check failed.");
        return false;
    }

    if (!data || data.gunnercoins == null || data.gunnercoins <= 0) {
        alert("You do not have enough Gunnercoins!");
        return false;
    }

    const newBalance = data.gunnercoins - 1;

    const { error: updateErr } = await supabase
        .from("profiles")
        .update({ gunnercoins: newBalance })
        .eq("id", user.id);

    if (updateErr) {
        console.error(updateErr);
        alert("Failed to deduct coin.");
        return false;
    }

    const coinSpan = document.getElementById("pb-player-coins");
    if (coinSpan) coinSpan.textContent = newBalance;

    return true;
}

/* unchanged launchGame(), closeGame(), carousel movement, etc */
async function launchGame(index) {
    const ok = await chargeOneCoin();
    if (!ok) return;

    const game = games[index];
    gameFrame.src = `games/arcade/${game.file}`;
    gameOverlay.classList.add('active');
}

</script>

<!-- Load global player bar -->
<script>
async function loadPlayerBar(){
    try {
        const res = await fetch("playerbar.html");
        const html = await res.text();
        const container = document.getElementById("playerbar");
        const temp = document.createElement("div");
        temp.innerHTML = html;
        Array.from(temp.childNodes).forEach(node => {
            if (node.tagName === "SCRIPT") {
                const s = document.createElement("script");
                if (node.src) s.src = node.src;
                else s.textContent = node.textContent;
                document.body.appendChild(s);
            } else {
                container.appendChild(node);
            }
        });
    } catch (e) { console.error(e); }
}
document.addEventListener("DOMContentLoaded", loadPlayerBar);
</script>

</body>
</html>
