<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arcade Games - Gunner's Games</title>

<link rel="stylesheet" href="assets/css/arcade.css">
</head>

<body>

<!-- GLOBAL PLAYER BAR (contains ALL modals, all auth UI) -->
<div id="playerbar"></div>

<!-- PARALLAX HERO / HEADER IMAGE -->
<div class="parallax"></div>

<!-- ================================
     ARCADE GAME SELECTION
     ================================ -->

<h1 class="section-title">Arcade</h1>

<div class="carousel-container">
    <button class="carousel-btn left" onclick="moveCarousel(-1)">&#10094;</button>

    <div class="carousel-wrapper">
        <div id="carousel" class="carousel">
            <!-- Filled dynamically -->
        </div>
    </div>

    <button class="carousel-btn right" onclick="moveCarousel(1)">&#10095;</button>
</div>

<!-- GAME PLAYER OVERLAY -->
<div id="gameOverlay" class="overlay">
    <div class="overlay-header">
        <button class="close-btn" onclick="closeGame()">Close Game</button>
    </div>
    <iframe id="gameFrame" src="" class="game-frame"></iframe>
</div>


<!-- ================================
     SCRIPTS
     ================================ -->

<!-- REQUIRED: Attach Supabase client to window -->
<script type="module">
    import { supabase as client } from "/assets/js/supabaseClient.js";
    window.supabase = client;
</script>


<script>
// ===============================
// GAME LIST
// ===============================
const games = [
    { name: "Square Man", file: "square-man.html", img: "previews/arcade-square-man.png" },
    { name: "Squario", file: "squario.html", img: "previews/arcade-squario.png" },
    { name: "Squartri", file: "squartri.html", img: "previews/arcade-squartri.png" },
    { name: "Shooter", file: "shooter.html", img: "previews/arcade-shooter.png" },
    { name: "Water Flow", file: "water.html", img: "previews/arcade-water.png" },
    { name: "Word Slider", file: "word_slider.html", img: "previews/arcade-word_slider.png" },
    { name: "Word Rush", file: "wordrush.html", img: "previews/arcade-wordrush.png" },
    { name: "Square Bird", file: "square-bird.html", img: "previews/arcade-square-bird.png" }
];


// ===============================
// BUILD CAROUSEL
// ===============================
function buildCarousel() {
    const c = document.getElementById("carousel");
    c.innerHTML = "";

    games.forEach((g, i) => {
        const d = document.createElement("div");
        d.className = "carousel-item";
        d.innerHTML = `
            <img src="/${g.img}" alt="${g.name}">
            <p>${g.name}</p>
        `;
        d.onclick = () => launchGame(i);
        c.appendChild(d);
    });
}

// ===============================
// CAROUSEL MOVEMENT
// ===============================
let carouselIndex = 0;
function moveCarousel(direction) {
    const items = document.querySelectorAll(".carousel-item");
    carouselIndex += direction;

    if (carouselIndex < 0) carouselIndex = items.length - 1;
    if (carouselIndex >= items.length) carouselIndex = 0;

    const wrapper = document.querySelector(".carousel");
    wrapper.style.transform = `translateX(-${carouselIndex * 220}px)`;
}


// ===============================
// AUTH HELPERS
// ===============================
async function getCurrentUser() {
    if (!window.supabase) return null;
    const { data:{ session } } = await supabase.auth.getSession();
    return session?.user ?? null;
}

// ===============================
// COIN DEDUCTION (1 coin to play)
// ===============================
async function chargeOneCoin() {
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session?.user) {
        openModal(); // open login modal
        return false;
    }

    const user = session.user;

    const { data, error } = await supabase
        .from("profiles")
        .select("gunnercoins")
        .eq("id", user.id)
        .single();

    if (error || !data) {
        alert("Unable to check coins.");
        return false;
    }

    if (data.gunnercoins <= 0) {
        alert("You do not have enough Gunnercoins!");
        return false;
    }

    const newBalance = data.gunnercoins - 1;

    const { error:updateErr } = await supabase
        .from("profiles")
        .update({ gunnercoins: newBalance })
        .eq("id", user.id);

    if (updateErr) {
        alert("Failed to deduct coin.");
        return false;
    }

    // Update playerbar live if loaded
    const coinSpan = document.getElementById("pb-player-coins");
    if (coinSpan) coinSpan.textContent = newBalance;

    return true;
}


// ===============================
// LAUNCH GAME
// ===============================
async function launchGame(index) {
    const ok = await chargeOneCoin();
    if (!ok) return;

    const game = games[index];

    document.getElementById("gameFrame").src = `/games/arcade/${game.file}`;
    document.getElementById("gameOverlay").classList.add("active");
}

function closeGame() {
    document.getElementById("gameOverlay").classList.remove("active");
    document.getElementById("gameFrame").src = "";
}


// ===============================
// INIT
// ===============================
document.addEventListener("DOMContentLoaded", () => {
    buildCarousel();
});
</script>


<!-- ===============================
     LOAD GLOBAL PLAYER BAR (modals included)
     =============================== -->
<script>
async function loadPlayerBar(){
    try {
        const res = await fetch("playerbar.html");
        const html = await res.text();
        const container = document.getElementById("playerbar");
        const temp = document.createElement("div");
        temp.innerHTML = html;

        Array.from(temp.childNodes).forEach(node => {
            if (node.tagName === "SCRIPT") {
                const s = document.createElement("script");
                if (node.src) s.src = node.src;
                else s.textContent = node.textContent;
                document.body.appendChild(s);
            } else {
                container.appendChild(node);
            }
        });
    } catch (e) { console.error(e); }
}

document.addEventListener("DOMContentLoaded", loadPlayerBar);
</script>

</body>
</html>
