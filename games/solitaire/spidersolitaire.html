<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mom's Spider Solitaire</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Visuals --- */
        :root {
            --gold: #d4af37;
            --gold-dark: #b8941f;
            --gold-light: #f4e5a7;
            --dark: #1a1410;
        }

        body {
            /* Default Fallback Color */
            background-color: #1a472a; 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
            
            overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Cormorant Garamond', serif;
            touch-action: none; 
        }

        /* Card styling */
        .card {
            width: 100%;
            aspect-ratio: 2.5/3.5;
            background-color: white;
            border-radius: 0.4rem;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.4);
            position: absolute;
            transition: transform 0.1s; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0.3rem; 
            cursor: grab;
            backface-visibility: hidden;
            z-index: 10;
            /* MATCHING BLACKJACK FONT */
            font-family: 'Cinzel', serif; 
            font-weight: 700;
        }
        
        .card:active { cursor: grabbing; }

        @media (min-width: 640px) {
            .card {
                border-radius: 0.5rem;
                padding: 0.4rem;
                box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            }
        }

        .card-face-down {
            background-image: url('/games/assets/solitaire/card_back.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            border: 1px solid #ddd;
            cursor: default;
        }
        
        .card-face-down > * { display: none !important; }

        .card.selected {
            transform: translateY(-10px);
            box-shadow: 0 0 0 3px var(--gold), 0 10px 15px -3px rgba(0, 0, 0, 0.5); /* Gold selection highlight */
            z-index: 50 !important;
        }
        
        .card.dragging {
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            z-index: 9999 !important;
            pointer-events: none; 
        }
        
        .card.snapping { transition: top 0.2s ease-out, left 0.2s ease-out; }
        .card.hint-anim { animation: wiggle 0.5s ease-in-out; z-index: 60 !important; }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        /* Suit Colors - Matching Blackjack exactly */
        .suit-red { color: #dc143c; } /* Crimson from Blackjack */
        .suit-black { color: #000000; }

        /* Layout Grid */
        .game-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 0.4rem;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0.5rem;
        }
        @media (min-width: 768px) { .game-board { gap: 0.75rem; } }

        .column { position: relative; min-height: 60vh; }
        
        .column.drag-hover {
            background-color: rgba(212, 175, 55, 0.2); /* Gold tint on hover */
            border-radius: 0.5rem;
            box-shadow: inset 0 0 20px rgba(212, 175, 55, 0.3);
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.5rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 100%);
            border-bottom: 2px solid var(--gold);
            color: var(--gold);
            font-family: 'Cinzel', serif;
        }

        /* Buttons */
        .game-btn {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark);
            border: none;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(212, 175, 55, 0.3);
            transition: all 0.2s;
        }
        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.5);
        }
        
        /* Modal */
        .modal { background-color: rgba(0, 0, 0, 0.85); }
        .modal-content {
            background: linear-gradient(135deg, #2a1f1a 0%, var(--dark) 100%);
            border: 3px solid var(--gold);
            color: #f5f3e8;
        }

        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100; }
        #drag-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9000; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden font-sans text-gray-900">

    <canvas id="confetti-canvas"></canvas>
    
    <div id="drag-layer"></div>

    <div class="top-bar shrink-0 z-20">
        <div class="flex gap-2">
            <button onclick="toggleMenu()" class="game-btn px-3 py-2 sm:px-4 sm:py-2 rounded text-sm sm:text-base">
                MENU
            </button>
            <button onclick="undoMove()" id="undoBtn" class="bg-gray-700 text-white border border-gray-600 px-3 py-2 sm:px-4 sm:py-2 rounded font-bold hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base font-cinzel">
                UNDO
            </button>
        </div>
        
        <div class="flex flex-col items-center">
            <div class="text-xl sm:text-2xl font-bold text-gold drop-shadow-md" style="color: var(--gold);" id="scoreDisplay">Score: 500</div>
            <div class="text-xs sm:text-sm font-medium text-yellow-200" id="highScoreDisplay">Best: 0</div>
        </div>

        <div class="flex gap-2 items-center">
             <button onclick="showHint()" class="bg-blue-800 text-white border border-blue-600 px-3 py-2 sm:px-4 sm:py-2 rounded font-bold hover:bg-blue-700 text-sm sm:text-base font-cinzel">
                HINT
            </button>
            <div class="relative w-16 h-20 sm:w-20 sm:h-28">
                <div id="stock-pile" onclick="dealStock()" class="card card-face-down absolute top-0 left-0 cursor-pointer hover:brightness-110 flex items-center justify-center">
                   <div class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-60 rounded">
                       <span class="text-white font-black text-lg sm:text-xl tracking-wider drop-shadow-md" style="font-family: 'Cinzel', serif; color: var(--gold);">DEAL</span>
                       <div class="mt-1 bg-black border border-gold text-gold font-bold text-xs px-2 py-0.5 rounded-full shadow-sm" style="border-color: var(--gold); color: var(--gold);">
                           <span id="stock-count">5</span>
                       </div>
                   </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 relative w-full overflow-hidden">
        <div class="game-board h-full pt-2" id="tableau">
            </div>

        <div id="foundations" class="absolute bottom-2 right-2 z-0 flex gap-1 opacity-90 pointer-events-none transform scale-75 origin-bottom-right">
        </div>
    </div>

    <div id="winModal" class="modal fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="modal-content p-8 rounded-xl shadow-2xl text-center max-w-md mx-4">
            <h2 class="text-4xl font-bold mb-4" style="color: var(--gold); font-family: 'Cinzel', serif;">YOU WON!</h2>
            <p class="text-lg mb-6" style="color: #f5f3e8;">Final Score: <span id="finalScoreDisplay" class="font-bold text-gold" style="color: var(--gold);">0</span></p>
            <button onclick="startNewGame()" class="game-btn px-8 py-3 rounded-full text-xl shadow-lg hover:scale-105 transition">
                PLAY AGAIN
            </button>
        </div>
    </div>

    <div id="menuModal" class="modal fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="modal-content p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <div class="flex justify-between items-center mb-6 border-b border-gray-600 pb-2">
                <h2 class="text-2xl font-bold" style="color: var(--gold); font-family: 'Cinzel', serif;">SETTINGS</h2>
                <button onclick="toggleMenu()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            
            <div class="space-y-4 font-cormorant">
                <div>
                    <label class="block font-bold mb-2 text-gold" style="color: var(--gold);">Difficulty:</label>
                    <select id="difficultySelect" class="w-full p-3 border border-gray-600 rounded-lg bg-black text-white text-lg font-medium focus:border-gold outline-none">
                        <option value="1">Easy (1 Suit) - Spades</option>
                        <option value="2">Medium (2 Suits)</option>
                        <option value="4">Hard (4 Suits)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block font-bold mb-2 text-gold" style="color: var(--gold);">Table Top:</label>
                    <select id="themeSelect" class="w-full p-3 border border-gray-600 rounded-lg bg-black text-white text-lg font-medium focus:border-gold outline-none">
                        <option value="green">Classic Green</option>
                        <option value="red">Royal Red</option>
                        <option value="blue">Midnight Blue</option>
                    </select>
                </div>

                <button onclick="confirmNewGame()" class="game-btn w-full py-3 rounded-full font-bold text-lg shadow mt-4">SAVE & NEW GAME</button>
                <button onclick="saveAndResume()" class="w-full bg-gray-800 text-gray-300 border border-gray-600 py-3 rounded-full font-bold mt-2 hover:bg-gray-700 transition">RESUME GAME</button>
            </div>
        </div>
    </div>

    <div id="messageToast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-90 text-gold border border-gold px-6 py-4 rounded-lg pointer-events-none opacity-0 transition-opacity duration-300 z-50 text-center font-bold text-xl shadow-xl font-cinzel" style="color: var(--gold); border-color: var(--gold);">Message</div>

    <script>

        // --- Score Manager (Local Only) ---
        class GameScoreManager {
            constructor(gameName) {
                this.gameName = gameName;
                this.sessionStartTime = null;
            }

            startSession() {
                this.sessionStartTime = Date.now();
            }

            getElapsedTime() {
                if (!this.sessionStartTime) return 0;
                return Math.floor((Date.now() - this.sessionStartTime) / 1000);
            }

            getElapsedTimeFormatted() {
                const seconds = this.getElapsedTime();
                if (seconds < 60) return `0:${seconds.toString().padStart(2, '0')}`;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // --- Assets & Constants ---
        // Using TEXT characters instead of SVGs to match Blackjack exactly
        const ICONS = { spades: '♠', hearts: '♥', clubs: '♣', diamonds: '♦' };
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const VALUES = { 'A': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13 };
        
        const THEMES = {
            green: '/games/assets/solitaire/greentop.png',
            red: '/games/assets/solitaire/redtop.png',
            blue: '/games/assets/solitaire/bluetop.png'
        };

        let state = {
            tableau: [[], [], [], [], [], [], [], [], [], []],
            stock: [], foundations: 0, history: [], score: 500, highScore: 0, 
            difficulty: 1, selectedCard: null,
            theme: 'green' // Default theme
        };

        let drag = {
            active: false,
            startX: 0, startY: 0,
            colIndex: null, cardIndex: null,
            elStack: [], 
            originalRects: [], 
            offsetX: 0, offsetY: 0,
            hasMoved: false
        };

        function init() {
            const savedDiff = localStorage.getItem('spider_difficulty');
            if (savedDiff) state.difficulty = parseInt(savedDiff);
            document.getElementById('difficultySelect').value = state.difficulty;
            
            const savedTheme = localStorage.getItem('spider_theme');
            if (savedTheme && THEMES[savedTheme]) state.theme = savedTheme;
            document.getElementById('themeSelect').value = state.theme;
            applyTheme();

            const savedHighScore = localStorage.getItem('spider_highscore');
            if (savedHighScore) state.highScore = parseInt(savedHighScore);
            updateHighScoreDisplay();

            startNewGame();
            window.addEventListener('resize', renderBoard);
            
            document.addEventListener('mousemove', handleGlobalMove);
            document.addEventListener('mouseup', handleGlobalEnd);
            document.addEventListener('touchmove', handleGlobalMove, {passive: false});
            document.addEventListener('touchend', handleGlobalEnd, {passive: false});
        }

        function startNewGame() {
            document.getElementById('winModal').classList.add('hidden');
            stopConfetti();
            document.getElementById('foundations').innerHTML = '';
            state.score = 500;
            state.history = [];
            state.foundations = 0;
            state.selectedCard = null;
            updateUndoButton();
            scoreManager.startSession();
            createDeck();
            dealInitial();
            renderBoard();
            updateScore();
        }

        function createDeck() {
            let deck = [];
            let suitsToUse = state.difficulty === 1 ? ['spades'] : state.difficulty === 2 ? ['spades', 'hearts'] : ['spades', 'hearts', 'clubs', 'diamonds'];
            const setsPerSuit = 8 / suitsToUse.length;
            for (let s of suitsToUse) {
                for (let i = 0; i < setsPerSuit; i++) {
                    for (let r of RANKS) {
                        deck.push({ rank: r, suit: s, value: VALUES[r], faceUp: false, id: Math.random().toString(36).substr(2, 9) });
                    }
                }
            }
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            state.stock = deck;
        }

        function dealInitial() {
            state.tableau = [[], [], [], [], [], [], [], [], [], []];
            for (let i = 0; i < 54; i++) {
                const col = i % 10;
                const card = state.stock.pop();
                const isLastForCol = (col < 4 && state.tableau[col].length === 5) || (col >= 4 && state.tableau[col].length === 4);
                card.faceUp = isLastForCol;
                state.tableau[col].push(card);
            }
        }

        function saveState() {
            const snapshot = {
                tableau: JSON.parse(JSON.stringify(state.tableau)),
                stock: JSON.parse(JSON.stringify(state.stock)),
                score: state.score,
                foundations: state.foundations
            };
            state.history.push(snapshot);
            if (state.history.length > 20) state.history.shift();
            updateUndoButton();
        }

        function undoMove() {
            if (state.history.length === 0) return;
            const prev = state.history.pop();
            state.tableau = prev.tableau;
            state.stock = prev.stock;
            state.score = prev.score;
            state.foundations = prev.foundations;
            state.selectedCard = null;
            const fContainer = document.getElementById('foundations');
            fContainer.innerHTML = '';
            for(let i=0; i<state.foundations; i++) addFoundationGraphic('spades');
            renderBoard();
            updateUndoButton();
            updateScore();
        }

        function isMoveValid(card, targetColIndex) {
            const targetCol = state.tableau[targetColIndex];
            if (targetCol.length === 0) return true;
            const topCard = targetCol[targetCol.length - 1];
            return topCard.value === card.value + 1;
        }

        function canMoveStack(colIndex, cardIndex) {
            const col = state.tableau[colIndex];
            const card = col[cardIndex];
            if (!card.faceUp) return false;
            for (let i = cardIndex; i < col.length - 1; i++) {
                const current = col[i];
                const next = col[i+1];
                if (current.suit !== next.suit || current.value !== next.value + 1) return false;
            }
            return true;
        }

        function attemptMove(fromColIdx, fromCardIdx, toColIdx) {
            if (fromColIdx === toColIdx) return false;
            const movingStack = state.tableau[fromColIdx].slice(fromCardIdx);
            const leadCard = movingStack[0];
            
            if (isMoveValid(leadCard, toColIdx)) {
                saveState();
                state.tableau[fromColIdx].splice(fromCardIdx);
                state.tableau[toColIdx].push(...movingStack);
                if (state.tableau[fromColIdx].length > 0) {
                    const newTop = state.tableau[fromColIdx][state.tableau[fromColIdx].length - 1];
                    if (!newTop.faceUp) { newTop.faceUp = true; state.score += 10; }
                }
                state.score -= 1;
                state.selectedCard = null;
                checkCompletedRun(toColIdx);
                renderBoard();
                updateScore();
                return true;
            }
            return false;
        }

        // --- Drag Input Handling ---
        
        function handleInputStart(e, colIndex, cardIndex) {
            if (e.type === 'mousedown' && e.button !== 0) return;
            const card = state.tableau[colIndex][cardIndex];
            if (!card.faceUp) return;
            const pos = getEventPos(e);
            
            drag.active = false;
            drag.hasMoved = false;
            drag.startX = pos.x;
            drag.startY = pos.y;
            drag.colIndex = colIndex;
            drag.cardIndex = cardIndex;
            
            if (!canMoveStack(colIndex, cardIndex)) drag.colIndex = null;
        }

        function handleGlobalMove(e) {
            if (drag.colIndex === null) return;
            const pos = getEventPos(e);
            const dx = pos.x - drag.startX;
            const dy = pos.y - drag.startY;

            if (!drag.active && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
                drag.active = true;
                drag.hasMoved = true;
                startDragVisuals(pos);
            }

            if (drag.active) {
                e.preventDefault(); 
                updateDragVisuals(dx, dy);
                highlightDropZone(pos.x, pos.y);
            }
        }

        function handleGlobalEnd(e) {
            if (drag.colIndex === null) return;

            if (drag.active) {
                const pos = getEventPos(e);
                const targetCol = getTargetColumn(pos.x, pos.y);
                
                let success = false;
                if (targetCol !== null) {
                    success = attemptMove(drag.colIndex, drag.cardIndex, targetCol);
                }

                if (!success) snapBackVisuals();
                else resetDragState();
            } else {
                if (!drag.hasMoved) handleCardClick(drag.colIndex, drag.cardIndex);
                resetDragState();
            }
        }

        function startDragVisuals(pos) {
            const dragLayer = document.getElementById('drag-layer');
            const col = document.getElementById('tableau').children[drag.colIndex];
            drag.elStack = [];
            drag.originalRects = [];

            for (let i = drag.cardIndex; i < state.tableau[drag.colIndex].length; i++) {
                const cardEl = col.children[i];
                const rect = cardEl.getBoundingClientRect();
                drag.originalRects.push({left: rect.left, top: rect.top});
                
                cardEl.style.position = 'fixed';
                cardEl.style.left = rect.left + 'px';
                cardEl.style.top = rect.top + 'px';
                cardEl.style.width = rect.width + 'px';
                cardEl.style.zIndex = 9000 + i;
                cardEl.classList.add('dragging');
                
                dragLayer.appendChild(cardEl);
                drag.elStack.push(cardEl);
            }
            const topRect = drag.originalRects[0];
            drag.offsetX = pos.x - topRect.left;
            drag.offsetY = pos.y - topRect.top;
        }

        function updateDragVisuals(dx, dy) {
            drag.elStack.forEach((el, index) => {
                const original = drag.originalRects[index];
                el.style.left = (original.left + dx) + 'px';
                el.style.top = (original.top + dy) + 'px';
            });
        }

        function getTargetColumn(x, y) {
            drag.elStack.forEach(el => el.style.display = 'none');
            const elBelow = document.elementFromPoint(x, y);
            drag.elStack.forEach(el => el.style.display = '');
            if (!elBelow) return null;
            
            const colEl = elBelow.closest('.column');
            if (colEl) return parseInt(colEl.dataset.col);
            const cardEl = elBelow.closest('.card');
            if (cardEl && cardEl.parentElement.classList.contains('column')) {
                return parseInt(cardEl.parentElement.dataset.col);
            }
            return null;
        }

        function highlightDropZone(x, y) {
            document.querySelectorAll('.column.drag-hover').forEach(el => el.classList.remove('drag-hover'));
            const targetColIdx = getTargetColumn(x, y);
            if (targetColIdx !== null && targetColIdx !== drag.colIndex) {
                const col = document.getElementById('tableau').children[targetColIdx];
                const leadCard = state.tableau[drag.colIndex][drag.cardIndex];
                if (isMoveValid(leadCard, targetColIdx)) col.classList.add('drag-hover');
            }
        }

        function snapBackVisuals() {
            let completeCount = 0;
            drag.elStack.forEach((el, index) => {
                const target = drag.originalRects[index];
                el.classList.add('snapping');
                el.style.left = target.left + 'px';
                el.style.top = target.top + 'px';
                setTimeout(() => {
                    completeCount++;
                    if (completeCount === drag.elStack.length) {
                        resetDragState();
                        renderBoard(); 
                    }
                }, 200);
            });
        }

        function resetDragState() {
            drag.active = false;
            drag.colIndex = null;
            drag.cardIndex = null;
            drag.hasMoved = false;
            document.getElementById('drag-layer').innerHTML = '';
            document.querySelectorAll('.column.drag-hover').forEach(el => el.classList.remove('drag-hover'));
        }

        function getEventPos(e) {
            if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            else if (e.changedTouches && e.changedTouches.length > 0) return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        }

        function handleCardClick(colIndex, cardIndex) {
            const col = state.tableau[colIndex];
            const card = col[cardIndex];
            if (!card.faceUp) return;

            if (state.selectedCard && state.selectedCard.colIndex === colIndex && state.selectedCard.cardIndex === cardIndex) {
                state.selectedCard = null;
                renderBoard();
                return;
            }

            if (state.selectedCard) {
                attemptMove(state.selectedCard.colIndex, state.selectedCard.cardIndex, colIndex);
            } else {
                if (canMoveStack(colIndex, cardIndex)) {
                    state.selectedCard = { colIndex, cardIndex };
                    renderBoard();
                } else {
                    showMessage("Cards must match suit to move together");
                }
            }
        }

        function handleEmptyColumnClick(colIndex) {
            if (state.selectedCard) {
                attemptMove(state.selectedCard.colIndex, state.selectedCard.cardIndex, colIndex);
            }
        }

        function checkCompletedRun(colIdx) {
            const col = state.tableau[colIdx];
            if (col.length < 13) return;
            const last13 = col.slice(col.length - 13);
            if (last13[0].value !== 13) return; 
            let isRun = true;
            const suit = last13[0].suit;
            for (let i = 0; i < 13; i++) {
                if (last13[i].suit !== suit || last13[i].value !== 13 - i) { isRun = false; break; }
            }
            if (isRun) {
                col.splice(col.length - 13, 13);
                state.foundations++;
                state.score += 100;
                addFoundationGraphic(suit);
                if (col.length > 0) {
                    const newTop = col[col.length - 1];
                    newTop.faceUp = true;
                }
                if (state.foundations === 8) {
                    if (state.score > state.highScore) {
                        state.highScore = state.score;
                        localStorage.setItem('spider_highscore', state.highScore);
                        updateHighScoreDisplay();
                    }
                    
                    setTimeout(() => {
                        document.getElementById('finalScoreDisplay').innerText = `Final Score: ${state.score}`;
                        document.getElementById('winModal').classList.remove('hidden');
                        startConfetti();
                    }, 500);
                }
            }
        }

        function dealStock() {
            if (state.stock.length === 0) return;
            const hasEmpty = state.tableau.some(col => col.length === 0);
            if (hasEmpty) { showMessage("Cannot deal with empty columns"); return; }
            saveState();
            for (let i = 0; i < 10; i++) {
                if (state.stock.length > 0) {
                    const card = state.stock.pop();
                    card.faceUp = true;
                    state.tableau[i].push(card);
                    checkCompletedRun(i);
                }
            }
            renderBoard();
        }

        function renderBoard() {
            const tableauEl = document.getElementById('tableau');
            tableauEl.innerHTML = '';
            document.getElementById('stock-count').textContent = Math.floor(state.stock.length / 10);
            const stockEl = document.getElementById('stock-pile');
            if (state.stock.length === 0) stockEl.classList.add('opacity-0', 'pointer-events-none');
            else stockEl.classList.remove('opacity-0', 'pointer-events-none');

            state.tableau.forEach((col, colIndex) => {
                const colEl = document.createElement('div');
                colEl.className = 'column';
                colEl.dataset.col = colIndex; 
                colEl.onclick = (e) => { if(e.target === colEl) handleEmptyColumnClick(colIndex); };

                let overlap = 30;
                if (window.innerWidth < 640) overlap = 25;
                if (col.length > 15) overlap = 20;

                col.forEach((card, cardIndex) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = `card ${card.faceUp ? '' : 'card-face-down'} ${getSuitColor(card.suit)}`;
                    cardEl.style.top = `${cardIndex * overlap}px`;
                    cardEl.style.zIndex = cardIndex;

                    if (state.selectedCard && state.selectedCard.colIndex === colIndex && state.selectedCard.cardIndex === cardIndex) {
                        cardEl.classList.add('selected');
                    }

                    if (card.faceUp) {
                        const topDiv = document.createElement('div');
                        topDiv.className = 'flex flex-col items-center leading-none select-none';
                        topDiv.innerHTML = `<span class="text-xl font-bold">${card.rank}</span>`;
                        
                        const centerDiv = document.createElement('div');
                        centerDiv.className = 'absolute inset-0 flex items-center justify-center pointer-events-none';
                        centerDiv.innerHTML = `<span class="text-6xl">${ICONS[card.suit]}</span>`;
                        
                        const botDiv = document.createElement('div');
                        botDiv.className = 'flex flex-col items-center leading-none select-none transform rotate-180';
                        botDiv.innerHTML = `<span class="text-xl font-bold">${card.rank}</span>`;
                        
                        cardEl.appendChild(topDiv); cardEl.appendChild(centerDiv); cardEl.appendChild(botDiv);
                    }

                    cardEl.addEventListener('mousedown', (e) => handleInputStart(e, colIndex, cardIndex));
                    cardEl.addEventListener('touchstart', (e) => handleInputStart(e, colIndex, cardIndex), {passive: false});

                    colEl.appendChild(cardEl);
                });
                tableauEl.appendChild(colEl);
            });
        }

        // --- Utils & UI ---
        function getSuitColor(suit) { return (suit === 'hearts' || suit === 'diamonds') ? 'suit-red' : 'suit-black'; }
        function updateScore() { document.getElementById('scoreDisplay').innerText = `Score: ${state.score}`; }
        function updateHighScoreDisplay() { document.getElementById('highScoreDisplay').textContent = `Best: ${state.highScore}`; }
        function updateUndoButton() { document.getElementById('undoBtn').disabled = state.history.length === 0; }
        function showMessage(msg) {
            const el = document.getElementById('messageToast');
            el.innerText = msg; el.style.opacity = '1';
            setTimeout(() => { el.style.opacity = '0'; }, 2000);
        }
        function toggleMenu() { document.getElementById('menuModal').classList.toggle('hidden'); }
        
        function applyTheme() {
            const url = THEMES[state.theme];
            document.body.style.backgroundImage = `url('${url}')`;
        }

        function saveAndResume() {
            const themeSelect = document.getElementById('themeSelect');
            const newTheme = themeSelect.value;
            if (newTheme !== state.theme) {
                state.theme = newTheme;
                localStorage.setItem('spider_theme', state.theme);
                applyTheme();
            }
            toggleMenu();
        }

        function confirmNewGame() {
            const diffSelect = document.getElementById('difficultySelect');
            state.difficulty = parseInt(diffSelect.value);
            localStorage.setItem('spider_difficulty', state.difficulty);
            
            const themeSelect = document.getElementById('themeSelect');
            state.theme = themeSelect.value;
            localStorage.setItem('spider_theme', state.theme);
            applyTheme();

            toggleMenu(); 
            startNewGame();
        }

        function addFoundationGraphic(suit) {
            const fContainer = document.getElementById('foundations');
            const div = document.createElement('div');
            div.className = 'w-10 h-14 sm:w-14 sm:h-20 bg-white rounded border-2 border-gray-400 flex items-center justify-center shadow-md ' + getSuitColor(suit);
            div.innerHTML = `<div class="text-4xl">${ICONS[suit]}</div>`;
            fContainer.appendChild(div);
        }
        function showHint() {
            for (let c = 0; c < 10; c++) {
                if (state.tableau[c].length === 0) continue;
                let stackStart = state.tableau[c].length - 1;
                while (stackStart > 0) {
                    const curr = state.tableau[c][stackStart];
                    const prev = state.tableau[c][stackStart - 1];
                    if (prev.faceUp && prev.suit === curr.suit && prev.value === curr.value + 1) stackStart--;
                    else break;
                }
                const movingCard = state.tableau[c][stackStart];
                for (let t = 0; t < 10; t++) {
                    if (c === t) continue;
                    if (state.tableau[t].length === 0) { animateHint(c, stackStart); return; }
                    const targetTop = state.tableau[t][state.tableau[t].length - 1];
                    if (targetTop.value === movingCard.value + 1) { animateHint(c, stackStart); return; }
                }
            }
            showMessage("No moves found. Try dealing?");
        }
        function animateHint(colIdx, cardIdx) {
            const tableau = document.getElementById('tableau');
            const col = tableau.children[colIdx];
            const card = col.children[cardIdx];
            card.classList.add('hint-anim');
            setTimeout(() => card.classList.remove('hint-anim'), 500);
        }
        let confettiInterval;
        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const pieces = [];
            const colors = ['#d4af37', '#f4e5a7', '#ffffff', '#b8941f']; // Gold/White confetti
            for(let i=0; i<200; i++) {
                pieces.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4, speedY: Math.random() * 5 + 2, speedX: Math.random() * 2 - 1
                });
            }
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
                    p.y += p.speedY; p.x += p.speedX;
                    if(p.y > canvas.height) p.y = -20;
                });
                confettiInterval = requestAnimationFrame(animate);
            }
            animate();
        }
        function stopConfetti() {
            if (confettiInterval) cancelAnimationFrame(confettiInterval);
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        window.dealStock = dealStock;
        window.toggleMenu = toggleMenu;
        window.undoMove = undoMove;
        window.showHint = showHint;
        window.startNewGame = startNewGame;
        window.confirmNewGame = confirmNewGame;
        window.saveAndResume = saveAndResume;
        window.handleEmptyColumnClick = handleEmptyColumnClick;

        init();
    </script>
</body>
</html>