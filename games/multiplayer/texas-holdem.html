<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GunnersGames Texas Hold'em - Multiplayer</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold: #d4af37;
            --gold-dark: #b8941f;
            --gold-light: #f4e5a7;
            --cream: #f5f3e8;
            --dark: #1a1410;
            --red: #8b0000;
            --green: #0a4a2e;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            background: url('/games/assets/casino/greentop.png') center/cover;
            user-select: none;
        }

        /* Waiting Room */
        #waitingRoom {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        #waitingRoom.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .waiting-title {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: var(--gold);
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .player-list {
            background: rgba(0,0,0,0.6);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 2rem;
            min-width: 400px;
            margin-bottom: 2rem;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            color: var(--cream);
            font-size: 1.2rem;
        }

        .player-ready {
            color: #00ff00;
            font-weight: bold;
        }

        .ready-button {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            padding: 1rem 3rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.1em;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .ready-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.6);
        }

        .ready-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .leave-button {
            margin-top: 1rem;
            background: transparent;
            color: var(--gold);
            border: 2px solid var(--gold);
        }

        /* Game Interface */
        #gameContainer {
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: column;
            position: relative;
        }

        #gameContainer.active {
            display: flex;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.0) 100%);
            flex-shrink: 0;
            z-index: 10;
        }

        .logo {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
            letter-spacing: 0.15em;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
        }

        .poker-table {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Community Cards */
        .community-area {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 100px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            min-height: 140px;
            min-width: 480px;
            justify-content: center;
            align-items: center;
        }

        /* Pot Display */
        .pot-display {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            font-size: 1.2rem;
            background: rgba(0,0,0,0.6);
            padding: 5px 20px;
            border-radius: 20px;
            border: 1px solid var(--gold);
            text-shadow: 0 0 5px var(--gold);
        }

        /* Cards */
        .card {
            width: 80px;
            height: 112px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-radius: 6px;
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 6px;
        }

        .card-back {
            background: url('/games/assets/casino/card_back.png') center/cover;
            border: 1px solid #fff;
        }

        .card-front {
            background: white;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-value {
            font-size: 1.2rem;
            line-height: 1;
        }

        .card-suit {
            font-size: 1.8rem;
            text-align: center;
            line-height: 1;
        }

        .hearts, .diamonds { color: #dc143c; }
        .clubs, .spades { color: #000; }

        /* Player Seats */
        .seat {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 180px;
            transition: all 0.3s;
        }

        .seat-name {
            background: rgba(0,0,0,0.8);
            color: var(--gold);
            padding: 4px 15px;
            border-radius: 15px;
            border: 1px solid var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .seat-chips {
            font-size: 0.8rem;
            color: var(--cream);
            margin-left: 5px;
        }

        .seat-hand {
            display: flex;
            gap: 5px;
            height: 112px;
            justify-content: center;
        }

        .seat-action {
            position: absolute;
            top: -30px;
            background: var(--gold);
            color: var(--dark);
            padding: 2px 10px;
            border-radius: 10px;
            font-weight: bold;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .seat-action.show {
            opacity: 1;
        }

        .dealer-button {
            width: 20px;
            height: 20px;
            background: white;
            color: black;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            position: absolute;
            top: 50px;
            left: -25px;
            border: 2px solid black;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Seat Positions */
        #seat-0 { bottom: 120px; left: 50%; transform: translateX(-50%); }
        #seat-1 { top: 120px; left: 10%; }
        #seat-2 { top: 40px; left: 50%; transform: translateX(-50%); }
        #seat-3 { top: 120px; right: 10%; }

        /* Active Turn */
        .seat.active-turn .seat-name {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark);
            box-shadow: 0 0 15px var(--gold);
        }

        /* Controls */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 100%);
            border-top: 2px solid var(--gold);
            z-index: 20;
        }

        .controls.active {
            display: flex;
        }

        .game-button {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(212, 175, 55, 0.4);
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.6);
        }

        .game-button.fold {
            background: linear-gradient(135deg, #8b0000 0%, #660000 100%);
            color: white;
        }

        /* Raise Controls */
        .raise-container {
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .raise-container.active {
            display: flex;
        }

        .raise-slider {
            width: 200px;
        }

        /* Emoji Bar */
        .emoji-bar {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 50px;
            border: 1px solid var(--gold);
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 5px 10px;
        }

        .emoji-btn:hover {
            transform: scale(1.3);
        }

        /* Emoji Bubble */
        .emoji-bubble {
            position: absolute;
            font-size: 3rem;
            animation: floatUp 3s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        /* Turn Timer */
        .turn-timer {
            position: absolute;
            top: -50px;
            right: 10px;
            background: rgba(139, 0, 0, 0.8);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            font-size: 1rem;
            border: 2px solid #ff0000;
        }

        /* Message Overlay */
        .message-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: var(--gold);
            padding: 2rem 4rem;
            border-radius: 20px;
            border: 3px solid var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            z-index: 1000;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.6);
            animation: messageAppear 0.3s;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    </style>
</head>
<body>
    <!-- Waiting Room -->
    <div id="waitingRoom">
        <h1 class="waiting-title">WAITING FOR PLAYERS</h1>
        <div class="player-list" id="playerList"></div>
        <button class="ready-button" id="readyBtn">READY</button>
        <button class="ready-button leave-button" id="leaveBtn">LEAVE ROOM</button>
    </div>

    <!-- Game Container -->
    <div id="gameContainer">
        <!-- Header -->
        <div class="header">
            <div class="logo">TEXAS HOLD'EM</div>
        </div>

        <!-- Poker Table -->
        <div class="poker-table">
            <!-- Community Cards -->
            <div class="community-area" id="communityCards"></div>

            <!-- Pot Display -->
            <div class="pot-display" id="potDisplay">POT: 0</div>

            <!-- Player Seats -->
            <div class="seat" id="seat-0">
                <div class="seat-action" id="action-0"></div>
                <div class="seat-name">
                    <span id="name-0">You</span>
                    <span class="seat-chips" id="chips-0">0</span>
                </div>
                <div class="seat-hand" id="hand-0"></div>
            </div>

            <div class="seat" id="seat-1">
                <div class="seat-action" id="action-1"></div>
                <div class="seat-name">
                    <span id="name-1">Player 2</span>
                    <span class="seat-chips" id="chips-1">0</span>
                </div>
                <div class="seat-hand" id="hand-1"></div>
            </div>

            <div class="seat" id="seat-2">
                <div class="seat-action" id="action-2"></div>
                <div class="seat-name">
                    <span id="name-2">Player 3</span>
                    <span class="seat-chips" id="chips-2">0</span>
                </div>
                <div class="seat-hand" id="hand-2"></div>
            </div>

            <div class="seat" id="seat-3">
                <div class="seat-action" id="action-3"></div>
                <div class="seat-name">
                    <span id="name-3">Player 4</span>
                    <span class="seat-chips" id="chips-3">0</span>
                </div>
                <div class="seat-hand" id="hand-3"></div>
            </div>

            <!-- Emoji Bar -->
            <div class="emoji-bar">
                <button class="emoji-btn" data-emoji="ðŸ˜Ž">ðŸ˜Ž</button>
                <button class="emoji-btn" data-emoji="ðŸ”¥">ðŸ”¥</button>
                <button class="emoji-btn" data-emoji="ðŸ’°">ðŸ’°</button>
                <button class="emoji-btn" data-emoji="ðŸ˜¤">ðŸ˜¤</button>
                <button class="emoji-btn" data-emoji="ðŸŽ‰">ðŸŽ‰</button>
                <button class="emoji-btn" data-emoji="ðŸ˜…">ðŸ˜…</button>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls" id="playerControls">
            <button class="game-button fold" id="btnFold">FOLD</button>
            <button class="game-button" id="btnCheckCall">CALL</button>
            <button class="game-button" id="btnRaise">RAISE</button>

            <div class="raise-container" id="raiseContainer">
                <input type="range" class="raise-slider" id="raiseSlider" min="0" max="1000" step="10" value="100">
                <span style="color: var(--gold); font-family: 'Cinzel', serif; font-size: 1.2rem;" id="raiseAmount">100</span>
                <button class="game-button" id="btnConfirmRaise">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- Multiplayer Core -->
    <script src="/multiplayer-core.js"></script>

    <script>
        // ====== FIREBASE CONFIG ======
        // TODO: Replace with your actual Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDjdo3U9qg_h4TKvplsFoZgxVNepAbCpFA",
  authDomain: "gunners-games.firebaseapp.com",
  projectId: "gunners-games",
  storageBucket: "gunners-games.firebasestorage.app",
  messagingSenderId: "644077315462",
  appId: "1:644077315462:web:431dd985426f3dbe02f807",
  measurementId: "G-RWNL900X43"
};

        firebase.initializeApp(firebaseConfig);

        // ====== GAME CONSTANTS ======
        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const SMALL_BLIND = 10;
        const BIG_BLIND = 20;

        // ====== STATE ======
        let mp = null;
        let roomId = null;
        let playerSeats = {}; // Maps userId to seat index
        let myUserId = null;
        let mySeatIndex = null;
        let gameActive = false;

        // ====== INIT ======
        async function init() {
            // Get room ID from URL
            roomId = new URLSearchParams(window.location.search).get('room');
            
            if (!roomId) {
                alert('No room ID provided!');
                window.location.href = '/multiplayer-lobby.html';
                return;
            }

            // Wait for auth
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = '/index.html';
                    return;
                }

                myUserId = user.uid;

                // Initialize multiplayer
                mp = new MultiplayerGame({
                    roomId: roomId,
                    gameType: 'texas-holdem',
                    maxPlayers: 4,
                    minPlayers: 2,
                    turnTimeout: 30000,
                    
                    onPlayerJoined: handlePlayerJoined,
                    onPlayerLeft: handlePlayerLeft,
                    onGameStateUpdate: handleGameStateUpdate,
                    onGameStart: handleGameStart,
                    onGameEnd: handleGameEnd,
                    onPlayerAction: handlePlayerAction,
                    onTurnChange: handleTurnChange,
                    onChatMessage: handleChatMessage
                });

                try {
                    await mp.init();
                    console.log('Multiplayer initialized');
                    updateWaitingRoom();
                } catch (error) {
                    console.error('Failed to initialize:', error);
                    alert('Failed to join room: ' + error.message);
                    window.location.href = '/multiplayer-lobby.html';
                }
            });
        }

        // ====== WAITING ROOM ======
        function updateWaitingRoom() {
            const playerListEl = document.getElementById('playerList');
            playerListEl.innerHTML = '';

            const players = mp.allPlayers;
            Object.entries(players).forEach(([playerId, player]) => {
                if (!player.connected) return;

                const item = document.createElement('div');
                item.className = 'player-item';
                item.innerHTML = `
                    <span>${player.name}</span>
                    <span class="${player.ready ? 'player-ready' : ''}">
                        ${player.ready ? 'âœ“ READY' : 'Not Ready'}
                    </span>
                `;
                playerListEl.appendChild(item);
            });

            // Update ready button
            const localPlayer = players[myUserId];
            if (localPlayer && localPlayer.ready) {
                document.getElementById('readyBtn').innerText = 'WAITING...';
                document.getElementById('readyBtn').disabled = true;
            }
        }

        function handlePlayerJoined(playerId, player) {
            console.log(`${player.name} joined`);
            updateWaitingRoom();
        }

        function handlePlayerLeft(playerId, player) {
            console.log(`${player.name} left`);
            updateWaitingRoom();
            
            if (gameActive) {
                // Remove from seat
                const seatIndex = playerSeats[playerId];
                if (seatIndex !== undefined) {
                    document.getElementById(`seat-${seatIndex}`).style.display = 'none';
                    delete playerSeats[playerId];
                }
            }
        }

        // ====== GAME START ======
        function handleGameStart(state) {
            console.log('Game starting!');
            gameActive = true;

            // Hide waiting room, show game
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('gameContainer').classList.add('active');

            // Assign seats
            const playerOrder = mp.getPlayerOrder();
            playerOrder.forEach((playerId, index) => {
                playerSeats[playerId] = index;
                const player = mp.getPlayer(playerId);
                
                document.getElementById(`name-${index}`).innerText = player.name;
                document.getElementById(`chips-${index}`).innerText = player.chips;
                document.getElementById(`seat-${index}`).style.display = 'flex';

                if (playerId === myUserId) {
                    mySeatIndex = index;
                }
            });

            // Hide empty seats
            for (let i = playerOrder.length; i < 4; i++) {
                document.getElementById(`seat-${i}`).style.display = 'none';
            }

            // If host, deal cards
            if (mp.isHost) {
                dealNewHand();
            }
        }

        // ====== GAME LOGIC ======
        async function dealNewHand() {
            if (!mp.isHost) return;

            // Create and shuffle deck
            const deck = createDeck();
            
            // Deal 2 cards to each player
            const playerOrder = mp.getPlayerOrder();
            const hands = {};
            
            playerOrder.forEach(playerId => {
                hands[playerId] = [deck.pop(), deck.pop()];
            });

            // Set game state
            await mp.setGameState({
                deck: deck,
                hands: hands,
                communityCards: [],
                pot: 0,
                currentBet: BIG_BLIND,
                round: 'preflop',
                dealerIndex: 0,
                currentTurnIndex: 2 % playerOrder.length, // Start after big blind
                playerOrder: playerOrder,
                bets: {},
                folded: {}
            }, true);

            // Post blinds
            await postBlinds();
        }

        async function postBlinds() {
            const playerOrder = mp.gameState.playerOrder;
            const smallBlindPlayer = playerOrder[1 % playerOrder.length];
            const bigBlindPlayer = playerOrder[2 % playerOrder.length];

            // Deduct blinds
            await mp.updatePlayerData(smallBlindPlayer, {
                chips: mp.getPlayer(smallBlindPlayer).chips - SMALL_BLIND
            });
            
            await mp.updatePlayerData(bigBlindPlayer, {
                chips: mp.getPlayer(bigBlindPlayer).chips - BIG_BLIND
            });

            // Update pot
            await mp.updateGameState({
                pot: SMALL_BLIND + BIG_BLIND,
                bets: {
                    [smallBlindPlayer]: SMALL_BLIND,
                    [bigBlindPlayer]: BIG_BLIND
                }
            }, true);
        }

        function createDeck() {
            let deck = [];
            for (let suit of SUITS) {
                for (let rank of RANKS) {
                    deck.push({ suit, value: rank });
                }
            }
            // Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // ====== UI UPDATES ======
        function handleGameStateUpdate(state, oldState) {
            // Update pot
            document.getElementById('potDisplay').innerText = `POT: ${state.pot || 0}`;

            // Update community cards
            if (state.communityCards) {
                renderCommunityCards(state.communityCards);
            }

            // Update player chips
            if (state.playerOrder) {
                state.playerOrder.forEach(playerId => {
                    const player = mp.getPlayer(playerId);
                    const seatIndex = playerSeats[playerId];
                    if (seatIndex !== undefined && player) {
                        document.getElementById(`chips-${seatIndex}`).innerText = player.chips;
                    }
                });
            }

            // Update hands
            if (state.hands && state.hands[myUserId]) {
                renderMyHand(state.hands[myUserId]);
            }

            // Show folded players
            if (state.folded) {
                Object.entries(state.folded).forEach(([playerId, isFolded]) => {
                    const seatIndex = playerSeats[playerId];
                    if (seatIndex !== undefined && isFolded) {
                        document.getElementById(`hand-${seatIndex}`).style.opacity = '0.3';
                    }
                });
            }
        }

        function renderCommunityCards(cards) {
            const container = document.getElementById('communityCards');
            container.innerHTML = '';
            
            cards.forEach(card => {
                container.appendChild(createCardElement(card, true));
            });
        }

        function renderMyHand(cards) {
            const container = document.getElementById(`hand-${mySeatIndex}`);
            container.innerHTML = '';
            
            cards.forEach(card => {
                container.appendChild(createCardElement(card, true));
            });
        }

        function createCardElement(card, flipped = false) {
            const el = document.createElement('div');
            el.className = `card ${flipped ? 'flipped' : ''}`;
            
            const suitClass = (card.suit === 'â™¥' || card.suit === 'â™¦') ? 'hearts' : 'clubs';
            
            el.innerHTML = `
                <div class="card-back"></div>
                <div class="card-front">
                    <div class="card-value ${suitClass}">${card.value}</div>
                    <div class="card-suit ${suitClass}">${card.suit}</div>
                    <div class="card-value ${suitClass}" style="transform: rotate(180deg);">${card.value}</div>
                </div>
            `;
            
            return el;
        }

        function handleTurnChange(currentTurnPlayerId, state) {
            // Clear all active turn indicators
            document.querySelectorAll('.seat').forEach(seat => {
                seat.classList.remove('active-turn');
            });

            // Highlight current player
            const seatIndex = playerSeats[currentTurnPlayerId];
            if (seatIndex !== undefined) {
                document.getElementById(`seat-${seatIndex}`).classList.add('active-turn');
            }

            // Enable/disable controls
            if (currentTurnPlayerId === myUserId) {
                enableControls(state);
            } else {
                disableControls();
            }
        }

        function enableControls(state) {
            document.getElementById('playerControls').classList.add('active');

            const toCall = (state.currentBet || 0) - ((state.bets && state.bets[myUserId]) || 0);
            const callBtn = document.getElementById('btnCheckCall');
            
            if (toCall === 0) {
                callBtn.innerText = 'CHECK';
            } else {
                callBtn.innerText = `CALL ${toCall}`;
            }

            // Setup raise slider
            const myChips = mp.getPlayer(myUserId).chips;
            const raiseSlider = document.getElementById('raiseSlider');
            raiseSlider.min = state.currentBet || BIG_BLIND;
            raiseSlider.max = myChips;
            raiseSlider.value = Math.min(state.currentBet * 2 || BIG_BLIND * 2, myChips);
            document.getElementById('raiseAmount').innerText = raiseSlider.value;
        }

        function disableControls() {
            document.getElementById('playerControls').classList.remove('active');
            document.getElementById('raiseContainer').classList.remove('active');
        }

        function handlePlayerAction(action) {
            const seatIndex = playerSeats[action.playerId];
            if (seatIndex === undefined) return;

            let text = '';
            switch(action.type) {
                case 'fold':
                    text = 'FOLD';
                    break;
                case 'check':
                    text = 'CHECK';
                    break;
                case 'call':
                    text = 'CALL';
                    break;
                case 'raise':
                case 'bet':
                    text = `RAISE ${action.amount}`;
                    break;
            }

            showActionBubble(seatIndex, text);
        }

        function showActionBubble(seatIndex, text) {
            const bubble = document.getElementById(`action-${seatIndex}`);
            bubble.innerText = text;
            bubble.classList.add('show');
            
            setTimeout(() => {
                bubble.classList.remove('show');
            }, 2000);
        }

        function handleChatMessage(message) {
            const seatIndex = playerSeats[message.playerId];
            if (seatIndex === undefined) return;

            const bubble = document.createElement('div');
            bubble.className = 'emoji-bubble';
            bubble.innerText = message.emoji;
            bubble.style.left = '50%';
            bubble.style.top = '50px';

            const seat = document.getElementById(`seat-${seatIndex}`);
            seat.appendChild(bubble);

            setTimeout(() => bubble.remove(), 3000);
        }

        function handleGameEnd(state) {
            console.log('Game ended!', state.results);
            
            setTimeout(() => {
                showMessage('Hand Complete!');
                setTimeout(() => {
                    if (mp.isHost) {
                        dealNewHand();
                    }
                }, 3000);
            }, 2000);
        }

        function showMessage(text) {
            const msg = document.createElement('div');
            msg.className = 'message-overlay';
            msg.innerText = text;
            document.body.appendChild(msg);
            
            setTimeout(() => msg.remove(), 2000);
        }

        // ====== PLAYER ACTIONS ======
        document.getElementById('readyBtn').addEventListener('click', async () => {
            await mp.setReady(true);
            updateWaitingRoom();
        });

        document.getElementById('leaveBtn').addEventListener('click', async () => {
            await mp.leaveRoom();
            window.location.href = '/multiplayer-lobby.html';
        });

        document.getElementById('btnFold').addEventListener('click', async () => {
            await mp.submitAction({ type: 'fold' });
            
            if (mp.isHost) {
                await mp.updateGameState({
                    folded: { ...mp.gameState.folded, [myUserId]: true }
                }, true);
                advanceTurn();
            }
        });

        document.getElementById('btnCheckCall').addEventListener('click', async () => {
            const state = mp.gameState;
            const toCall = (state.currentBet || 0) - ((state.bets && state.bets[myUserId]) || 0);
            
            if (toCall === 0) {
                await mp.submitAction({ type: 'check' });
            } else {
                await mp.submitAction({ type: 'call', amount: toCall });
                
                if (mp.isHost) {
                    const myChips = mp.getPlayer(myUserId).chips;
                    await mp.updatePlayerData(myUserId, { chips: myChips - toCall });
                    await mp.updateGameState({
                        pot: state.pot + toCall,
                        bets: { ...state.bets, [myUserId]: (state.bets[myUserId] || 0) + toCall }
                    }, true);
                }
            }
            
            if (mp.isHost) {
                advanceTurn();
            }
        });

        document.getElementById('btnRaise').addEventListener('click', () => {
            document.getElementById('raiseContainer').classList.add('active');
        });

        document.getElementById('raiseSlider').addEventListener('input', (e) => {
            document.getElementById('raiseAmount').innerText = e.target.value;
        });

        document.getElementById('btnConfirmRaise').addEventListener('click', async () => {
            const amount = parseInt(document.getElementById('raiseSlider').value);
            await mp.submitAction({ type: 'raise', amount });
            
            if (mp.isHost) {
                const state = mp.gameState;
                const myChips = mp.getPlayer(myUserId).chips;
                const currentBet = (state.bets && state.bets[myUserId]) || 0;
                const additionalBet = amount - currentBet;
                
                await mp.updatePlayerData(myUserId, { chips: myChips - additionalBet });
                await mp.updateGameState({
                    pot: state.pot + additionalBet,
                    currentBet: amount,
                    bets: { ...state.bets, [myUserId]: amount }
                }, true);
                
                advanceTurn();
            }
            
            document.getElementById('raiseContainer').classList.remove('active');
        });

        // Emoji buttons
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                mp.sendEmoji(btn.dataset.emoji);
            });
        });

        // ====== GAME FLOW (HOST ONLY) ======
        async function advanceTurn() {
            if (!mp.isHost) return;

            const state = mp.gameState;
            const playerOrder = state.playerOrder;
            let nextIndex = (state.currentTurnIndex + 1) % playerOrder.length;
            
            // Skip folded players
            while (state.folded && state.folded[playerOrder[nextIndex]]) {
                nextIndex = (nextIndex + 1) % playerOrder.length;
            }

            // Check if betting round complete
            const activePlayers = playerOrder.filter(id => !state.folded || !state.folded[id]);
            const allBetsEqual = activePlayers.every(id => 
                (state.bets && state.bets[id]) === state.currentBet
            );

            if (allBetsEqual && nextIndex === ((state.dealerIndex + 3) % playerOrder.length)) {
                // Round complete, move to next round
                await advanceRound();
            } else {
                // Next player's turn
                await mp.updateGameState({
                    currentTurnIndex: nextIndex,
                    currentTurn: playerOrder[nextIndex]
                }, true);
            }
        }

        async function advanceRound() {
            const state = mp.gameState;
            let newRound, newCards = [];

            if (state.round === 'preflop') {
                newRound = 'flop';
                newCards = [state.deck.pop(), state.deck.pop(), state.deck.pop()];
            } else if (state.round === 'flop') {
                newRound = 'turn';
                newCards = [state.deck.pop()];
            } else if (state.round === 'turn') {
                newRound = 'river';
                newCards = [state.deck.pop()];
            } else {
                // Showdown
                await showdown();
                return;
            }

            await mp.updateGameState({
                round: newRound,
                communityCards: [...(state.communityCards || []), ...newCards],
                currentBet: 0,
                bets: {},
                currentTurnIndex: (state.dealerIndex + 1) % state.playerOrder.length,
                currentTurn: state.playerOrder[(state.dealerIndex + 1) % state.playerOrder.length]
            }, true);
        }

        async function showdown() {
            // Determine winner (simplified - just give pot to last standing player)
            const state = mp.gameState;
            const activePlayers = state.playerOrder.filter(id => !state.folded || !state.folded[id]);
            
            if (activePlayers.length === 1) {
                const winner = activePlayers[0];
                const winnerChips = mp.getPlayer(winner).chips;
                
                await mp.updatePlayerData(winner, { chips: winnerChips + state.pot });
                
                const results = {};
                state.playerOrder.forEach(id => {
                    results[id] = { winnings: id === winner ? state.pot : 0 };
                });
                
                await mp.endGame(results);
            }
        }

        // ====== START ======
        init();
    </script>
</body>
</html>
