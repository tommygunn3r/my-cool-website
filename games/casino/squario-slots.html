<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GunnersGames â€“ Squario Slots</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold: #d4af37;
            --gold-dark: #b8941f;
            --gold-light: #f4e5a7;
            --cream: #f5f3e8;
            --dark: #1a1410;
            --red: #8b0000;
            --green: #0a4a2e;
            --accent: #ffcc33;
        }

        html, body { width: 100%; height: 100%; }

        body {
            font-family: 'Cormorant Garamond', serif;
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            background-color: #0a4a2e;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            touch-action: manipulation;
        }

        /* --- Start Screen --- */
        #tableSelector {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.5s, visibility 0.5s;
        }
        #tableSelector.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .selector-title {
            font-family: 'Cinzel', serif; font-size: 3rem; font-weight: 700; color: var(--gold);
            margin-bottom: 1rem; text-shadow: 0 0 20px rgba(212, 175, 55, 0.5); text-align: center;
        }
        .selector-sub {
            font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--cream); margin-bottom: 1.5rem; letter-spacing: 0.15em; text-align: center;
        }
        .loading-text { 
            color: var(--gold); font-family: 'Cinzel', serif; font-size: 1.2rem; margin-top: 20px; animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .start-button {
            font-family: 'Cinzel', serif; font-size: 1.5rem; padding: 1rem 4rem; margin-top: 2rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark); border: none; border-radius: 50px; cursor: pointer; font-weight: 600;
            letter-spacing: 0.1em; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4); display: none;
        }
        .start-button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.6); }

        /* --- Main Layout Structure --- */
        #gameContainer {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            flex: 0 0 50px;
            display: flex; justify-content: space-between; align-items: center; padding: 0 1rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 100%);
            border-bottom: 2px solid var(--gold);
            z-index: 10;
        }
        .logo {
            font-family: 'Cinzel', serif; font-size: 1.1rem; font-weight: 700; color: var(--gold);
            letter-spacing: 0.1em; text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
        }
        .game-title {
            font-family: 'Cinzel', serif; font-size: 0.9rem; font-weight: 600; color: var(--cream);
            letter-spacing: 0.1em; text-align: center;
        }
        .balance { display: flex; align-items: center; gap: 0.3rem; font-size: 1rem; color: var(--cream); font-weight: 600; }
        .coin-icon {
            width: 24px; height: 24px; background: radial-gradient(circle, var(--gold-light) 0%, var(--gold) 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: var(--dark); font-size: 0.8rem; box-shadow: 0 2px 10px rgba(212, 175, 55, 0.5);
        }
        .settings-button {
            background: rgba(0, 0, 0, 0.6); border: 2px solid var(--gold); color: var(--gold);
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1rem;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- The Game Area (Centerpiece) --- */
        .game-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1vh 1vw;
            overflow: hidden;
            width: 100%;
            position: relative;
        }

        .slot-wrapper {
            width: 100%;
            max-width: 600px;
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.5rem;
            
            background: radial-gradient(circle at top, rgba(255,255,255,0.08), rgba(0,0,0,0.85));
            border-radius: 20px;
            border: 2px solid rgba(212, 175, 55, 0.6);
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            padding: 0.8rem;
            position: relative;
            
            max-height: calc(100vh - 70px);
        }

        /* --- Top Info Row --- */
        .slot-header-row {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 0.85rem; 
            color: var(--cream); 
            flex-shrink: 0;
            min-height: 24px;
        }
        .status-label { color: var(--gold); font-weight: 600; }
        .free-spin-indicator {
            padding: 0.1rem 0.5rem; border-radius: 999px; border: 1px solid var(--gold);
            background: rgba(0,0,0,0.6); color: var(--accent); font-size: 0.75rem;
        }
        .free-spin-indicator.hidden { opacity: 0; visibility: hidden; }

        /* --- THE GRID - PROPERLY CONSTRAINED --- */
        .slot-grid {
            position: relative;
            border-radius: 14px;
            border: 2px solid rgba(0,0,0,0.8);
            background: linear-gradient(180deg, #4fa64a 0%, #26602a 100%);
            padding: 0.4rem;
            
            /* Keep grid from growing too large */
            flex: 0 1 auto;
            width: 100%;
            aspect-ratio: 5 / 3;
            max-height: 35vh;
            min-height: 120px;
        }

        .slot-reels {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.2rem;
            height: 100%;
            width: 100%;
        }

        .reel-column {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            gap: 0.2rem;
            height: 100%;
        }

        .slot-symbol {
            position: relative;
            background: radial-gradient(circle at top, rgba(255,255,255,0.12), rgba(0,0,0,0.6));
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.6);
            width: 100%;
            height: 100%;
            padding: 2px;
        }

        .slot-symbol img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .slot-symbol.spinning img { animation: wiggle 0.4s infinite; }
        @keyframes wiggle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            33% { transform: scale(1.05) rotate(-5deg); }
            66% { transform: scale(0.95) rotate(5deg); }
        }

        .slot-symbol.winning {
            animation: pulse-win 0.6s ease-in-out infinite alternate;
            border: 2px solid var(--gold);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.8), inset 0 0 10px rgba(212, 175, 55, 0.4);
        }
        @keyframes pulse-win {
            0% { background: radial-gradient(circle at top, rgba(255,255,255,0.3), rgba(212,175,55,0.4)); }
            100% { background: radial-gradient(circle at top, rgba(255,255,255,0.5), rgba(212,175,55,0.6)); }
        }

        /* --- Stats Row - ALWAYS VISIBLE --- */
        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.6rem;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            font-size: 0.85rem;
            color: var(--cream);
            flex-shrink: 0;
            min-height: 36px;
        }
        .stat-item { display: flex; align-items: center; gap: 0.3rem; }
        .stat-label { color: var(--gold); font-weight: 600; }
        .stat-value { font-weight: 600; }

        /* --- Controls Row --- */
        .controls-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            min-height: 44px;
        }

        .bet-control {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex: 1;
        }
        .bet-label {
            font-size: 0.85rem;
            color: var(--gold);
            font-weight: 600;
            white-space: nowrap;
        }
        .bet-input {
            flex: 1;
            min-width: 60px;
            padding: 0.4rem 0.6rem;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--gold-dark);
            border-radius: 8px;
            color: var(--cream);
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
        }

        .max-bet-btn {
            padding: 0.4rem 0.8rem;
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: var(--dark);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .max-bet-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .spin-btn {
            padding: 0.6rem 2rem;
            background: linear-gradient(135deg, var(--red) 0%, #5a0000 100%);
            color: var(--gold);
            border: 2px solid var(--gold);
            border-radius: 12px;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.1em;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.5);
            flex-shrink: 0;
        }
        .spin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6);
        }
        .spin-btn:active {
            transform: translateY(0);
        }

        /* --- Slot Handle --- */
        .slot-handle {
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 80px;
            cursor: pointer;
            z-index: 5;
        }
        .handle-lever {
            width: 8px;
            height: 60px;
            background: linear-gradient(90deg, #888, #aaa);
            border-radius: 4px;
            position: absolute;
            right: 10px;
            top: 10px;
            transform-origin: top center;
            transition: transform 0.3s ease-out;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        .handle-ball {
            width: 24px;
            height: 24px;
            background: radial-gradient(circle at 30% 30%, var(--gold-light), var(--gold-dark));
            border-radius: 50%;
            position: absolute;
            right: 2px;
            bottom: 0;
            box-shadow: 0 3px 8px rgba(0,0,0,0.6);
        }
        .slot-handle.pulled .handle-lever {
            transform: rotate(25deg);
        }

        /* --- Message Display --- */
        .message-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: radial-gradient(circle, rgba(0,0,0,0.95), rgba(0,0,0,0.85));
            padding: 2rem 3rem;
            border-radius: 20px;
            border: 3px solid var(--gold);
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.8);
            z-index: 999;
            opacity: 0;
            transition: all 0.3s ease;
            text-align: center;
        }
        .message-display.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .message-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
            margin-bottom: 0.5rem;
            letter-spacing: 0.15em;
        }
        .message-sub {
            font-size: 1.5rem;
            color: var(--cream);
            font-weight: 600;
        }

        /* --- Settings Modal --- */
        .settings-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .settings-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .settings-content {
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            padding: 2rem;
            border-radius: 20px;
            border: 2px solid var(--gold);
            max-width: 500px;
            width: 90%;
        }
        .settings-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .settings-option {
            margin-bottom: 1.5rem;
        }
        .settings-label {
            display: block;
            color: var(--cream);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .settings-select {
            width: 100%;
            padding: 0.6rem;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            color: var(--cream);
            font-size: 1rem;
        }
        .toggle-btn {
            padding: 0.6rem 1.5rem;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            color: var(--cream);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .toggle-btn.active {
            background: var(--gold);
            color: var(--dark);
            border-color: var(--gold);
        }
        .close-settings-btn {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--dark);
            border: none;
            border-radius: 12px;
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* --- BONUS GAME OVERLAY --- */
        .bonus-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.85), rgba(0,0,0,0.95));
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .bonus-window {
            background: linear-gradient(135deg, var(--dark), #2a1f1a);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.8);
        }
        .bonus-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
        }
        .bonus-subtitle {
            font-size: 1.2rem;
            color: var(--cream);
            margin-bottom: 2rem;
        }
        .bonus-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .bonus-block {
            aspect-ratio: 1;
            background: radial-gradient(circle, rgba(255,255,255,0.1), rgba(0,0,0,0.6));
            border: 2px solid var(--gold-dark);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .bonus-block::before {
            content: '?';
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
        }
        .bonus-block:hover {
            transform: scale(1.05);
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
        }
        .bonus-block.revealed::before {
            content: attr(data-value);
        }
        .bonus-block.revealed {
            background: radial-gradient(circle, rgba(212, 175, 55, 0.3), rgba(0,0,0,0.8));
            animation: revealPulse 0.5s ease-out;
        }
        @keyframes revealPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .slot-wrapper {
                max-width: 95%;
                padding: 0.6rem;
            }
            .slot-grid {
                max-height: 30vh;
                min-height: 100px;
            }
            .slot-handle {
                right: -35px;
                width: 25px;
                height: 70px;
            }
            .handle-lever {
                width: 6px;
                height: 50px;
            }
            .handle-ball {
                width: 20px;
                height: 20px;
            }
        }

        @media (max-height: 600px) {
            .slot-grid {
                max-height: 25vh;
            }
            .stats-row {
                font-size: 0.75rem;
                padding: 0.3rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="tableSelector">
        <h1 class="selector-title">SQUARIO SLOTS</h1>
        <p class="selector-sub">SELECT YOUR TABLE</p>
        <select id="tableSelect" class="settings-select" style="max-width: 300px; margin-bottom: 1rem;">
            <option value="classic">CLASSIC GREEN</option>
            <option value="royal">ROYAL BLUE</option>
            <option value="crimson">CRIMSON VELVET</option>
            <option value="midnight">MIDNIGHT NOIR</option>
        </select>
        <p class="loading-text" id="loadingMsg">LOADING...</p>
        <button class="start-button" id="startGame">START GAME</button>
    </div>

    <!-- Main Game Container -->
    <div id="gameContainer">
        <header class="header">
            <div class="logo">GUNNERSGAMES</div>
            <div class="game-title">SQUARIO SLOTS</div>
            <div class="balance">
                <div class="coin-icon">G</div>
                <span id="balanceDisplay">0</span>
            </div>
        </header>

        <main class="game-area">
            <div class="slot-wrapper">
                <!-- Top Status Row -->
                <div class="slot-header-row">
                    <span class="status-label" id="playerLabel">PLAYER</span>
                    <span class="free-spin-indicator hidden" id="freeSpinBadge">0 FREE SPINS</span>
                    <button class="settings-button" id="settingsBtn">âš™</button>
                </div>

                <!-- Slot Grid -->
                <div class="slot-grid">
                    <div class="slot-reels" id="slotReels">
                        <!-- 5 columns Ã— 3 rows = 15 symbols -->
                        <div class="reel-column">
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ’%3C/text%3E%3C/svg%3E" alt="Cherry"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ‹%3C/text%3E%3C/svg%3E" alt="Lemon"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸŠ%3C/text%3E%3C/svg%3E" alt="Orange"></div>
                        </div>
                        <div class="reel-column">
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ‡%3C/text%3E%3C/svg%3E" alt="Grape"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ‰%3C/text%3E%3C/svg%3E" alt="Melon"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ””%3C/text%3E%3C/svg%3E" alt="Bell"></div>
                        </div>
                        <div class="reel-column">
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ’Ž%3C/text%3E%3C/svg%3E" alt="Diamond"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3Eâ­%3C/text%3E%3C/svg%3E" alt="Star"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ’%3C/text%3E%3C/svg%3E" alt="Cherry"></div>
                        </div>
                        <div class="reel-column">
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3E7ï¸âƒ£%3C/text%3E%3C/svg%3E" alt="Seven"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ‹%3C/text%3E%3C/svg%3E" alt="Lemon"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸŠ%3C/text%3E%3C/svg%3E" alt="Orange"></div>
                        </div>
                        <div class="reel-column">
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸŽ°%3C/text%3E%3C/svg%3E" alt="Squario"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ‡%3C/text%3E%3C/svg%3E" alt="Grape"></div>
                            <div class="slot-symbol"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3EðŸ‰%3C/text%3E%3C/svg%3E" alt="Melon"></div>
                        </div>
                    </div>
                </div>

                <!-- Stats Row - NOW ALWAYS VISIBLE -->
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-label">LAST WIN:</span>
                        <span class="stat-value" id="lastWinDisplay">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">SESSION:</span>
                        <span class="stat-value" id="sessionDisplay">0</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls-row">
                    <div class="bet-control">
                        <span class="bet-label">BET:</span>
                        <input type="number" id="betAmount" class="bet-input" value="10" min="1">
                        <button class="max-bet-btn" id="maxBetBtn">MAX</button>
                    </div>
                    <button class="spin-btn" id="spinBtn">SPIN</button>
                </div>

                <!-- Slot Handle -->
                <div class="slot-handle" id="slotHandle">
                    <div class="handle-lever"></div>
                    <div class="handle-ball"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Message Display -->
    <div class="message-display" id="messageDisplay">
        <div class="message-title" id="messageTitle">WIN!</div>
        <div class="message-sub" id="messageSub">+500 G</div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2 class="settings-title">SETTINGS</h2>
            <div class="settings-option">
                <label class="settings-label">SOUND</label>
                <button class="toggle-btn active" id="soundToggle">ON</button>
            </div>
            <div class="settings-option">
                <label class="settings-label">SPIN SPEED</label>
                <select id="speedSelect" class="settings-select">
                    <option value="0.6">SLOW</option>
                    <option value="0.45" selected>NORMAL</option>
                    <option value="0.3">FAST</option>
                </select>
            </div>
            <button class="close-settings-btn" id="closeSettings">CLOSE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, query, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDu3s-tTO7h53eBRhsAp8QyLe6e3XsN4yk",
            authDomain: "gunnersgames-b24f3.firebaseapp.com",
            projectId: "gunnersgames-b24f3",
            storageBucket: "gunnersgames-b24f3.firebasestorage.app",
            messagingSenderId: "98517731671",
            appId: "1:98517731671:web:e14e79e14bf65ae58b90ee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let auth, userId, playerName;

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = true;

        function beep(freq, duration, vol) {
            if (!soundEnabled) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.frequency.value = freq;
            gain.gain.value = vol;
            osc.start();
            setTimeout(() => osc.stop(), duration);
        }

        function playSpinStart() { beep(200, 100, 0.1); }
        function playReelStop() { beep(300, 50, 0.08); }
        function playWin() { beep(600, 200, 0.15); }
        function playBigWin() { 
            beep(800, 150, 0.2); 
            setTimeout(() => beep(1000, 150, 0.2), 150); 
        }
        function playLose() { beep(150, 100, 0.08); }
        function playBonusOpen() { 
            beep(400, 100, 0.15); 
            setTimeout(() => beep(600, 100, 0.15), 120); 
        }

        const REELS = 5;
        const ROWS = 3;

        const SYMBOLS = [
            { id: 'cherry', emoji: 'ðŸ’', weight: 15 },
            { id: 'lemon', emoji: 'ðŸ‹', weight: 14 },
            { id: 'orange', emoji: 'ðŸŠ', weight: 13 },
            { id: 'grape', emoji: 'ðŸ‡', weight: 12 },
            { id: 'melon', emoji: 'ðŸ‰', weight: 11 },
            { id: 'bell', emoji: 'ðŸ””', weight: 10 },
            { id: 'diamond', emoji: 'ðŸ’Ž', weight: 8 },
            { id: 'star', emoji: 'â­', weight: 7 },
            { id: 'seven', emoji: '7ï¸âƒ£', weight: 5 },
            { id: 'powerup', emoji: 'ðŸ”‹', weight: 3 },
            { id: 'squario', emoji: 'ðŸŽ°', weight: 2 }
        ];

        const PAYTABLE = {
            'cherry': { '3': 2, '4': 5, '5': 10 },
            'lemon': { '3': 3, '4': 7, '5': 15 },
            'orange': { '3': 4, '4': 10, '5': 20 },
            'grape': { '3': 5, '4': 12, '5': 25 },
            'melon': { '3': 6, '4': 15, '5': 30 },
            'bell': { '3': 8, '4': 20, '5': 50 },
            'diamond': { '3': 10, '4': 30, '5': 100 },
            'star': { '3': 15, '4': 50, '5': 200 },
            'seven': { '3': 25, '4': 100, '5': 500 },
            'powerup': { '3': 0, '4': 0, '5': 0 },
            'squario': { '3': 0, '4': 0, '5': 0 }
        };

        let balance = 0;
        let spinning = false;
        let currentGrid = [];
        let lastWinAmount = 0;
        let sessionTotalWin = 0;
        let freeSpinsRemaining = 0;
        let superWildSpinsRemaining = 0;
        let bonusActive = false;
        let spinDuration = 0.45;
        let selectedTable = 'classic';

        const TABLE_THEMES = {
            classic: { bg: 'url("https://i.imgur.com/jmR2wXO.jpeg")', name: 'Classic Green' },
            royal: { bg: 'url("https://i.imgur.com/wV8X3Mn.jpeg")', name: 'Royal Blue' },
            crimson: { bg: 'url("https://i.imgur.com/k5l0R1M.jpeg")', name: 'Crimson Velvet' },
            midnight: { bg: 'url("https://i.imgur.com/1aM5k3D.jpeg")', name: 'Midnight Noir' }
        };

        function applyTableVisuals() {
            const theme = TABLE_THEMES[selectedTable];
            document.body.style.backgroundImage = theme.bg;
        }

        async function loadUserBalance() {
            if (!userId) return;
            try {
                const docRef = doc(db, 'userBalances', userId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    balance = docSnap.data().balance || 0;
                } else {
                    await setDoc(docRef, { balance: 1000, username: playerName });
                    balance = 1000;
                }
                updateBalanceDisplay();
            } catch (error) {
                console.error('Balance load error:', error);
            }
        }

        async function saveBalance(newBalance) {
            if (!userId) return;
            try {
                const docRef = doc(db, 'userBalances', userId);
                await updateDoc(docRef, { balance: newBalance });
            } catch (error) {
                console.error('Balance save error:', error);
            }
        }

        function updateBalance(delta) {
            balance += delta;
            updateBalanceDisplay();
            saveBalance(balance);
        }

        function updateBalanceDisplay() {
            document.getElementById('balanceDisplay').textContent = balance.toLocaleString();
        }

        function updateStatsDisplay() {
            document.getElementById('lastWinDisplay').textContent = lastWinAmount.toLocaleString();
            document.getElementById('sessionDisplay').textContent = sessionTotalWin.toLocaleString();
        }

        function updateFreeSpinBadge() {
            const badge = document.getElementById('freeSpinBadge');
            if (freeSpinsRemaining > 0) {
                badge.textContent = `${freeSpinsRemaining} FREE SPINS`;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showMessage(title, subtitle = '') {
            const msg = document.getElementById('messageDisplay');
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageSub').textContent = subtitle;
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 2000);
        }

        function getRandomSymbol() {
            const totalWeight = SYMBOLS.reduce((sum, s) => sum + s.weight, 0);
            let rand = Math.random() * totalWeight;
            for (let sym of SYMBOLS) {
                rand -= sym.weight;
                if (rand <= 0) return sym.id;
            }
            return SYMBOLS[0].id;
        }

        function initGrid() {
            currentGrid = [];
            for (let col = 0; col < REELS; col++) {
                currentGrid[col] = [];
                for (let row = 0; row < ROWS; row++) {
                    currentGrid[col][row] = getRandomSymbol();
                }
            }
            renderGrid();
        }

        function renderGrid() {
            const reelsContainer = document.getElementById('slotReels');
            const cols = Array.from(reelsContainer.children);
            for (let col = 0; col < REELS; col++) {
                const colEl = cols[col];
                const slots = Array.from(colEl.children);
                for (let row = 0; row < ROWS; row++) {
                    const slotEl = slots[row];
                    const symbolId = currentGrid[col][row];
                    const symbolData = SYMBOLS.find(s => s.id === symbolId);
                    slotEl.innerHTML = `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3E${symbolData.emoji}%3C/text%3E%3C/svg%3E" alt="${symbolId}">`;
                }
            }
        }

        function updateColumnSymbols(colIndex, newSymbols, spin) {
            currentGrid[colIndex] = newSymbols;
            const reelsContainer = document.getElementById('slotReels');
            const colEl = reelsContainer.children[colIndex];
            const slots = Array.from(colEl.children);
            for (let row = 0; row < ROWS; row++) {
                const slotEl = slots[row];
                const symbolId = newSymbols[row];
                const symbolData = SYMBOLS.find(s => s.id === symbolId);
                slotEl.innerHTML = `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3E${symbolData.emoji}%3C/text%3E%3C/svg%3E" alt="${symbolId}">`;
                if (spin) {
                    slotEl.classList.add('spinning');
                } else {
                    slotEl.classList.remove('spinning');
                }
            }
        }

        function clearWinHighlights() {
            document.querySelectorAll('.slot-symbol').forEach(el => el.classList.remove('winning'));
        }

        function highlightWins(positions) {
            const reelsContainer = document.getElementById('slotReels');
            positions.forEach(pos => {
                const colEl = reelsContainer.children[pos.col];
                const slotEl = colEl.children[pos.row];
                slotEl.classList.add('winning');
            });
        }

        function evaluateGrid(bet) {
            let totalWin = 0;
            let freeSpinsAwarded = 0;
            let squarioCount = 0;
            let winPositions = [];

            for (let row = 0; row < ROWS; row++) {
                let firstSymbol = currentGrid[0][row];
                let count = 1;
                let positions = [{ col: 0, row }];

                for (let col = 1; col < REELS; col++) {
                    if (currentGrid[col][row] === firstSymbol) {
                        count++;
                        positions.push({ col, row });
                    } else {
                        break;
                    }
                }

                if (firstSymbol === 'squario') {
                    squarioCount += count;
                }

                if (firstSymbol === 'powerup' && count >= 3) {
                    if (count === 3) freeSpinsAwarded += 5;
                    else if (count === 4) freeSpinsAwarded += 10;
                    else if (count === 5) {
                        freeSpinsAwarded += 20;
                        superWildSpinsRemaining = 3;
                    }
                    winPositions = winPositions.concat(positions);
                }

                if (count >= 3 && PAYTABLE[firstSymbol]) {
                    const multiplier = PAYTABLE[firstSymbol][count.toString()] || 0;
                    totalWin += bet * multiplier;
                    winPositions = winPositions.concat(positions);
                }
            }

            if (winPositions.length > 0) {
                highlightWins(winPositions);
            }

            return { totalWin, freeSpinsAwarded, squarioCount };
        }

        async function logSpinToFirestore(bet, win, grid, wasFreeSpin) {
            if (!userId) return;
            try {
                const spinData = {
                    userId,
                    playerName,
                    bet,
                    win,
                    profit: win - (wasFreeSpin ? 0 : bet),
                    grid,
                    freeSpin: wasFreeSpin,
                    timestamp: new Date()
                };
                await addDoc(collection(db, 'squarioSlots_spins'), spinData);
            } catch (error) {
                console.error('Log error:', error);
            }
        }

        function launchBonusGame(squarioCount, bet) {
            bonusActive = true;
            playBonusOpen();

            const overlay = document.createElement('div');
            overlay.className = 'bonus-overlay';

            const windowEl = document.createElement('div');
            windowEl.className = 'bonus-window';

            const title = document.createElement('div');
            title.className = 'bonus-title';
            title.textContent = 'SQUARIO BONUS';

            const subtitle = document.createElement('div');
            subtitle.className = 'bonus-subtitle';
            subtitle.textContent = `Pick ${squarioCount} blocks!`;

            const contents = document.createElement('div');
            const grid = document.createElement('div');
            grid.className = 'bonus-grid';

            const prizes = [
                bet * 5, bet * 10, bet * 15, bet * 20, bet * 25,
                bet * 30, bet * 50, bet * 100, bet * 200
            ];
            for (let i = prizes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [prizes[i], prizes[j]] = [prizes[j], prizes[i]];
            }

            let chosen = 0;
            let bonusTotal = 0;

            for (let i = 0; i < 9; i++) {
                const block = document.createElement('div');
                block.className = 'bonus-block';
                block.dataset.value = prizes[i].toLocaleString();

                block.addEventListener('click', () => {
                    if (chosen >= squarioCount || block.classList.contains('revealed')) return;
                    block.classList.add('revealed');
                    chosen++;
                    bonusTotal += prizes[i];
                    beep(800 + chosen * 100, 150, 0.15);

                    if (chosen === squarioCount) {
                        setTimeout(() => {
                            showMessage('BONUS WIN!', `+${bonusTotal.toLocaleString()} G`);
                            updateBalance(bonusTotal);
                            lastWinAmount += bonusTotal;
                            sessionTotalWin += bonusTotal;
                            updateStatsDisplay();
                        }, 500);
                    }
                });

                grid.appendChild(block);
            }

            contents.appendChild(grid);
            windowEl.appendChild(title);
            windowEl.appendChild(subtitle);
            windowEl.appendChild(contents);
            overlay.appendChild(windowEl);
            document.body.appendChild(overlay);

            overlay.addEventListener('click', () => {
                if (!chosen) return;
                overlay.remove();
                bonusActive = false;

                if (freeSpinsRemaining > 0 && !spinning) {
                    setTimeout(() => handleSpinClick(), 800);
                }
            });
        }

        async function handleSpinClick() {
            if (spinning || bonusActive || !userId) return;

            const handle = document.getElementById('slotHandle');
            handle.classList.add('pulled');
            setTimeout(() => handle.classList.remove('pulled'), 600);

            const betInput = document.getElementById('betAmount');
            let bet = parseInt(betInput.value, 10);
            if (isNaN(bet) || bet < 1) {
                showMessage('MINIMUM BET IS 1');
                return;
            }

            const usingFreeSpin = freeSpinsRemaining > 0;

            if (!usingFreeSpin && bet > balance) {
                showMessage('INSUFFICIENT FUNDS');
                return;
            }

            if (!usingFreeSpin) {
                updateBalance(-bet);
            } else {
                freeSpinsRemaining--;
                updateFreeSpinBadge();
            }

            if (superWildSpinsRemaining > 0) {
                superWildSpinsRemaining--;
            }

            spinning = true;
            lastWinAmount = 0;
            clearWinHighlights();
            updateStatsDisplay();
            playSpinStart();

            const reelsContainer = document.getElementById('slotReels');
            const cols = Array.from(reelsContainer.children);

            cols.forEach((colEl, colIndex) => {
                const newSymbols = [];
                for (let row = 0; row < ROWS; row++) {
                    newSymbols[row] = getRandomSymbol();
                }
                updateColumnSymbols(colIndex, newSymbols, true);
            });

            const duration = spinDuration;
            await new Promise(resolve => {
                let colIndex = 0;
                function stopNext() {
                    if (colIndex >= REELS) {
                        resolve();
                        return;
                    }
                    const finalSymbols = [];
                    for (let row = 0; row < ROWS; row++) {
                        finalSymbols[row] = getRandomSymbol();
                    }
                    updateColumnSymbols(colIndex, finalSymbols, false);
                    playReelStop();
                    colIndex++;
                    setTimeout(stopNext, duration * 250);
                }
                setTimeout(stopNext, duration * 250);
            });

            const result = evaluateGrid(bet);
            lastWinAmount = result.totalWin;
            sessionTotalWin += result.totalWin;
            updateStatsDisplay();

            if (result.totalWin > 0) {
                if (result.totalWin >= bet * 20) {
                    playBigWin();
                    showMessage('BIG WIN!', `+${result.totalWin.toLocaleString()} G`);
                } else {
                    playWin();
                    showMessage('WIN!', `+${result.totalWin.toLocaleString()} G`);
                }
                updateBalance(result.totalWin);
            } else if (!usingFreeSpin && result.freeSpinsAwarded === 0) {
                playLose();
            }

            const simpleGrid = currentGrid.map(col => col.slice());
            logSpinToFirestore(bet, result.totalWin, simpleGrid, usingFreeSpin);

            if (result.squarioCount >= 3) {
                setTimeout(() => launchBonusGame(result.squarioCount, bet), 600);
            } else if (result.freeSpinsAwarded > 0) {
                freeSpinsRemaining += result.freeSpinsAwarded;
                updateFreeSpinBadge();
                playBonusOpen();
                showMessage('POWER-UP FREE SPINS!', `+${result.freeSpinsAwarded} FREE SPINS`);
            }

            spinning = false;

            if (!bonusActive && freeSpinsRemaining > 0) {
                setTimeout(() => handleSpinClick(), 900);
            }
        }

        async function initGameSystem() {
            const savedTheme = localStorage.getItem('blackjack_theme');
            if (savedTheme) selectedTable = savedTheme;
            document.getElementById('tableSelect').value = selectedTable;
            applyTableVisuals();

            try {
                auth = getAuth(db.app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        playerName = user.displayName || "Player";
                        document.getElementById('playerLabel').textContent = playerName.toUpperCase();

                        await loadUserBalance();
                        initGrid();

                        document.getElementById('loadingMsg').style.display = 'none';
                        document.getElementById('startGame').style.display = 'block';
                    } else {
                        window.location.href = '/index.html';
                    }
                });
            } catch (error) {
                console.warn('Auth Check Failed:', error);
            }
        }

        document.getElementById('startGame').addEventListener('click', () => {
            document.getElementById('tableSelector').classList.add('hidden');
            if (audioContext.state === 'suspended') audioContext.resume();
        });

        document.getElementById('spinBtn').addEventListener('click', handleSpinClick);
        document.getElementById('slotHandle').addEventListener('click', handleSpinClick);

        document.getElementById('maxBetBtn').addEventListener('click', () => {
            if (balance <= 0) return;
            const betInput = document.getElementById('betAmount');
            const maxBet = Math.max(1, Math.floor(balance / 5));
            betInput.value = maxBet;
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('active');
        });
        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('active');
        });

        document.getElementById('soundToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            soundEnabled = this.classList.contains('active');
        });

        document.getElementById('speedSelect').addEventListener('change', function() {
            spinDuration = parseFloat(this.value) || 0.45;
        });

        document.getElementById('tableSelect').addEventListener('change', function() {
            selectedTable = this.value;
            localStorage.setItem('blackjack_theme', selectedTable);
            applyTableVisuals();
        });

        initGameSystem();
    </script>
</body>
</html>
