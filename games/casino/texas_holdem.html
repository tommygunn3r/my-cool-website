<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GunnersGames Texas Hold'em</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold: #d4af37;
            --gold-dark: #b8941f;
            --gold-light: #f4e5a7;
            --cream: #f5f3e8;
            --dark: #1a1410;
            --red: #8b0000;
            --green: #0a4a2e;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            background-color: #0a4a2e;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            user-select: none;
        }

        /* --- Start Screen --- */
        #tableSelector {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.5s, visibility 0.5s;
        }
        #tableSelector.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .selector-title {
            font-family: 'Cinzel', serif; font-size: 3.5rem; font-weight: 700; color: var(--gold);
            margin-bottom: 1rem; text-shadow: 0 0 20px rgba(212, 175, 55, 0.5); letter-spacing: 0.1em;
            text-align: center;
        }

        .loading-text { 
            color: var(--gold); font-family: 'Cinzel', serif; font-size: 1.2rem;
            margin-top: 20px; animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .start-button {
            font-family: 'Cinzel', serif; font-size: 1.5rem; padding: 1rem 4rem; margin-top: 2rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark); border: none; border-radius: 50px; cursor: pointer; font-weight: 600;
            letter-spacing: 0.1em; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            display: none;
        }
        .start-button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.6); }

        /* --- Game Interface --- */
        #gameContainer {
            width: 100vw; height: 100vh;
            display: flex; flex-direction: column; position: relative;
        }

        .header {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.0) 100%);
            flex-shrink: 0; z-index: 10;
        }
        .logo {
            font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; color: var(--gold);
            letter-spacing: 0.15em; text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
        }
        .balance-container { display: flex; flex-direction: column; align-items: flex-end; }
        .balance { display: flex; align-items: center; gap: 0.5rem; font-size: 1.4rem; color: var(--cream); font-weight: 600; }
        .coin-icon {
            width: 30px; height: 30px; background: radial-gradient(circle, var(--gold-light) 0%, var(--gold) 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: var(--dark); font-size: 1rem; box-shadow: 0 2px 10px rgba(212, 175, 55, 0.5);
        }

        /* --- Poker Table Layout --- */
        .poker-table {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
        }

        /* Community Cards */
        .community-area {
            display: flex; gap: 10px; padding: 20px; background: rgba(0,0,0,0.3);
            border-radius: 100px; border: 2px solid rgba(212, 175, 55, 0.3);
            min-height: 140px; min-width: 480px; justify-content: center; align-items: center;
        }

        /* Pot Display */
        .pot-display {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Cinzel', serif; color: var(--gold-light); font-size: 1.2rem;
            background: rgba(0,0,0,0.6); padding: 5px 20px; border-radius: 20px;
            border: 1px solid var(--gold); text-shadow: 0 0 5px var(--gold);
            transition: all 0.3s;
        }

        /* Cards */
        .card {
            width: 80px; height: 112px; position: relative; transform-style: preserve-3d;
            transition: transform 0.6s; cursor: default; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-radius: 6px;
        }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 6px;
        }
        .card-back { background-size: cover; background-position: center; border: 1px solid #fff; }
        .card-front {
            background: white; transform: rotateY(180deg); display: flex; flex-direction: column;
            justify-content: space-between; padding: 5px; font-family: 'Cinzel', serif; font-weight: 600;
        }
        .card.flipped { transform: rotateY(180deg); }
        .card-value { font-size: 1.2rem; line-height: 1; }
        .card-suit { font-size: 1.8rem; text-align: center; line-height: 1; }
        .hearts, .diamonds { color: #dc143c; }
        .clubs, .spades { color: #000; }
        .card.folded { filter: grayscale(1) brightness(0.6); transform: rotateY(180deg) scale(0.9); opacity: 0.7; }

        /* Player Areas */
        .seat {
            position: absolute; display: flex; flex-direction: column; align-items: center;
            width: 180px; transition: all 0.3s;
        }
        .seat-name {
            background: rgba(0,0,0,0.8); color: var(--gold); padding: 4px 15px; border-radius: 15px;
            border: 1px solid var(--gold); font-family: 'Cinzel', serif; font-size: 0.9rem; margin-bottom: 5px;
            position: relative; z-index: 2; display: flex; justify-content: space-between; width: 100%;
        }
        .seat-chips { font-size: 0.8rem; color: var(--cream); margin-left: 5px; }
        .seat-hand { display: flex; gap: 5px; height: 112px; justify-content: center; }
        .seat-action {
            position: absolute; top: -30px; background: var(--gold); color: var(--dark);
            padding: 2px 10px; border-radius: 10px; font-weight: bold; font-family: 'Cinzel', serif;
            font-size: 0.8rem; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .dealer-button {
            width: 20px; height: 20px; background: white; color: black; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem;
            position: absolute; top: 50px; left: -25px; border: 2px solid black; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Positioning Seats around table */
        #seat-0 { bottom: 120px; left: 50%; transform: translateX(-50%); } 
        #seat-1 { top: 120px; left: 10%; }
        #seat-2 { top: 40px; left: 50%; transform: translateX(-50%); }
        #seat-3 { top: 120px; right: 10%; }

        /* Active Player Highlight */
        .seat.active-turn .seat-name {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark); box-shadow: 0 0 15px var(--gold);
        }

        /* Controls */
        .controls {
            position: absolute; bottom: 0; left: 0; width: 100%;
            display: flex; justify-content: center; align-items: center; gap: 1rem; padding: 1.5rem;
            background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 100%);
            border-top: 2px solid var(--gold); z-index: 20;
        }
        .controls-group { display: flex; gap: 10px; align-items: center; }
        
        .game-button {
            font-family: 'Cinzel', serif; font-size: 1rem; padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark); border: none; border-radius: 25px; cursor: pointer; font-weight: 600;
            letter-spacing: 0.05em; transition: all 0.3s ease; box-shadow: 0 3px 10px rgba(212, 175, 55, 0.3);
        }
        .game-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.5); }
        .game-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .game-button.fold-btn { background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%); color: white; }
        .game-button.call-btn { background: linear-gradient(135deg, #0a4a2e 0%, #063020 100%); color: white; }

        #playerControls { display: none; }
        
        /* Raise Controls */
        .raise-controls {
            display: none; flex-direction: column; align-items: center; gap: 5px;
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 15px;
            border: 1px solid var(--gold);
        }
        .raise-controls.active { display: flex; }
        .raise-label { font-family: 'Cinzel', serif; color: var(--gold); font-size: 0.9rem; }
        .raise-amount { font-family: 'Cinzel', serif; color: var(--cream); font-size: 1.2rem; font-weight: bold; }
        #raiseSlider {
            width: 200px; height: 6px; border-radius: 5px; background: rgba(212, 175, 55, 0.3);
            outline: none; -webkit-appearance: none; cursor: pointer;
        }
        #raiseSlider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px; border-radius: 50%;
            background: var(--gold); cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Settings */
        .settings-btn {
            position: absolute; top: 1rem; right: 2rem; background: rgba(0,0,0,0.6);
            border: 1px solid var(--gold); border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s; z-index: 100;
        }
        .settings-btn:hover { background: rgba(212, 175, 55, 0.2); transform: rotate(45deg); }
        .settings-icon { color: var(--gold); font-size: 1.5rem; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center; z-index: 200;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            border: 2px solid var(--gold); border-radius: 20px; padding: 2rem;
            max-width: 500px; width: 90%;
        }
        .modal-title {
            font-family: 'Cinzel', serif; font-size: 2rem; color: var(--gold);
            margin-bottom: 1.5rem; text-align: center;
        }
        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 0; border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }
        .setting-label { font-family: 'Cinzel', serif; color: var(--cream); font-size: 1.1rem; }
        select, .toggle-btn {
            font-family: 'Cormorant Garamond', serif; padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.5); color: var(--gold); border: 1px solid var(--gold);
            border-radius: 10px; cursor: pointer; font-size: 1rem;
        }
        .toggle-btn { background: rgba(139, 0, 0, 0.5); transition: all 0.3s; }
        .toggle-btn.active { background: rgba(10, 74, 46, 0.8); }
        .close-btn {
            margin-top: 1.5rem; width: 100%; font-family: 'Cinzel', serif; font-size: 1.2rem;
            padding: 0.8rem; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark); border: none; border-radius: 15px; cursor: pointer; font-weight: 600;
        }

        .message-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Cinzel', serif; font-size: 3rem; color: var(--gold);
            background: rgba(0,0,0,0.9); padding: 2rem 4rem; border-radius: 20px;
            border: 2px solid var(--gold); text-shadow: 0 0 20px var(--gold);
            animation: fadeInOut 2s; pointer-events: none; z-index: 300;
        }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } }

        @media (max-width: 768px) {
            .selector-title { font-size: 2rem; }
            .start-button { font-size: 1.2rem; padding: 0.8rem 2rem; }
            .seat { width: 120px; }
            .card { width: 60px; height: 84px; }
            .controls { padding: 1rem; gap: 0.5rem; }
            .game-button { font-size: 0.9rem; padding: 0.6rem 1rem; }
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="tableSelector">
        <div class="selector-title">TEXAS HOLD'EM</div>
        <div class="loading-text">Connecting to table...</div>
        <button class="start-button" id="startGame">JOIN TABLE</button>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="logo">GUNNERSGAMES</div>
            <div class="balance-container">
                <div class="balance">
                    <div class="coin-icon">G</div>
                    <span id="balanceDisplay">0</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--gold); margin-top: 5px;">
                    Table: <span id="playerChipsDisplay">2000</span>
                </div>
            </div>
        </div>

        <!-- Settings Button -->
        <div class="settings-btn" id="settingsBtn">
            <div class="settings-icon">⚙</div>
        </div>

        <!-- Poker Table -->
        <div class="poker-table">
            <!-- Pot Display -->
            <div class="pot-display" id="potDisplay">POT: 0</div>

            <!-- Community Cards -->
            <div class="community-area" id="communityArea"></div>

            <!-- Player Seats -->
            <div class="seat" id="seat-0">
                <div class="seat-action" id="action-0"></div>
                <div class="seat-name">
                    <span>YOU</span>
                    <span class="seat-chips" id="chips-0">2000</span>
                </div>
                <div class="seat-hand" id="hand-0"></div>
            </div>

            <div class="seat" id="seat-1">
                <div class="seat-action" id="action-1"></div>
                <div class="seat-name">
                    <span id="name-1">AI Player 1</span>
                    <span class="seat-chips" id="chips-1">2000</span>
                </div>
                <div class="seat-hand" id="hand-1"></div>
            </div>

            <div class="seat" id="seat-2">
                <div class="seat-action" id="action-2"></div>
                <div class="seat-name">
                    <span id="name-2">AI Player 2</span>
                    <span class="seat-chips" id="chips-2">2000</span>
                </div>
                <div class="seat-hand" id="hand-2"></div>
            </div>

            <div class="seat" id="seat-3">
                <div class="seat-action" id="action-3"></div>
                <div class="seat-name">
                    <span id="name-3">AI Player 3</span>
                    <span class="seat-chips" id="chips-3">2000</span>
                </div>
                <div class="seat-hand" id="hand-3"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls" id="playerControls">
            <div class="controls-group">
                <button class="game-button fold-btn" id="btnFold">FOLD</button>
                <button class="game-button call-btn" id="btnCheckCall">CALL</button>
                <button class="game-button" id="btnRaise">RAISE</button>
            </div>
            <div class="raise-controls" id="raiseContainer">
                <div class="raise-label">RAISE AMOUNT</div>
                <div class="raise-amount" id="raiseAmountDisplay">50</div>
                <input type="range" id="raiseSlider" min="50" max="500" value="50" step="10">
                <button class="game-button" id="btnConfirmRaise">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">SETTINGS</div>
            <div class="setting-row">
                <div class="setting-label">Sound</div>
                <button class="toggle-btn active" id="soundToggle">ON</button>
            </div>
            <div class="setting-row">
                <div class="setting-label">Game Speed</div>
                <select id="speedSelect">
                    <option value="1000">Normal</option>
                    <option value="500">Fast</option>
                    <option value="2000">Slow</option>
                </select>
            </div>
            <div class="setting-row">
                <div class="setting-label">Table Theme</div>
                <select id="tableSelect">
                    <option value="classic">Classic Green</option>
                    <option value="royal">Royal Purple</option>
                    <option value="midnight">Midnight Blue</option>
                    <option value="crimson">Crimson Red</option>
                </select>
            </div>
            <button class="close-btn" id="closeSettings">CLOSE</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ============================================
        // SUPABASE INTEGRATION
        // ============================================
        const SUPABASE_URL = "https://pknhslxhpohrzgsfkisr.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_-zZw-pi_3q1sdNGhITKuhQ_ECyDARzc";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let userId = null;
        let currentBalance = 0;
        let playerName = 'Guest';

        async function initSupabase() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    console.error('No authenticated user found');
                    document.querySelector('.loading-text').textContent = 'Please sign in to play';
                    return false;
                }

                userId = user.id;
                console.log('✅ User authenticated:', userId);

                // Fetch user profile for balance
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('gunnercoins, player_name')
                    .eq('id', userId)
                    .single();

                if (profileError) {
                    console.error('Error fetching profile:', profileError);
                    document.querySelector('.loading-text').textContent = 'Error loading profile';
                    return false;
                }

                currentBalance = profile.gunnercoins || 0;
                playerName = profile.player_name || 'Player';
                document.getElementById('balanceDisplay').textContent = currentBalance;
                console.log('✅ Balance loaded:', currentBalance);

                if (currentBalance >= 2000) {
                    document.querySelector('.loading-text').textContent = 'Ready to play!';
                    document.getElementById('startGame').style.display = 'block';
                } else {
                    document.querySelector('.loading-text').textContent = `Insufficient balance (need 2000 coins, you have ${currentBalance})`;
                }

                return true;
            } catch (err) {
                console.error('Supabase init error:', err);
                document.querySelector('.loading-text').textContent = 'Connection error';
                return false;
            }
        }

        async function updateBalance(amount) {
            if (!userId) {
                console.error('No user ID - cannot update balance');
                return;
            }
            
            try {
                const newBalance = currentBalance + amount;

                const { error } = await supabase
                    .from('profiles')
                    .update({ gunnercoins: newBalance })
                    .eq('id', userId);

                if (error) {
                    console.error('Error updating balance:', error);
                } else {
                    currentBalance = newBalance;
                    document.getElementById('balanceDisplay').textContent = currentBalance;
                    console.log(`✅ Balance updated: ${amount > 0 ? '+' : ''}${amount} (new: ${newBalance})`);
                }
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }

        // ============================================
        // GAME LOGIC
        // ============================================
        let gameSpeed = 1000;
        let soundEnabled = true;
        const sfx = {
            deal: () => soundEnabled && playTone(300, 100),
            bet: () => soundEnabled && playTone(400, 150),
            win: () => soundEnabled && playTone(600, 300),
            fold: () => soundEnabled && playTone(200, 200)
        };

        function playTone(freq, dur) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur / 1000);
            osc.start();
            osc.stop(ctx.currentTime + dur / 1000);
        }

        const suits = ['♠','♥','♦','♣'];
        const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        
        let deck, communityCards = [], pot = 0, currentBet = 0, dealerIndex = 0, turnIndex = 0;
        let players = [
            { id: 0, name: 'YOU', chips: 2000, hand: [], currentBet: 0, folded: false },
            { id: 1, name: 'AI Player 1', chips: 2000, hand: [], currentBet: 0, folded: false },
            { id: 2, name: 'AI Player 2', chips: 2000, hand: [], currentBet: 0, folded: false },
            { id: 3, name: 'AI Player 3', chips: 2000, hand: [], currentBet: 0, folded: false }
        ];

        const tableThemes = {
            classic: { bg: 'linear-gradient(135deg, #0a4a2e 0%, #064030 100%)' },
            royal: { bg: 'linear-gradient(135deg, #4a0e4e 0%, #2d0a30 100%)' },
            midnight: { bg: 'linear-gradient(135deg, #0a1e4a 0%, #061430 100%)' },
            crimson: { bg: 'linear-gradient(135deg, #4a0e0e 0%, #300a0a 100%)' }
        };

        function applyTableVisuals(theme) {
            document.body.style.background = tableThemes[theme].bg;
        }

        async function initSystem() {
            const savedTheme = localStorage.getItem('poker_theme') || 'classic';
            applyTableVisuals(savedTheme);
            document.getElementById('tableSelect').value = savedTheme;

            await initSupabase();
        }

        async function startGame() {
            // Check if we have enough balance
            if (currentBalance < 2000) {
                alert('Insufficient balance! You need 2000 coins to play.');
                return;
            }

            // Deduct buy-in
            await updateBalance(-2000);
            
            document.getElementById('tableSelector').classList.add('hidden');
            document.getElementById('gameContainer').style.display = 'flex';
            startNewHand();
        }

        function startNewHand() {
            deck = [];
            for(let s of suits) for(let v of values) deck.push({suit: s, value: v});
            deck.sort(() => Math.random() - 0.5);

            communityCards = [];
            pot = 0;
            currentBet = 0;
            
            players.forEach(p => {
                p.hand = [];
                p.currentBet = 0;
                p.folded = false;
                document.getElementById(`seat-${p.id}`).classList.remove('active-turn');
                const btn = document.querySelector(`#seat-${p.id} .dealer-button`);
                if(btn) btn.remove();
            });

            document.getElementById('communityArea').innerHTML = '';
            renderPot();

            dealerIndex = (dealerIndex + 1) % players.length;
            const dealerBtn = document.createElement('div');
            dealerBtn.className = 'dealer-button';
            dealerBtn.innerText = 'D';
            document.getElementById(`seat-${dealerIndex}`).appendChild(dealerBtn);

            // Deal 2 cards to each
            for(let i = 0; i < 2; i++) {
                players.forEach(p => {
                    p.hand.push(deck.pop());
                    renderHand(p.id, p.id === 0);
                });
            }
            sfx.deal();

            // Blinds
            const sbIdx = (dealerIndex + 1) % players.length;
            const bbIdx = (dealerIndex + 2) % players.length;
            placeBet(sbIdx, 10);
            placeBet(bbIdx, 20);
            currentBet = 20;

            turnIndex = (bbIdx + 1) % players.length;
            processTurn();
        }

        function placeBet(pid, amt) {
            const p = players[pid];
            const actual = Math.min(amt, p.chips);
            p.chips -= actual;
            p.currentBet += actual;
            pot += actual;
            updatePlayerUI(pid);
            renderPot();
        }

        function processTurn() {
            players.forEach(p => document.getElementById(`seat-${p.id}`).classList.remove('active-turn'));
            const p = players[turnIndex];
            if(p.folded || p.chips === 0) {
                nextTurn();
                return;
            }
            document.getElementById(`seat-${p.id}`).classList.add('active-turn');

            if(turnIndex === 0) {
                enableControls();
            } else {
                setTimeout(() => aiDecide(turnIndex), gameSpeed);
            }
        }

        function nextTurn() {
            const startIdx = turnIndex;
            do {
                turnIndex = (turnIndex + 1) % players.length;
            } while(players[turnIndex].folded || players[turnIndex].chips === 0);

            if(turnIndex === startIdx || everyoneCalled()) {
                checkEndConditions();
            } else {
                processTurn();
            }
        }

        function everyoneCalled() {
            const active = players.filter(p => !p.folded && p.chips > 0);
            return active.every(p => p.currentBet === currentBet);
        }

        function finishTurn() {
            players.forEach(p => p.currentBet = 0);
            currentBet = 0;
            renderPot();

            if(communityCards.length === 0) {
                dealCommunity(3);
                setTimeout(() => startBettingRound(), gameSpeed);
            } else if(communityCards.length === 3) {
                dealCommunity(1);
                setTimeout(() => startBettingRound(), gameSpeed);
            } else if(communityCards.length === 4) {
                dealCommunity(1);
                setTimeout(() => startBettingRound(), gameSpeed);
            } else {
                showdown();
            }
        }

        function dealCommunity(n) {
            for(let i = 0; i < n; i++) {
                const c = deck.pop();
                communityCards.push(c);
                const el = createCardEl(c);
                el.classList.remove('flipped');
                document.getElementById('communityArea').appendChild(el);
                setTimeout(() => el.classList.add('flipped'), 100 * i);
            }
            sfx.deal();
        }

        function startBettingRound() {
            turnIndex = (dealerIndex + 1) % players.length;
            processTurn();
        }

        function doFold() {
            sfx.fold();
            players[0].folded = true;
            players[0].hand.forEach(c => {
                const cards = document.querySelectorAll(`#hand-0 .card`);
                cards.forEach(el => el.classList.add('folded'));
            });
            showActionBubble(0, "FOLD");
            nextTurn();
        }

        function doCheck() {
            showActionBubble(0, "CHECK");
            nextTurn();
        }

        function doCall() {
            const p = players[0];
            const toCall = currentBet - p.currentBet;
            placeBet(0, toCall);
            sfx.bet();
            showActionBubble(0, `CALL ${toCall}`);
            nextTurn();
        }

        function doRaise(amt) {
            const p = players[0];
            const total = currentBet + amt;
            const needed = total - p.currentBet;
            placeBet(0, needed);
            currentBet = total;
            sfx.bet();
            showActionBubble(0, `RAISE ${amt}`);
            nextTurn();
        }

        function aiDecide(pid) {
            const p = players[pid];
            const toCall = currentBet - p.currentBet;
            const rand = Math.random();

            if(toCall === 0) {
                if(rand < 0.3) {
                    const raise = Math.min(50, p.chips);
                    placeBet(pid, raise);
                    currentBet = Math.max(currentBet, p.currentBet);
                    sfx.bet();
                    showActionBubble(pid, `RAISE ${raise}`);
                } else {
                    showActionBubble(pid, "CHECK");
                }
            } else {
                if(rand < 0.2) {
                    p.folded = true;
                    sfx.fold();
                    showActionBubble(pid, "FOLD");
                } else if(rand < 0.7) {
                    placeBet(pid, toCall);
                    sfx.bet();
                    showActionBubble(pid, `CALL ${toCall}`);
                } else {
                    const raise = Math.min(50, p.chips - toCall);
                    placeBet(pid, toCall + raise);
                    currentBet += raise;
                    sfx.bet();
                    showActionBubble(pid, `RAISE ${raise}`);
                }
            }

            setTimeout(nextTurn, gameSpeed / 2);
        }

        async function checkEndConditions() {
            const active = players.filter(p => !p.folded);
            if(active.length === 1) {
                await givePotTo(active[0].id);
            } else {
                finishTurn();
            }
        }

        async function showdown() {
            players.forEach(p => {
                if(!p.folded) renderHand(p.id, true);
            });

            const active = players.filter(p => !p.folded);
            active.forEach(p => {
                p.eval = getBestHand(p.hand, communityCards);
            });

            active.sort((a,b) => {
                if(b.eval.score !== a.eval.score) return b.eval.score - a.eval.score;
                return b.eval.high - a.eval.high;
            });

            const winner = active[0];
            showActionBubble(winner.id, winner.eval.type + "!");
            setTimeout(async () => await givePotTo(winner.id), 2000);
        }

        async function givePotTo(id) {
            sfx.win();
            const p = players[id];
            p.chips += pot;
            pot = 0;
            renderPot();
            updatePlayerUI(id);
            showMessage(`${p.name} WINS!`);
            
            // Sync winnings back to balance if human player wins
            if(id === 0) {
                const netChange = p.chips - 2000;
                if(netChange !== 0) {
                    await updateBalance(netChange);
                    // Reset to starting stack for next hand
                    players[0].chips = 2000;
                }
            }
            
            setTimeout(startNewHand, 4000);
        }

        function createCardEl(c) {
            const el = document.createElement('div');
            el.className = `card flipped`;
            const cls = (c.suit==='♥'||c.suit==='♦') ? 'hearts' : 'clubs';
            el.innerHTML = `
                <div class="card-back" style="background-image: url('/games/assets/casino/card_back.png');"></div>
                <div class="card-front">
                    <div class="card-value ${cls}">${c.value}</div>
                    <div class="card-suit ${cls}">${c.suit}</div>
                    <div class="card-value ${cls}" style="transform: rotate(180deg);">${c.value}</div>
                </div>`;
            return el;
        }

        function renderHand(pid, reveal) {
            const container = document.getElementById(`hand-${pid}`);
            container.innerHTML = '';
            players[pid].hand.forEach(c => {
                const el = createCardEl(c);
                if(!reveal && pid !== 0) {
                    el.classList.remove('flipped');
                }
                container.appendChild(el);
            });
        }

        function updatePlayerUI(pid) {
            const p = players[pid];
            if(pid === 0) {
                document.getElementById('playerChipsDisplay').innerText = p.chips;
            } else {
                document.querySelector(`#seat-${pid} .seat-chips`).innerText = p.chips;
            }
        }

        function renderPot() {
            document.getElementById('potDisplay').innerText = `POT: ${pot} (BET: ${currentBet})`;
        }

        function showActionBubble(pid, text) {
            const el = document.getElementById(`action-${pid}`);
            el.innerText = text;
            el.style.opacity = '1';
            el.style.top = '-40px';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.top = '-30px';
            }, 1500);
        }

        function showMessage(txt) {
            const el = document.createElement('div');
            el.className = 'message-overlay'; el.innerText = txt;
            document.getElementById('gameContainer').appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        function enableControls() {
            const p = players[0];
            const toCall = currentBet - p.currentBet;
            
            document.getElementById('playerControls').style.display = 'flex';
            document.getElementById('btnCheckCall').innerText = toCall === 0 ? "CHECK" : `CALL ${toCall}`;
            document.getElementById('raiseContainer').style.display = 'none';
        }

        function disableControls() {
            document.getElementById('playerControls').style.display = 'none';
        }

        // Hand Evaluation
        function getBestHand(hand, community) {
            const all = [...hand, ...community];
            const combos = getCombinations(all, 5);
            let best = { score: 0, high: 0, type: "High Card" };
            
            for(let combo of combos) {
                const ev = evaluateHand(combo);
                if(ev.score > best.score || (ev.score === best.score && ev.high > best.high)) {
                    best = ev;
                }
            }
            return best;
        }

        function getCombinations(arr, k) {
            if(k === 1) return arr.map(x => [x]);
            const res = [];
            for(let i = 0; i <= arr.length - k; i++) {
                const sub = getCombinations(arr.slice(i+1), k-1);
                sub.forEach(s => res.push([arr[i], ...s]));
            }
            return res;
        }

        function evaluateHand(cards) {
            const vals = cards.map(c => values.indexOf(c.value));
            const sorted = vals.sort((a,b) => b - a);
            const counts = {};
            sorted.forEach(v => counts[v] = (counts[v] || 0) + 1);
            const unique = Object.keys(counts).map(Number).sort((a,b) => b - a);
            const isFlush = cards.every(c => c.suit === cards[0].suit);
            const isStraight = sorted[0] - sorted[4] === 4 && new Set(sorted).size === 5;

            if(isStraight && isFlush) return { score: 8, high: sorted[0], type: "Straight Flush" };
            if(Object.values(counts).includes(4)) return { score: 7, high: sorted[0], type: "Four of a Kind" };
            if(Object.values(counts).includes(3) && Object.values(counts).includes(2)) return { score: 6, high: sorted[0], type: "Full House" };
            if(isFlush) return { score: 5, high: sorted[0], type: "Flush" };
            if(isStraight) return { score: 4, high: sorted[0], type: "Straight" };
            if(Object.values(counts).includes(3)) return { score: 3, high: sorted[0], type: "Three of a Kind" };
            if(Object.values(counts).filter(x => x === 2).length === 2) return { score: 2, high: sorted[0], type: "Two Pair" };
            if(Object.values(counts).includes(2)) return { score: 1, high: sorted[0], type: "Pair" };
            return { score: 0, high: sorted[0], type: "High Card" };
        }

        // Event Listeners
        document.getElementById('startGame').addEventListener('click', startGame);
        document.getElementById('btnFold').addEventListener('click', () => { disableControls(); doFold(); });
        document.getElementById('btnCheckCall').addEventListener('click', () => {
            disableControls();
            const p = players[0];
            const toCall = currentBet - p.currentBet;
            if(toCall === 0) doCheck(); else doCall();
        });
        document.getElementById('btnRaise').addEventListener('click', () => {
            document.getElementById('raiseContainer').style.display = 'flex';
        });
        document.getElementById('raiseSlider').addEventListener('input', (e) => {
            document.getElementById('raiseAmountDisplay').innerText = e.target.value;
        });
        document.getElementById('btnConfirmRaise').addEventListener('click', () => {
            disableControls();
            const amt = parseInt(document.getElementById('raiseSlider').value);
            doRaise(amt);
        });
        document.getElementById('settingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.add('active'));
        document.getElementById('closeSettings').addEventListener('click', () => document.getElementById('settingsModal').classList.remove('active'));
        document.getElementById('soundToggle').addEventListener('click', function() { 
            this.classList.toggle('active'); 
            soundEnabled = this.classList.contains('active'); 
        });
        document.getElementById('speedSelect').addEventListener('change', function() { gameSpeed = parseInt(this.value); });
        document.getElementById('tableSelect').addEventListener('change', function() {
            localStorage.setItem('poker_theme', this.value);
            applyTableVisuals(this.value);
        });

        // Cash out remaining chips on leave
        window.addEventListener('beforeunload', async (e) => {
            if(userId && players[0].chips > 0) {
                const netChange = players[0].chips - 2000;
                if(netChange > 0) {
                    // Try to update but don't block
                    updateBalance(netChange).catch(err => console.error('Failed to cash out:', err));
                }
            }
        });

        initSystem();
    </script>
</body>
</html>