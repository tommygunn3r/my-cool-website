<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GunnersGames Blackjack</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold: #d4af37;
            --gold-dark: #b8941f;
            --gold-light: #f4e5a7;
            --cream: #f5f3e8;
            --dark: #1a1410;
            --red: #8b0000;
            --green: #0a4a2e;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            overflow: auto;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            /* Default Background - Green */
            background-color: #0a4a2e;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }

        /* --- Start Screen --- */
        #tableSelector {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.5s, visibility 0.5s;
        }
        #tableSelector.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .selector-title {
            font-family: 'Cinzel', serif; font-size: 3.5rem; font-weight: 700; color: var(--gold);
            margin-bottom: 1rem; text-shadow: 0 0 20px rgba(212, 175, 55, 0.5); letter-spacing: 0.1em;
            text-align: center;
        }

        .loading-text { 
            color: var(--gold); font-family: 'Cinzel', serif; font-size: 1.2rem;
            margin-top: 20px; animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .start-button {
            font-family: 'Cinzel', serif; font-size: 1.5rem; padding: 1rem 4rem; margin-top: 2rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark); border: none; border-radius: 50px; cursor: pointer; font-weight: 600;
            letter-spacing: 0.1em; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            display: none; /* Hidden until loaded */
        }
        .start-button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.6); }

        /* --- Game Interface --- */
        #gameContainer {
            width: 100vw; min-height: 100vh; height: auto;
            display: flex; flex-direction: column; position: relative;
        }

        .header {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 100%);
            border-bottom: 2px solid var(--gold); flex-shrink: 0;
        }
        .logo {
            font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; color: var(--gold);
            letter-spacing: 0.15em; text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
        }
        .balance { display: flex; align-items: center; gap: 0.5rem; font-size: 1.4rem; color: var(--cream); font-weight: 600; }
        .coin-icon {
            width: 30px; height: 30px; background: radial-gradient(circle, var(--gold-light) 0%, var(--gold) 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: var(--dark); font-size: 1rem; box-shadow: 0 2px 10px rgba(212, 175, 55, 0.5);
        }

        .game-area { flex: 1; display: flex; flex-direction: column; padding: 1rem; position: relative; min-height: 0; }
        .dealer-area, .player-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; }
        .area-label {
            font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--gold); margin-bottom: 0.5rem;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8); letter-spacing: 0.1em;
        }

        .hand { display: flex; gap: -40px; min-height: 140px; align-items: center; perspective: 1000px; }
        
        .card {
            width: 90px; height: 126px; position: relative; transform-style: preserve-3d;
            transition: transform 0.6s; cursor: pointer; animation: dealCard 0.5s ease-out;
        }
        @keyframes dealCard { from { transform: translateY(-100px) rotateY(180deg); opacity: 0; } to { transform: translateY(0) rotateY(0deg); opacity: 1; } }
        .card:hover { transform: translateY(-10px); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        .card-back { background-size: cover; background-position: center; }
        .card-front {
            background: white; transform: rotateY(180deg); display: flex; flex-direction: column;
            justify-content: space-between; padding: 0.5rem; font-family: 'Cinzel', serif; font-weight: 600;
        }
        .card.flipped { transform: rotateY(180deg); }
        
        .card-value { font-size: 1.5rem; }
        .card-suit { font-size: 2rem; text-align: center; }
        .hearts, .diamonds { color: #dc143c; }
        .clubs, .spades { color: #000; }

        .score {
            font-size: 1.4rem; color: var(--gold); font-weight: 600; margin-top: 0.5rem;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        .controls {
            display: flex; justify-content: center; align-items: center; gap: 1rem; padding: 1rem;
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 100%);
            border-top: 2px solid var(--gold); flex-wrap: wrap;
        }
        .betting-area { display: flex; align-items: center; gap: 1rem; }
        .bet-input {
            width: 150px; padding: 0.8rem; font-size: 1.2rem; font-family: 'Cormorant Garamond', serif;
            background: rgba(0, 0, 0, 0.6); border: 2px solid var(--gold); border-radius: 8px;
            color: var(--cream); text-align: center;
        }
        .game-button {
            font-family: 'Cinzel', serif; font-size: 1rem; padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark); border: none; border-radius: 25px; cursor: pointer; font-weight: 600;
            letter-spacing: 0.05em; transition: all 0.3s ease; box-shadow: 0 3px 15px rgba(212, 175, 55, 0.4);
        }
        .game-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(212, 175, 55, 0.6); }
        .game-button:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(0.8); }

        .message-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9); padding: 2rem 4rem; border-radius: 15px;
            border: 3px solid var(--gold); font-family: 'Cinzel', serif; font-size: 2rem;
            color: var(--gold); font-weight: 600; letter-spacing: 0.1em;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.8); z-index: 100;
            opacity: 0; animation: fadeIn 0.5s forwards; pointer-events: none;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .settings-button {
            background: rgba(0, 0, 0, 0.6); border: 2px solid var(--gold); color: var(--gold);
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: all 0.3s;
        }
        .settings-button:hover { background: rgba(212, 175, 55, 0.2); transform: rotate(90deg); }

        /* --- Modal --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center;
            z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            padding: 2rem; border-radius: 15px; border: 3px solid var(--gold);
            max-width: 500px; width: 90%;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;
        }
        .modal-title { font-family: 'Cinzel', serif; font-size: 1.8rem; color: var(--gold); }
        .close-button {
            background: none; border: none; color: var(--gold); font-size: 1.5rem; cursor: pointer; transition: transform 0.3s;
        }
        .close-button:hover { transform: rotate(90deg); }
        .modal-section {
            margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        }
        .modal-section:last-child { border-bottom: none; }
        .section-title { font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 0.5rem; }
        .section-description { color: var(--cream); font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
        .toggle-option {
            display: flex; justify-content: space-between; align-items: center; padding: 0.8rem;
            background: rgba(0, 0, 0, 0.3); border-radius: 8px; margin-bottom: 0.5rem;
        }
        .option-label { color: var(--cream); font-weight: 600; }
        .toggle-switch {
            width: 50px; height: 26px; background: rgba(0, 0, 0, 0.5); border-radius: 13px;
            position: relative; cursor: pointer; transition: background 0.3s;
            border: 2px solid var(--gold-dark);
        }
        .toggle-switch::after {
            content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%;
            background: var(--gold-dark); top: 2px; left: 2px; transition: all 0.3s;
        }
        .toggle-switch.active { background: var(--gold-dark); }
        .toggle-switch.active::after { transform: translateX(24px); background: var(--gold-light); }

        .table-select {
            width: 100%; padding: 0.8rem; font-size: 1rem; font-family: 'Cormorant Garamond', serif;
            background: rgba(0, 0, 0, 0.6); border: 2px solid var(--gold); border-radius: 8px;
            color: var(--cream); cursor: pointer;
        }

        /* --- AI PLAYERS --- */
        .ai-players {
            display: none; flex-wrap: wrap; gap: 1rem; padding: 1rem; justify-content: center;
            background: rgba(0, 0, 0, 0.3); border-top: 1px solid var(--gold-dark);
        }
        .ai-player {
            background: rgba(0, 0, 0, 0.5); padding: 1rem; border-radius: 10px; min-width: 150px;
            border: 2px solid var(--gold-dark); text-align: center;
        }
        .ai-name { color: var(--gold); font-family: 'Cinzel', serif; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .ai-hand { display: flex; gap: 5px; justify-content: center; margin-bottom: 0.5rem; min-height: 60px; }
        .ai-card {
            width: 40px; height: 56px; border-radius: 4px;
            background: linear-gradient(135deg, var(--gold-dark), var(--gold)); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* --- Credits Screen --- */
        #creditsScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, #1a0f0a 100%);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 3000; padding: 2rem;
        }
        #creditsScreen.active { display: flex; }
        
        .credits-content {
            text-align: center; max-width: 800px;
            animation: fadeInUp 1s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .credits-title {
            font-family: 'Cinzel', serif; font-size: 4rem; color: var(--gold);
            margin-bottom: 2rem; text-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
            letter-spacing: 0.2em;
        }
        
        .credits-stats {
            background: rgba(0, 0, 0, 0.6); padding: 2rem; border-radius: 15px;
            border: 2px solid var(--gold); margin-bottom: 2rem;
        }
        
        .stat-row {
            display: flex; justify-content: space-between; padding: 1rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3); font-size: 1.4rem;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--cream); font-weight: 600; }
        .stat-value { color: var(--gold); font-family: 'Cinzel', serif; font-weight: 700; }
        .stat-value.positive { color: #4ade80; }
        .stat-value.negative { color: #ef4444; }
        
        .credits-message {
            font-family: 'Cinzel', serif; font-size: 1.8rem; color: var(--gold);
            margin: 2rem 0; letter-spacing: 0.1em;
        }
        
        .credits-buttons {
            display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;
        }
        
        .credits-button {
            font-family: 'Cinzel', serif; font-size: 1.2rem; padding: 1rem 3rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark); border: none; border-radius: 50px; cursor: pointer;
            font-weight: 600; letter-spacing: 0.1em; transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }
        .credits-button:hover {
            transform: translateY(-3px); box-shadow: 0 8px 30px rgba(212, 175, 55, 0.6);
        }
        .credits-button.secondary {
            background: rgba(0, 0, 0, 0.6); color: var(--gold);
            border: 2px solid var(--gold);
        }

        @media (max-width: 768px) {
            .selector-title { font-size: 2rem; }
            .credits-title { font-size: 2.5rem; }
            .stat-row { font-size: 1.1rem; }
            .credits-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Table Selector / Start Screen -->
    <div id="tableSelector">
        <h1 class="selector-title">BLACKJACK</h1>
        <div class="loading-text">Loading table...</div>
        <button class="start-button" id="startGame">ENTER CASINO</button>
    </div>

    <!-- Game Container -->
    <div id="gameContainer">
        <!-- Header -->
        <div class="header">
            <div class="logo">BLACKJACK</div>
            <div class="balance">
                <div class="coin-icon">G</div>
                <span id="balanceDisplay">0</span>
            </div>
            <button class="settings-button" id="settingsBtn">⚙</button>
        </div>

        <!-- Dealer Area -->
        <div class="game-area">
            <div class="dealer-area">
                <div class="area-label">DEALER</div>
                <div class="hand" id="dealerHand"></div>
                <div class="score" id="dealerScore"></div>
            </div>

            <!-- AI Players -->
            <div class="ai-players" id="aiPlayers"></div>

            <!-- Player Area -->
            <div class="player-area">
                <div class="area-label">YOU</div>
                <div class="hand" id="playerHand"></div>
                <div class="score" id="playerScore"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="betting-area">
                <input type="number" class="bet-input" id="betAmount" value="10" min="1">
                <button class="game-button" id="placeBet">PLACE BET</button>
            </div>
            <button class="game-button" id="hitBtn" disabled>HIT</button>
            <button class="game-button" id="standBtn" disabled>STAND</button>
            <button class="game-button" id="doubleBtn" disabled>DOUBLE DOWN</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">SETTINGS</div>
                <button class="close-button" id="closeSettings">✕</button>
            </div>
            
            <div class="modal-section">
                <div class="section-title">Table Style</div>
                <div class="section-description">Choose your preferred table design</div>
                <select class="table-select" id="tableSelect">
                    <option value="classic">Classic Green</option>
                    <option value="luxury">Luxury Red</option>
                    <option value="royal">Royal Blue</option>
                </select>
            </div>

            <div class="modal-section">
                <div class="section-title">Game Options</div>
                <div class="toggle-option">
                    <span class="option-label">Sound Effects</span>
                    <div class="toggle-switch active" id="soundToggle"></div>
                </div>
                <div class="toggle-option">
                    <span class="option-label">AI Players (Visual Only)</span>
                    <div class="toggle-switch" id="aiToggle"></div>
                </div>
            </div>

            <div class="modal-section">
                <div class="section-title">Exit Game</div>
                <button class="game-button" id="exitGame" style="width: 100%;">LEAVE TABLE</button>
            </div>
        </div>
    </div>

    <!-- Credits Screen -->
    <div id="creditsScreen">
        <div class="credits-content">
            <div class="credits-title">SESSION COMPLETE</div>
            
            <div class="credits-stats">
                <div class="stat-row">
                    <span class="stat-label">Hands Played</span>
                    <span class="stat-value" id="handsPlayed">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Wagered</span>
                    <span class="stat-value" id="totalWagered">0 G</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Won</span>
                    <span class="stat-value" id="totalWon">0 G</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Session Profit</span>
                    <span class="stat-value" id="sessionProfit">0 G</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Final Balance</span>
                    <span class="stat-value" id="finalBalance">0 G</span>
                </div>
            </div>
            
            <div class="credits-message" id="creditsMessage">Thank you for playing!</div>
            
            <div class="credits-buttons">
                <button class="credits-button" id="returnToCasino">RETURN TO CASINO</button>
                <button class="credits-button secondary" id="playAgain">PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GAME STATE ---
        let balance = 1000;
        let currentBet = 0;
        let deck = [];
        let playerHand = [];
        let dealerHand = [];
        let gameActive = false;
        let soundEnabled = true;
        let aiEnabled = false;
        let aiPlayers = [];
        let selectedTable = 'classic';

        // Session tracking
        let sessionStats = {
            handsPlayed: 0,
            totalWagered: 0,
            totalWon: 0,
            startingBalance: 1000
        };

        let userId = null;
        let playerName = 'Guest';

        // --- AUDIO ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, duration, type = 'sine') {
            if (!soundEnabled) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.frequency.value = freq; osc.type = type;
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            osc.start(); osc.stop(audioContext.currentTime + duration);
        }

        function playCardSound() { playTone(400, 0.1, 'triangle'); }
        function playChipSound() { playTone(600, 0.15, 'square'); }
        function playWinSound() { 
            playTone(523, 0.15); 
            setTimeout(() => playTone(659, 0.15), 100);
            setTimeout(() => playTone(784, 0.2), 200);
        }
        function playLoseSound() { playTone(200, 0.3, 'sawtooth'); }

        // --- TABLE THEMES ---
        const tables = {
            classic: { bg: 'linear-gradient(135deg, #0a4a2e 0%, #134d34 50%, #0a4a2e 100%)', cardBack: 'card_back.png' },
            luxury: { bg: 'linear-gradient(135deg, #8b0000 0%, #a52a2a 50%, #8b0000 100%)', cardBack: 'card_back.png' },
            royal: { bg: 'linear-gradient(135deg, #003366 0%, #004d99 50%, #003366 100%)', cardBack: 'card_back.png' }
        };

        function applyTableVisuals() {
            const table = tables[selectedTable];
            document.body.style.background = table.bg;
            document.querySelectorAll('.card-back').forEach(el => el.style.backgroundImage = `url(${table.cardBack})`);
        }

        // --- SUPABASE FUNCTIONS ---
        async function initSupabase() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    console.log('No authenticated user, using guest mode');
                    userId = null;
                    balance = 1000;
                    sessionStats.startingBalance = 1000;
                    updateBalance(0);
                    document.getElementById('startGame').style.display = 'block';
                    document.querySelector('.loading-text').style.display = 'none';
                    return;
                }

                userId = user.id;

                // Fetch user profile for balance
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('gunnercoins, playername')
                    .eq('id', userId)
                    .single();

                if (profileError) {
                    console.error('Error fetching profile:', profileError);
                    balance = 1000;
                } else {
                    balance = profile.gunnercoins || 1000;
                    playerName = profile.playername || 'Player';
                }

                sessionStats.startingBalance = balance;
                updateBalance(0);
                document.getElementById('startGame').style.display = 'block';
                document.querySelector('.loading-text').style.display = 'none';

            } catch (err) {
                console.error('Supabase init error:', err);
                userId = null;
                balance = 1000;
                sessionStats.startingBalance = 1000;
                updateBalance(0);
                document.getElementById('startGame').style.display = 'block';
                document.querySelector('.loading-text').style.display = 'none';
            }
        }

        async function updateSupabaseBalance(newBalance) {
            if (!userId) return;

            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ gunnercoins: newBalance })
                    .eq('id', userId);

                if (error) {
                    console.error('Error updating balance:', error);
                }
            } catch (err) {
                console.error('Balance update error:', err);
            }
        }

        async function submitSessionScore() {
            if (!userId) return;

            const sessionProfit = balance - sessionStats.startingBalance;
            
            // Only submit if profit is positive
            if (sessionProfit <= 0) {
                console.log('No profit to report');
                return;
            }

            try {
                const { error } = await supabase
                    .from('user_scores')
                    .insert({
                        user_id: userId,
                        game_name: 'blackjack',
                        score: sessionProfit
                    });

                if (error) {
                    console.error('Error submitting score:', error);
                } else {
                    console.log('Session profit reported:', sessionProfit);
                }
            } catch (err) {
                console.error('Score submission error:', err);
            }
        }

        // --- GAME INITIALIZATION ---
        async function initGameSystem() {
            await initSupabase();
            applyTableVisuals();
            initializeAIPlayers();
            
            const savedTheme = localStorage.getItem('blackjack_theme');
            if (savedTheme && tables[savedTheme]) {
                selectedTable = savedTheme;
                document.getElementById('tableSelect').value = selectedTable;
                applyTableVisuals();
            }
        }

        // --- DECK & CARDS ---
        function createDeck() {
            const suits = ['♠', '♥', '♣', '♦'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const d = [];
            for (let s of suits) {
                for (let v of values) {
                    d.push({ suit: s, value: v });
                }
            }
            return d.sort(() => Math.random() - 0.5);
        }

        function calculateScore(hand) {
            let score = 0, aces = 0;
            for (let card of hand) {
                if (card.value === 'A') { score += 11; aces++; }
                else if (['J', 'Q', 'K'].includes(card.value)) score += 10;
                else score += parseInt(card.value);
            }
            while (score > 21 && aces > 0) { score -= 10; aces--; }
            return score;
        }

        function dealCard(hand, container, faceDown = false) {
            const card = deck.pop();
            hand.push(card);
            playCardSound();
            
            const suitClass = ['♥', '♦'].includes(card.suit) ? (card.suit === '♥' ? 'hearts' : 'diamonds') : (card.suit === '♠' ? 'spades' : 'clubs');
            const cardEl = document.createElement('div');
            cardEl.className = `card ${faceDown ? '' : 'flipped'}`;
            cardEl.innerHTML = `
                <div class="card-back" style="background-image: url(${tables[selectedTable].cardBack})"></div>
                <div class="card-front">
                    <div class="card-value ${suitClass}">${card.value}</div>
                    <div class="card-suit ${suitClass}">${card.suit}</div>
                    <div class="card-value ${suitClass}">${card.value}</div>
                </div>
            `;
            container.appendChild(cardEl);
        }

        function updateScores() {
            document.getElementById('playerScore').textContent = calculateScore(playerHand);
            const ds = calculateScore(dealerHand);
            const dealerCards = document.getElementById('dealerHand').children;
            const isHidden = dealerCards[1] && !dealerCards[1].classList.contains('flipped');
            document.getElementById('dealerScore').textContent = isHidden ? '?' : ds;
        }

        function updateBalance(change) {
            balance += change;
            document.getElementById('balanceDisplay').textContent = balance;
            
            // Update Supabase in real-time
            if (change !== 0) {
                updateSupabaseBalance(balance);
            }
            
            // Animate coin change
            if (change !== 0) {
                const el = document.createElement('div');
                el.style.cssText = `position: fixed; top: 20px; right: 20px; font-size: 2rem; 
                    color: ${change > 0 ? '#4ade80' : '#ef4444'}; font-weight: 700; 
                    font-family: 'Cinzel', serif; animation: floatUp 2s ease-out; pointer-events: none; z-index: 9999;`;
                el.textContent = `${change > 0 ? '+' : ''}${change} G`;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
        }

        function showMessage(text) {
            const existing = document.querySelector('.message-overlay');
            if (existing) existing.remove();
            
            const el = document.createElement('div');
            el.className = 'message-overlay';
            el.textContent = text;
            document.querySelector('.game-area').appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        function initializeAIPlayers() {
            const container = document.getElementById('aiPlayers');
            container.innerHTML = ''; aiPlayers = [];
            if (!aiEnabled) { container.style.display = 'none'; return; }
            container.style.display = 'flex';
            const names = ['Alex', 'Jordan', 'Sam'];
            for (let i = 0; i < 3; i++) {
                aiPlayers.push({ name: names[i], hand: [] });
                const el = document.createElement('div'); el.className = 'ai-player';
                el.innerHTML = `<div class="ai-name">${names[i]}</div><div class="ai-hand" id="ai-hand-${i}"></div><div class="score" id="ai-score-${i}"></div>`;
                container.appendChild(el);
            }
        }

        function playAI() {
            aiPlayers.forEach((ai, idx) => {
                ai.hand = [];
                const el = document.getElementById(`ai-hand-${idx}`); el.innerHTML = '';
                for(let i=0;i<2;i++) { deck.pop(); ai.hand.push({}); el.innerHTML += '<div class="ai-card"></div>'; }
                const score = Math.floor(Math.random() * 5) + 17; 
                document.getElementById(`ai-score-${idx}`).textContent = score > 21 ? 'BUST' : score;
            });
        }

        async function startRound() {
            if (audioContext.state === 'suspended') audioContext.resume();
            const bet = parseInt(document.getElementById('betAmount').value);
            
            if (bet > balance) { showMessage('INSUFFICIENT FUNDS'); return; }
            if (bet < 1) { showMessage('MINIMUM BET IS 1'); return; }
            
            currentBet = bet;
            sessionStats.handsPlayed++;
            sessionStats.totalWagered += bet;
            
            // Deduct bet immediately
            updateBalance(-currentBet);
            playChipSound();
            
            playerHand = []; dealerHand = [];
            document.getElementById('playerHand').innerHTML = '';
            document.getElementById('dealerHand').innerHTML = '';
            
            if (deck.length < 52) deck = createDeck();
            gameActive = true;
            
            dealCard(playerHand, document.getElementById('playerHand'));
            dealCard(dealerHand, document.getElementById('dealerHand'));
            
            setTimeout(() => {
                dealCard(playerHand, document.getElementById('playerHand'));
                dealCard(dealerHand, document.getElementById('dealerHand'), true);
                updateScores();
                if (calculateScore(playerHand) === 21) stand(); else enableGameButtons();
            }, 300);
            
            document.getElementById('placeBet').disabled = true;
            document.getElementById('betAmount').disabled = true;
            if (aiEnabled) playAI();
        }

        function enableGameButtons() {
            document.getElementById('hitBtn').disabled = false;
            document.getElementById('standBtn').disabled = false;
            document.getElementById('doubleBtn').disabled = balance < currentBet;
        }
        function disableGameButtons() {
            ['hitBtn','standBtn','doubleBtn'].forEach(id => document.getElementById(id).disabled = true);
        }

        function hit() {
            dealCard(playerHand, document.getElementById('playerHand'));
            updateScores();
            if (calculateScore(playerHand) > 21) bust();
            document.getElementById('doubleBtn').disabled = true;
        }

        function stand() {
            gameActive = false; disableGameButtons();
            const dc = document.getElementById('dealerHand').children;
            if(dc[1]) dc[1].classList.add('flipped');
            setTimeout(dealerPlay, 500);
        }

        function dealerPlay() {
            const score = calculateScore(dealerHand);
            if (score < 17) {
                setTimeout(() => {
                    dealCard(dealerHand, document.getElementById('dealerHand'));
                    updateScores(); dealerPlay();
                }, 600);
            } else determineWinner();
        }

        function determineWinner() {
            const ps = calculateScore(playerHand);
            const ds = calculateScore(dealerHand);
            updateScores();
            
            let winAmount = 0;
            
            if (ds > 21) { 
                winAmount = currentBet * 2;
                sessionStats.totalWon += winAmount;
                showMessage('DEALER BUSTS - YOU WIN!'); 
                updateBalance(winAmount); 
                playWinSound(); 
            }
            else if (ps > ds) { 
                winAmount = currentBet * 2;
                sessionStats.totalWon += winAmount;
                showMessage('YOU WIN!'); 
                updateBalance(winAmount); 
                playWinSound(); 
            }
            else if (ps < ds) { 
                showMessage('DEALER WINS'); 
                playLoseSound(); 
            }
            else { 
                winAmount = currentBet;
                sessionStats.totalWon += winAmount;
                showMessage('PUSH'); 
                updateBalance(winAmount); 
                playChipSound(); 
            }
            
            resetRound();
        }

        function bust() {
            gameActive = false; disableGameButtons(); updateScores();
            showMessage('BUST!'); playLoseSound();
            setTimeout(resetRound, 1500);
        }

        function doubleDown() {
            if(balance < currentBet) { showMessage('INSUFFICIENT FUNDS'); return; }
            updateBalance(-currentBet); 
            sessionStats.totalWagered += currentBet;
            currentBet *= 2; 
            playChipSound();
            dealCard(playerHand, document.getElementById('playerHand'));
            updateScores();
            if (calculateScore(playerHand) > 21) bust(); else stand();
        }

        function resetRound() {
            setTimeout(() => {
                document.getElementById('playerHand').innerHTML = '';
                document.getElementById('dealerHand').innerHTML = '';
                document.getElementById('playerScore').textContent = '';
                document.getElementById('dealerScore').textContent = '';
                document.getElementById('placeBet').disabled = false;
                document.getElementById('betAmount').disabled = false;
                gameActive = false; currentBet = 0;
            }, 2000);
        }

        // --- CREDITS SCREEN ---
        async function showCreditsScreen() {
            const sessionProfit = balance - sessionStats.startingBalance;
            
            document.getElementById('handsPlayed').textContent = sessionStats.handsPlayed;
            document.getElementById('totalWagered').textContent = sessionStats.totalWagered + ' G';
            document.getElementById('totalWon').textContent = sessionStats.totalWon + ' G';
            
            const profitEl = document.getElementById('sessionProfit');
            profitEl.textContent = (sessionProfit >= 0 ? '+' : '') + sessionProfit + ' G';
            profitEl.className = 'stat-value ' + (sessionProfit > 0 ? 'positive' : sessionProfit < 0 ? 'negative' : '');
            
            document.getElementById('finalBalance').textContent = balance + ' G';
            
            const messageEl = document.getElementById('creditsMessage');
            if (sessionProfit > 100) {
                messageEl.textContent = 'OUTSTANDING PERFORMANCE!';
            } else if (sessionProfit > 0) {
                messageEl.textContent = 'WELL PLAYED!';
            } else if (sessionProfit === 0) {
                messageEl.textContent = 'EVEN MONEY - NICE CONTROL!';
            } else {
                messageEl.textContent = 'BETTER LUCK NEXT TIME!';
            }
            
            // Submit score to leaderboard if positive
            await submitSessionScore();
            
            document.getElementById('creditsScreen').classList.add('active');
        }

        function resetSession() {
            sessionStats = {
                handsPlayed: 0,
                totalWagered: 0,
                totalWon: 0,
                startingBalance: balance
            };
        }

        // --- EVENT LISTENERS ---
        document.getElementById('startGame').addEventListener('click', () => {
            document.getElementById('tableSelector').classList.add('hidden');
            if(audioContext.state==='suspended') audioContext.resume();
        });

        document.getElementById('placeBet').addEventListener('click', startRound);
        document.getElementById('hitBtn').addEventListener('click', hit);
        document.getElementById('standBtn').addEventListener('click', stand);
        document.getElementById('doubleBtn').addEventListener('click', doubleDown);
        
        document.getElementById('settingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.add('active'));
        document.getElementById('closeSettings').addEventListener('click', () => document.getElementById('settingsModal').classList.remove('active'));
        document.getElementById('soundToggle').addEventListener('click', function() { this.classList.toggle('active'); soundEnabled = this.classList.contains('active'); });
        document.getElementById('aiToggle').addEventListener('click', function() { this.classList.toggle('active'); aiEnabled = this.classList.contains('active'); initializeAIPlayers(); });
        
        document.getElementById('tableSelect').addEventListener('change', function() {
            selectedTable = this.value;
            localStorage.setItem('blackjack_theme', selectedTable);
            applyTableVisuals();
            playChipSound();
        });

        document.getElementById('exitGame').addEventListener('click', async () => {
            document.getElementById('settingsModal').classList.remove('active');
            await showCreditsScreen();
        });

        document.getElementById('returnToCasino').addEventListener('click', () => {
            window.location.href = '/casino';
        });

        document.getElementById('playAgain').addEventListener('click', () => {
            document.getElementById('creditsScreen').classList.remove('active');
            resetSession();
        });

        // Add CSS animation for coin float
        const style = document.createElement('style');
        style.textContent = `
            @keyframes floatUp {
                0% { opacity: 0; transform: translateY(0); }
                20% { opacity: 1; }
                100% { opacity: 0; transform: translateY(-100px); }
            }
        `;
        document.head.appendChild(style);

        initGameSystem();
    </script>
</body>
</html>