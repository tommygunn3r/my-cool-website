<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Square Bird</title>
<style>
/* (UNCHANGED CSS) */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    display: flex; justify-content: center; align-items: center;
    min-height: 100vh;
    background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%);
    font-family: 'Courier New', monospace;
    overflow: hidden; padding: 10px;
}
#gameContainer {
    position: relative;
    width: 100%; max-width: 400px;
    height: 600px; max-height: 90vh;
    background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 70%, #90EE90 70%, #90EE90 100%);
    border: 4px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    overflow: hidden;
}
#gameCanvas { display: block; width: 100%; height: 100%; }
/* (UNCHANGED UI CSS) */
</style>
</head>
<body>
<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="score">Score: 0</div>
    <div id="highScore">Best: 0</div>

    <div id="startScreen">
        <h1>SQUARE BIRD</h1>
        <p class="instruction">Click or Press SPACE to flap</p>
        <p class="instruction">Avoid pipes and bullets!</p>
        <button class="button" onclick="startGame()">START GAME</button>
    </div>

    <div id="gameOverScreen">
        <h1>GAME OVER</h1>
        <div id="finalScore"></div>
        <button class="button" onclick="restartGame()">PLAY AGAIN</button>
    </div>
</div>

<script type="module">

/* (UNCHANGED FIREBASE + SCORE MANAGER CODE) */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 400;
canvas.height = 600;

/* ============================================================
   NEW CLOUD PARALLAX SYSTEM
============================================================ */

let clouds = [];
const cloudMinY = 20;
const cloudMaxY = 200;

function spawnCloud() {
    clouds.push({
        x: canvas.width + 50,
        y: Math.random() * (cloudMaxY - cloudMinY) + cloudMinY,
        speed: 0.4 + Math.random() * 0.4,
        size: 30 + Math.random() * 40
    });
}

function drawCloud(c) {
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.beginPath();
    ctx.ellipse(c.x, c.y, c.size, c.size * 0.6, 0, 0, Math.PI * 2);
    ctx.ellipse(c.x + c.size * 0.6, c.y + 5, c.size * 0.7, c.size * 0.45, 0, 0, Math.PI * 2);
    ctx.ellipse(c.x - c.size * 0.6, c.y + 5, c.size * 0.7, c.size * 0.45, 0, 0, Math.PI * 2);
    ctx.fill();
}

/* ============================================================ */

let gameActive = false;
let gameLoop;
let score = 0;
let highScore = parseInt(localStorage.getItem('squareBirdHighScore')) || 0;
let frameCount = 0;

/* ============================================================
   BIRD, PIPES, BULLETS (UNCHANGED)
============================================================ */

const bird = { x: 80, y: 300, width: 30, height: 30, velocity: 0, gravity: 0.5, jump: -9, color: '#FFD700' };
let pipes = [];
const pipeWidth = 60;
const pipeGap = 160;
const pipeSpeed = 2;

let bullets = [];
const bulletSize = 15;
const bulletSpeed = 3;

/* ============================================================ */

function startGame() {
    document.getElementById('startScreen').style.display = 'none';
    gameActive = true;
    score = 0;
    frameCount = 0;
    bird.y = 300;
    bird.velocity = 0;

    pipes = [];
    bullets = [];
    clouds = [];

    spawnCloud(); // Start with 1–2 clouds
    spawnCloud();

    gameLoop = setInterval(update, 1000/60);
}

window.startGame = startGame;

function restartGame() {
    document.getElementById('gameOverScreen').style.display = 'none';
    startGame();
}
window.restartGame = restartGame;

/* ============================================================
   GAME UPDATE LOOP — CLOUDS ADDED
============================================================ */

function update() {
    if (!gameActive) return;

    frameCount++;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    /* ----------- CLOUD PARALLAX UPDATE ------------- */

    if (frameCount % 160 === 0) {
        spawnCloud();
    }

    for (let i = clouds.length - 1; i >= 0; i--) {
        let c = clouds[i];
        c.x -= c.speed;

        drawCloud(c);

        if (c.x + c.size < 0) {
            clouds.splice(i, 1);
        }
    }

    /* ---------- BIRD PHYSICS ---------- */
    bird.velocity += bird.gravity;
    bird.y += bird.velocity;

    ctx.fillStyle = bird.color;
    ctx.fillRect(bird.x, bird.y, bird.width, bird.height);
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 3;
    ctx.strokeRect(bird.x, bird.y, bird.width, bird.height);

    ctx.fillStyle = '#333';
    ctx.fillRect(bird.x + 20, bird.y + 8, 5, 5);

    /* ---------- PIPE SPAWN ---------- */
    if (frameCount % 120 === 0) {
        const minHeight = 50;
        const maxHeight = canvas.height - pipeGap - 120;
        const topHeight = Math.random() * (maxHeight - minHeight) + minHeight;

        pipes.push({ x: canvas.width, topHeight, scored: false });
    }

    /* ---------- BULLET SPAWN ---------- */
    const bulletFrequency = Math.max(100, 200 - Math.floor(score / 5) * 10);
    if (frameCount % bulletFrequency === 0 && score > 2) {
        bullets.push({
            x: canvas.width,
            y: Math.random() * (canvas.height - 150) + 50,
            color: "#FF4444"
        });
    }

    /* ---------- DRAW & UPDATE PIPES (UNCHANGED) ---------- */
    for (let i = pipes.length - 1; i >= 0; i--) {
        let pipe = pipes[i];
        pipe.x -= pipeSpeed + Math.floor(score / 10) * 0.5;

        ctx.fillStyle = "#228B22";
        ctx.fillRect(pipe.x, 0, pipeWidth, pipe.topHeight);
        ctx.strokeRect(pipe.x, 0, pipeWidth, pipe.topHeight);

        const bottomY = pipe.topHeight + pipeGap;
        ctx.fillRect(pipe.x, bottomY, pipeWidth, canvas.height - bottomY);
        ctx.strokeRect(pipe.x, bottomY, pipeWidth, canvas.height - bottomY);

        if (bird.x + bird.width > pipe.x && bird.x < pipe.x + pipeWidth) {
            if (bird.y < pipe.topHeight || bird.y + bird.height > bottomY) {
                gameOver();
            }
        }

        if (!pipe.scored && pipe.x + pipeWidth < bird.x) {
            score++;
            pipe.scored = true;
            document.getElementById('score').textContent = "Score: " + score;

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('squareBirdHighScore', highScore);
                document.getElementById('highScore').textContent = "Best: " + highScore;
            }
        }

        if (pipe.x + pipeWidth < 0) pipes.splice(i, 1);
    }

    /* ---------- DRAW & UPDATE BULLETS (UNCHANGED) ---------- */
    for (let i = bullets.length - 1; i >= 0; i--) {
        let b = bullets[i];
        b.x -= bulletSpeed + Math.floor(score / 10) * 0.5;

        ctx.fillStyle = b.color;
        ctx.fillRect(b.x, b.y, bulletSize + 10, bulletSize);

        if (b.x + bulletSize < 0) bullets.splice(i, 1);

        if (
            b.x < bird.x + bird.width &&
            b.x + bulletSize > bird.x &&
            b.y < bird.y + bird.height &&
            b.y + bulletSize > bird.y
        ) {
            gameOver();
        }
    }

    if (bird.y < 0 || bird.y + bird.height > canvas.height) {
        gameOver();
    }
}

/* ============================================================ */

function flap() {
    if (gameActive) bird.velocity = bird.jump;
}

document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') flap();
});
canvas.addEventListener('click', flap);
canvas.addEventListener('touchstart', flap);

/* ============================================================ */

function gameOver() {
    gameActive = false;
    clearInterval(gameLoop);

    document.getElementById('finalScore').textContent = "Final Score: " + score;
    document.getElementById('gameOverScreen').style.display = 'flex';
}

</script>
</body>
</html>
