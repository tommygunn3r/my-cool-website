<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Slider: Waterfall Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%); padding: 20px; color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); text-align: center; max-width: 90vw; position: relative;
        }
        /* Music Player */
        .music-player {
            position: absolute; top: -60px; right: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 15px; color: white;
            border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .music-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2em; opacity: 0.8; transition: all 0.2s; padding: 5px; }
        .music-btn:hover { opacity: 1; transform: scale(1.1); }
        .track-info { font-size: 0.8em; font-weight: bold; min-width: 80px; text-align: center; }
        .equalizer { display: flex; gap: 2px; height: 15px; align-items: flex-end; }
        .bar { width: 3px; background: #fdbb2d; animation: equalize 0.8s infinite ease-in-out alternate; }
        .bar:nth-child(2) { animation-delay: 0.2s; } .bar:nth-child(3) { animation-delay: 0.4s; }
        .paused .bar { animation-play-state: paused; height: 3px !important; }
        @keyframes equalize { 0% { height: 3px; } 100% { height: 15px; } }

        h1 { color: #b21f1f; margin-bottom: 10px; font-size: 2em; text-transform: uppercase; letter-spacing: 2px; }
        .info { color: #666; margin-bottom: 20px; font-size: 0.9em; line-height: 1.5; }
        .highlight-text { color: #d69e2e; font-weight: bold; }
        
        .stats { display: flex; justify-content: center; gap: 20px; margin: 20px 0; font-size: 1.1em; color: #555; flex-wrap: wrap; }
        .stat-item { display: flex; flex-direction: column; gap: 5px; min-width: 80px; }
        .stat-label { font-size: 0.8em; color: #888; }
        .stat-value { font-weight: bold; font-size: 1.3em; color: #b21f1f; }
        
        /* Timer specific styles */
        #timer { color: #2d3748; transition: color 0.3s; }
        #timer.low-time { color: #e53e3e; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .puzzle-grid { display: inline-grid; gap: 8px; margin: 20px 0; padding: 20px; background: #2d3748; border-radius: 10px; position: relative; padding-bottom: 25px; }
        .puzzle-grid::after {
            content: 'LASER ZONE'; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
            color: #fdbb2d; font-size: 0.8em; font-weight: bold; letter-spacing: 2px; pointer-events: none;
        }
        .tile {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); border: none; border-radius: 8px;
            font-size: 2em; font-weight: bold; color: #e2e8f0; cursor: pointer; transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }
        .tile.laser-active {
            background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%); color: #744210;
            border: 2px solid #ffeb3b; box-shadow: 0 0 15px rgba(236, 201, 75, 0.4);
        }
        .tile:hover { transform: translateY(-2px); }
        .tile.empty { background: #1a202c; cursor: default; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); border: none; }
        @keyframes dropIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .tile.new-spawn { animation: dropIn 0.4s ease; }
        .tile.found { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important; color: white !important; transform: scale(0.9); transition: transform 0.2s; }
        
        .buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        button { padding: 12px 24px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        .new-game-btn { background: #b21f1f; color: white; }
        .new-game-btn:hover { background: #801717; transform: translateY(-2px); }
        
        .message { margin-top: 15px; padding: 15px; border-radius: 8px; font-weight: bold; display: none; }
        .message.show { display: block; animation: fadeIn 0.3s ease; }
        .message.success { background: #48bb78; color: white; font-size: 1.2em; }
        .message.level-up { background: #fdbb2d; color: #744210; font-size: 1.3em; border: 2px solid #b7791f; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .words-found { margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; max-height: 150px; overflow-y: auto; }
        .words-found h3 { color: #2d3748; margin-bottom: 10px; font-size: 1.1em; }
        .word-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .found-word { background: #2d3748; color: #fdbb2d; padding: 5px 12px; border-radius: 5px; font-size: 0.9em; }
        .file-input-section { margin: 20px 0; padding: 15px; background: #edf2f7; border-radius: 8px; border: 2px dashed #cbd5e0; }

        /* GAME OVER OVERLAY */
        #gameOverOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 32, 44, 0.95); border-radius: 20px;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: white;
        }
        #gameOverOverlay h2 { color: #fdbb2d; font-size: 3em; margin-bottom: 20px; }
        #gameOverOverlay p { font-size: 1.5em; margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="gameOverOverlay">
            <h2>TIME'S UP!</h2>
            <p>Final Score: <span id="finalScore">0</span></p>
            <button class="new-game-btn" onclick="newGame()">Try Again</button>
        </div>

        <div class="music-player" id="musicPlayer">
            <div class="equalizer paused" id="equalizer"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            <span class="track-info" id="trackInfo">Ready</span>
            <button class="music-btn" onclick="toggleMusic()" title="Play/Pause">‚èØ</button>
            <button class="music-btn" onclick="nextTrack()" title="Next Track">‚è≠</button>
            <button class="music-btn" onclick="toggleMute()" title="Mute/Unmute">üîä</button>
        </div>

        <h1>Waterfall Slider</h1>
        <p class="info">Form words in the <span class="highlight-text">BOTTOM ROW</span> to add time!<br>Don't let the clock run out.</p>
        
        <div class="file-input-section" id="fileSection">
            <div id="loadingMessage" class="message show" style="display: block; background:#2d3748; color:white;">Loading **CSW19.txt** dictionary...</div>
        </div>

        <div class="stats">
            <div class="stat-item"><span class="stat-label">Time</span><span class="stat-value" id="timer">60</span></div>
            <div class="stat-item"><span class="stat-label">Score</span><span class="stat-value" id="score">0</span></div>
            <div class="stat-item"><span class="stat-label">Level</span><span class="stat-value" id="level">1</span></div>
            <div class="stat-item"><span class="stat-label">Grid</span><span class="stat-value" id="gridSize">5x5</span></div>
        </div>
        
        <div class="puzzle-grid" id="puzzleGrid"></div>
        <div class="buttons"><button class="new-game-btn" onclick="newGame()">Reset Game</button></div>
        <div class="message" id="message"></div>
        <div class="words-found">
            <h3>Extracted Words:</h3>
            <div class="word-list" id="wordList"></div>
        </div>
    </div>

    <script type="module">
        import { db } from '/firebase-config.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { collection, addDoc, serverTimestamp, doc, setDoc, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        let auth = null;
        let currentUser = null;

        async function initGameAuth() {
            try {
                auth = getAuth(db.app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Pilot Identified:", user.displayName);
                        currentUser = user;
                        scoreManager.playerName = user.displayName || "Unknown Pilot";
                    } else {
                        window.location.href = '/index.html';
                    }
                });
            } catch (error) {
                console.error("Auth failed:", error);
            }
        }

        class GameScoreManager {
            constructor(gameName) {
                this.gameName = gameName;
                this.sessionStartTime = null;
                this.playerName = "Loading...";
            }

            startSession() { this.sessionStartTime = Date.now(); }
            getElapsedTime() { return this.sessionStartTime ? Math.floor((Date.now() - this.sessionStartTime) / 1000) : 0; }

            async submitGameResult(score = 0) {
                if (!currentUser) return;
                const timePlayed = this.getElapsedTime();
                
                try {
                    await addDoc(collection(db, 'scores'), {
                        gameName: this.gameName,
                        playerName: this.playerName,
                        score: score,
                        timePlayed: timePlayed,
                        timestamp: serverTimestamp(),
                        uid: currentUser.uid
                    });

                    const userRef = doc(db, 'users', currentUser.uid);
                    await setDoc(userRef, {
                        lastActive: serverTimestamp(),
                        totalArcadeScore: increment(parseInt(score)),
                        [`gamesPlayed_${this.gameName}`]: increment(1),
                        totalTimePlayed: increment(timePlayed)
                    }, { merge: true });

                    console.log('Score submitted & Career updated');
                } catch (error) {
                    console.warn('Failed to submit score:', error.message);
                }
            }
        }

        const scoreManager = new GameScoreManager('word_slider');
        initGameAuth();

        // --- GAME LOGIC ---
        const playlist = ['music/track1.mp3', 'music/track2.mp3', 'music/track3.mp3'];
        const sfxPush = new Audio('sounds/push.mp3'); sfxPush.volume = 0.4;
        const sfxClear = new Audio('sounds/clear.mp3'); sfxClear.volume = 0.6;
        let currentTrackIndex = 0, audio = new Audio(), isPlaying = false, isMuted = false;
        
        audio.src = playlist[0]; audio.volume = 0.2; audio.loop = false;
        audio.addEventListener('ended', nextTrack);

        function playSound(type) {
            if (isMuted) return;
            try {
                if (type === 'push') { const s = sfxPush.cloneNode(); s.volume = 0.4; s.play().catch(()=>{}); }
                else if (type === 'clear') { sfxClear.currentTime = 0; sfxClear.play().catch(()=>{}); }
            } catch (e) {}
        }

        function toggleMusic() {
            if (isPlaying) { audio.pause(); document.getElementById('equalizer').classList.add('paused'); }
            else { audio.play().catch(e => console.log("Interact first")); document.getElementById('equalizer').classList.remove('paused'); }
            isPlaying = !isPlaying; updateTrackDisplay();
        }

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            audio.src = playlist[currentTrackIndex];
            if (isPlaying) { audio.play(); document.getElementById('equalizer').classList.remove('paused'); }
            updateTrackDisplay();
        }

        function toggleMute() {
            isMuted = !isMuted; audio.muted = isMuted;
            document.querySelectorAll('.music-btn')[2].textContent = isMuted ? 'üîá' : 'üîä';
        }

        function updateTrackDisplay() { document.getElementById('trackInfo').textContent = `Track ${currentTrackIndex + 1}`; }

        window.toggleMusic = toggleMusic; window.nextTrack = nextTrack; window.toggleMute = toggleMute;

        let dictionary = new Set(), grid = [], emptyPos = { row: 0, col: 0 };
        let score = 0, level = 1, gridSize = 5, targetRow = 4, wordsFound = [], tileSize = 70;
        let availableLetters = [], dictionaryLoaded = false;
        
        // --- TIMER VARIABLES ---
        let timeLeft = 60;
        let timerInterval = null;
        let gameActive = false;

        const letterWeights = {
            'E': 12, 'A': 9, 'I': 9, 'O': 8, 'N': 6, 'R': 6, 'T': 6, 'L': 4, 'S': 4, 'U': 4,
            'D': 4, 'G': 3, 'B': 2, 'C': 2, 'M': 2, 'P': 2, 'F': 2, 'H': 2, 'V': 2, 'W': 2,
            'Y': 2, 'K': 1, 'J': 1, 'X': 1, 'Q': 1, 'Z': 1
        };

        async function loadDictionary() {
            try {
                const response = await fetch('CSW19.txt');
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                const text = await response.text();
                const words = text.split(/\r?\n/).map(w => w.trim().toUpperCase()).filter(w => w.length >= 3);
                dictionary = new Set(words); dictionaryLoaded = true;
                document.getElementById('loadingMessage').style.display = 'none';
                showMessage(`System Ready! Game On!`, 'success');
                newGame(); // Start first game
            } catch (error) {
                const msg = document.getElementById('loadingMessage');
                msg.textContent = `Error loading dictionary. Upload manually.`;
                msg.style.background = '#f56565';
                document.getElementById('fileSection').innerHTML += `<input type="file" id="dictionaryFile" accept=".txt" style="margin-top:10px;">`;
                document.getElementById('dictionaryFile').addEventListener('change', handleManualUpload);
            }
        }

        function handleManualUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const text = event.target.result;
                    const words = text.split(/\r?\n/).map(w => w.trim().toUpperCase()).filter(w => w.length >= 3);
                    dictionary = new Set(words); dictionaryLoaded = true;
                    document.getElementById('loadingMessage').style.display = 'none';
                    showMessage(`Dictionary Loaded!`, 'success');
                    newGame();
                };
                reader.readAsText(file);
            }
        }
        
        function createLetterPool() {
            const pool = [];
            for (const [letter, weight] of Object.entries(letterWeights)) for (let i = 0; i < weight; i++) pool.push(letter);
            return pool;
        }

        function getRandomLetter() {
            if (availableLetters.length === 0) availableLetters = createLetterPool();
            const index = Math.floor(Math.random() * availableLetters.length);
            const letter = availableLetters[index]; availableLetters.splice(index, 1);
            return letter;
        }

        function initGame() {
            if (!dictionaryLoaded) return;
            targetRow = gridSize - 1; grid = []; availableLetters = createLetterPool();
            const totalTiles = gridSize * gridSize;
            for (let i = 0; i < gridSize; i++) {
                grid[i] = [];
                for (let j = 0; j < gridSize; j++) {
                    const index = i * gridSize + j; grid[i][j] = index < totalTiles - 1 ? getRandomLetter() : '';
                }
            }
            emptyPos = { row: 0, col: Math.floor(Math.random() * gridSize) };
            grid[gridSize-1][gridSize-1] = getRandomLetter(); grid[emptyPos.row][emptyPos.col] = '';
            updateTileSize(); renderGrid();
        }

        function updateTileSize() {
            if (gridSize <= 5) tileSize = 70; else if (gridSize <= 7) tileSize = 55; else tileSize = 45;
            document.getElementById('puzzleGrid').style.gridTemplateColumns = `repeat(${gridSize}, ${tileSize}px)`;
        }

        function moveTile(row, col) {
            if (!gameActive) return false; // Stop input if game over
            if (!isPlaying && audio.currentTime === 0) toggleMusic();
            
            const rowDiff = Math.abs(row - emptyPos.row);
            const colDiff = Math.abs(col - emptyPos.col);
            if ((rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1)) {
                grid[emptyPos.row][emptyPos.col] = grid[row][col]; grid[row][col] = ''; emptyPos = { row, col };
                playSound('push'); renderGrid(); checkForWordsInLaserRow(); return true;
            }
            return false;
        }

        function checkForWordsInLaserRow() {
            if (!dictionaryLoaded) return;
            const rowStr = grid[targetRow].map(c => c === '' ? ' ' : c).join('');
            checkStringForWords(rowStr, targetRow);
        }

        function checkStringForWords(str, rowIndex) {
            for (let start = 0; start < str.length; start++) {
                for (let end = start + 3; end <= str.length; end++) {
                    const substring = str.substring(start, end);
                    if (substring.includes(' ')) continue;
                    if (dictionary.has(substring)) { foundWord(substring, rowIndex, start, end - 1); return true; }
                }
            }
            return false;
        }

        function foundWord(word, rowIndex, startPos, endPos) {
            playSound('clear');
            const points = calculatePoints(word); 
            score += points; 
            wordsFound.push(word);
            
            // --- ADD TIME BONUS ---
            const timeBonus = Math.floor(points / 5) + 2; // Formula: 1 sec for every 5 points + 2s base
            timeLeft += timeBonus;
            showMessage(`+${timeBonus}s! ${word}!`, 'success');

            document.getElementById('score').textContent = score;
            document.getElementById('wordCount').textContent = wordsFound.length;
            document.getElementById('timer').textContent = timeLeft;

            const list = document.getElementById('wordList');
            const span = document.createElement('span');
            span.className = 'found-word'; span.textContent = `${word} (${points})`;
            list.insertBefore(span, list.firstChild);
            if (list.children.length > 10) list.removeChild(list.lastChild);
            
            highlightWord(rowIndex, startPos, endPos);
            setTimeout(() => { applyGravity(startPos, endPos); checkLevelUp(); }, 800);
        }

        function highlightWord(rowIndex, startPos, endPos) {
            const tiles = document.getElementById('puzzleGrid').children;
            for (let pos = startPos; pos <= endPos; pos++) {
                const tileIndex = rowIndex * gridSize + pos;
                if (tiles[tileIndex]) tiles[tileIndex].classList.add('found');
            }
        }

        function applyGravity(startCol, endCol) {
            for (let col = startCol; col <= endCol; col++) {
                for (let row = targetRow; row > 0; row--) grid[row][col] = grid[row - 1][col];
                grid[0][col] = getRandomLetter();
                if (emptyPos.col === col && emptyPos.row < targetRow) emptyPos.row++;
            }
            renderGrid(true); setTimeout(() => checkForWordsInLaserRow(), 300);
        }

        function renderGrid(isGravityUpdate = false) {
            const el = document.getElementById('puzzleGrid'); el.innerHTML = '';
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const tile = document.createElement('button');
                    let className = 'tile';
                    if (grid[i][j] === '') className += ' empty';
                    if (i === targetRow && grid[i][j] !== '') className += ' laser-active';
                    if (isGravityUpdate && i === 0) className += ' new-spawn';
                    tile.className = className; tile.textContent = grid[i][j];
                    tile.style.width = `${tileSize}px`; tile.style.height = `${tileSize}px`;
                    tile.style.fontSize = `${tileSize * 0.4}px`;
                    tile.onclick = () => moveTile(i, j);
                    el.appendChild(tile);
                }
            }
        }

        function calculatePoints(word) { return (word.length * word.length) + 10; }

        function checkLevelUp() {
            const newLevel = Math.floor(score / 200) + 1;
            if (newLevel > level) {
                level = newLevel;
                const oldSize = gridSize;
                gridSize = Math.min(5 + (level - 1), 9);
                document.getElementById('level').textContent = level;
                document.getElementById('gridSize').textContent = `${gridSize}x${gridSize}`;
                if (gridSize > oldSize) { showMessage(`üöÄ GRID EXPANDED! üöÄ`, 'level-up'); setTimeout(() => initGame(), 2000); }
                else showMessage(`‚≠ê Level ${level}! ‚≠ê`, 'level-up');
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text; msg.className = `message ${type} show`;
            setTimeout(() => msg.classList.remove('show'), 2500);
        }

        // --- TIMER LOGIC ---
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 60; // Initial Time
            updateTimerDisplay();
            gameActive = true;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeLeft;
            if (timeLeft <= 10) timerEl.classList.add('low-time');
            else timerEl.classList.remove('low-time');
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            scoreManager.submitGameResult(score); // Send score to Firebase
            
            document.getElementById('gameOverOverlay').style.display = 'flex';
            document.getElementById('finalScore').textContent = score;
            
            if(isPlaying) toggleMusic(); // Stop music on game over
        }

        window.newGame = function() {
            if (!dictionaryLoaded) return;
            
            // Reset Logic
            document.getElementById('gameOverOverlay').style.display = 'none';
            score = 0; level = 1; gridSize = 5; wordsFound = [];
            
            document.getElementById('score').textContent = score;
            document.getElementById('level').textContent = level;
            document.getElementById('gridSize').textContent = `${gridSize}x${gridSize}`;
            document.getElementById('wordCount').textContent = 0;
            document.getElementById('wordList').innerHTML = '';
            
            scoreManager.startSession();
            initGame();
            startTimer(); // Start the clock!
            
            showMessage('Gravity Systems Online...', 'success');
            if(!isPlaying) toggleMusic();
        }

        loadDictionary();
    </script>
</body>
</html>
