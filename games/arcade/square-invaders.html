<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Square Invaders</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #000; 
            font-family: 'Courier New', monospace; 
        }
        canvas { 
            display: block; 
            background: #000; 
            width: 100vw; 
            height: 100vh; 
        }
        #ui {
            position: absolute; 
            top: 20px; 
            left: 20px; 
            color: #00ff00; 
            font-size: 20px;
            text-shadow: 0 0 10px #00ff00; 
            z-index: 10;
        }
        #title {
            position: absolute; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            color: #00ff00; 
            font-size: 42px; 
            font-weight: bold; 
            text-shadow: 0 0 20px #00ff00;
            z-index: 10;
        }
        #lives-display {
            position: absolute;
            bottom: 30px;
            left: 30px;
            z-index: 10;
        }
        #gameOver {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); 
            color: #00ff00; 
            padding: 40px; 
            border: 3px solid #00ff00;
            border-radius: 10px;
            text-align: center; 
            display: none; 
            z-index: 20; 
            max-width: 600px;
            box-shadow: 0 0 30px #00ff00;
        }
        
        #startScreen {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: #000;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            z-index: 30; 
            color: #00ff00; 
            overflow-y: auto; 
            padding: 40px 20px; 
            box-sizing: border-box; 
        }
        #startScreen h1 {
            font-size: 64px; 
            margin-bottom: 15px;
            text-shadow: 0 0 30px #00ff00;
            animation: pulse 2s infinite; 
            text-align: center;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        #startScreen .instructions {
            background: rgba(0,100,0,0.3); 
            padding: 20px; 
            border: 2px solid #00ff00;
            border-radius: 15px;
            margin: 20px; 
            max-width: 500px;
            box-shadow: 0 0 20px #00ff00;
        }
        #startScreen .instructions h2 { 
            margin-bottom: 15px; 
            font-size: 28px; 
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        #startScreen .instructions p { 
            margin: 10px 0; 
            font-size: 16px; 
            line-height: 1.6; 
        }
        #startScreen button {
            margin-top: 30px; 
            padding: 15px 50px; 
            font-size: 28px; 
            cursor: pointer;
            background: #00ff00; 
            color: #000; 
            border: none; 
            border-radius: 10px;
            font-weight: bold; 
            box-shadow: 0 0 20px #00ff00; 
            transition: transform 0.2s;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }
        #startScreen button:hover { 
            background: #00cc00; 
            transform: scale(1.05); 
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <h1>üëæ SQUARE INVADERS üëæ</h1>
        <div class="instructions">
            <h2>HOW TO PLAY</h2>
            <p><strong>OBJECTIVE:</strong> Destroy all invaders before they reach Earth!</p>
            <p><strong>CONTROLS:</strong></p>
            <p>‚Üê ‚Üí or A/D - Move</p>
            <p>SPACEBAR - Shoot</p>
            <p><strong>ENEMIES:</strong></p>
            <p>‚Ä¢ TOP ROW - 30 points</p>
            <p>‚Ä¢ MIDDLE ROWS - 20 points</p>
            <p>‚Ä¢ BOTTOM ROWS - 10 points</p>
            <p>‚Ä¢ MYSTERY UFO - 50-300 points</p>
            <p><strong>TIPS:</strong></p>
            <p>‚Ä¢ Hide behind barriers for protection</p>
            <p>‚Ä¢ Only one shot at a time!</p>
            <p>‚Ä¢ Invaders speed up as you destroy them</p>
            <p>‚Ä¢ Don't let them reach the bottom!</p>
        </div>
        <button onclick="startGame()">START GAME</button>
    </div>
    <div id="title">SQUARE INVADERS</div>
    <div id="ui">
        <div>SCORE: <span id="score">0</span></div>
        <div>WAVE: <span id="wave">1</span></div>
        <div>HIGH SCORE: <span id="highScore">0</span></div>
    </div>
    <div id="lives-display"></div>
    <div id="gameOver">
        <h1 id="endMessage">GAME OVER!</h1>
        <p id="finalScore"></p>
        <p id="currentHighScore"></p>
        <div id="credits" style="margin-top: 30px; height: 250px; overflow: hidden; position: relative;">
            <div id="creditsScroll" style="position: absolute; width: 100%; animation: scrollUp 8s linear 1;">
                <div style="text-align: center; font-size: 18px; line-height: 2.5; color: #00ff00;">
                    <p style="font-size: 24px; color: #00ff00; margin-bottom: 20px;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</p>
                    
                    <p style="font-size: 20px; color: #00ff00; margin-top: 30px;">GAME DESIGN</p>
                    <p style="color: #00ff00;">GunnersGames Studio</p>
                    
                    <p style="font-size: 20px; color: #00ff00; margin-top: 30px;">DEVELOPMENT</p>
                    <p style="color: #00ff00;">Claude AI Assistant</p>
                    
                    <p style="font-size: 20px; color: #00ff00; margin-top: 30px;">SPECIAL THANKS</p>
                    <p style="color: #00ff00;">All GunnersGames Players</p>
                    
                    <p style="font-size: 24px; color: #00ff00; margin-top: 40px;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</p>
                    
                    <p style="margin-top: 40px; color: #888; font-size: 14px;">
                        Returning to arcade in 5 seconds...
                    </p>
                    
                    <p style="margin-top: 60px; color: #666; font-size: 16px;">
                        THANKS FOR PLAYING!
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes scrollUp {
            0% { top: 100%; }
            100% { top: -100%; }
        }
    </style>
    <canvas id="game"></canvas>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.1/+esm';

        // Supabase configuration
        const SUPABASE_URL = 'https://nlqhnzevzxbxnzyfykpt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5scWhuemV2enhieG56eWZ5a3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM3NTg3MjYsImV4cCI6MjA0OTMzNDcyNn0.x95_kN4xNSFIuhQjxaTb_EYR6ueBVbhgvw-6B12YCZk';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Score Manager
        class ScoreManager {
            constructor(gameName) {
                this.gameName = gameName;
                this.sessionStartTime = Date.now();
                this.userId = null;
                this.checkAuth();
            }

            async checkAuth() {
                const { data: { user } } = await supabase.auth.getUser();
                this.userId = user?.id || null;
            }

            async submitGameResult(score) {
                if (!this.userId) return;
                const playTime = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                try {
                    await supabase.from('game_sessions').insert({
                        user_id: this.userId,
                        game_name: this.gameName,
                        score: score,
                        play_time_seconds: playTime
                    });
                } catch (error) {
                    console.error('Error submitting score:', error);
                }
            }

            getElapsedTimeFormatted() {
                const seconds = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        const scoreManager = new ScoreManager('square_invaders');

        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Audio context
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'shoot') {
                osc.frequency.value = 200;
                osc.type = 'square';
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'invader_kill') {
                osc.frequency.value = 100;
                osc.type = 'sawtooth';
                gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'explosion') {
                osc.frequency.value = 50;
                osc.type = 'sawtooth';
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.4);
            } else if (type === 'ufo') {
                osc.frequency.value = 600;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // Game state
        const gameState = {
            score: 0,
            lives: 3,
            wave: 1,
            highScore: parseInt(localStorage.getItem('squareInvadersHighScore') || '0'),
            gameRunning: false
        };

        // Keyboard input
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === ' ' && gameState.gameRunning) {
                e.preventDefault();
                shootBullet();
            }
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Player
        const player = {
            x: 0,
            y: 0,
            width: 30,
            height: 20,
            speed: 300,
            color: '#00ff00'
        };

        // Bullet
        let bullet = null;
        const bulletSpeed = 400;
        const bulletWidth = 4;
        const bulletHeight = 12;

        function shootBullet() {
            if (!bullet) {
                bullet = {
                    x: player.x + player.width / 2 - bulletWidth / 2,
                    y: player.y,
                    width: bulletWidth,
                    height: bulletHeight
                };
                playSound('shoot');
            }
        }

        // Invaders
        let invaders = [];
        const invaderWidth = 24;
        const invaderHeight = 20;
        const invaderSpacing = 40;
        let invaderDirection = 1;
        let invaderSpeed = 30;
        let invaderDropDistance = 20;
        let invaderMoveTimer = 0;
        let invaderMoveDelay = 0.5;

        function createInvaders() {
            invaders = [];
            const startY = 80;
            const rows = 5;
            const cols = 11;
            const startX = (canvas.width - (cols * invaderSpacing)) / 2;

            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    let type, points, color;
                    if (row === 0) {
                        type = 'top';
                        points = 30;
                        color = '#00ff00';
                    } else if (row <= 2) {
                        type = 'middle';
                        points = 20;
                        color = '#44ff44';
                    } else {
                        type = 'bottom';
                        points = 10;
                        color = '#88ff88';
                    }

                    invaders.push({
                        x: startX + col * invaderSpacing,
                        y: startY + row * invaderSpacing,
                        type: type,
                        points: points,
                        color: color,
                        width: invaderWidth,
                        height: invaderHeight
                    });
                }
            }
        }

        function updateInvaders(dt) {
            invaderMoveTimer += dt;
            
            if (invaderMoveTimer >= invaderMoveDelay) {
                invaderMoveTimer = 0;
                
                // Move all invaders
                let hitEdge = false;
                for (const inv of invaders) {
                    inv.x += invaderSpeed * invaderDirection;
                    if (inv.x <= 20 || inv.x >= canvas.width - invaderWidth - 20) {
                        hitEdge = true;
                    }
                }
                
                // Drop down if hit edge
                if (hitEdge) {
                    invaderDirection *= -1;
                    for (const inv of invaders) {
                        inv.y += invaderDropDistance;
                    }
                }
                
                // Speed up based on remaining invaders
                const remaining = invaders.length;
                invaderMoveDelay = 0.5 - (55 - remaining) * 0.008;
                invaderMoveDelay = Math.max(invaderMoveDelay, 0.1);
            }
        }

        // Invader bombs
        let bombs = [];
        const bombWidth = 4;
        const bombHeight = 12;
        const bombSpeed = 200;
        let bombTimer = 0;

        function dropBomb() {
            if (invaders.length === 0) return;
            const randomInvader = invaders[Math.floor(Math.random() * invaders.length)];
            bombs.push({
                x: randomInvader.x + randomInvader.width / 2 - bombWidth / 2,
                y: randomInvader.y + randomInvader.height,
                width: bombWidth,
                height: bombHeight
            });
        }

        function updateBombs(dt) {
            bombTimer += dt;
            if (bombTimer > 1) {
                dropBomb();
                bombTimer = 0;
            }

            for (let i = bombs.length - 1; i >= 0; i--) {
                bombs[i].y += bombSpeed * dt;
                if (bombs[i].y > canvas.height) {
                    bombs.splice(i, 1);
                }
            }
        }

        // UFO
        let ufo = null;
        const ufoWidth = 40;
        const ufoHeight = 20;
        const ufoSpeed = 100;
        let ufoTimer = 0;

        function spawnUFO() {
            const side = Math.random() < 0.5 ? -ufoWidth : canvas.width;
            const direction = side < 0 ? 1 : -1;
            ufo = {
                x: side,
                y: 40,
                width: ufoWidth,
                height: ufoHeight,
                vx: ufoSpeed * direction,
                points: [50, 100, 150, 300][Math.floor(Math.random() * 4)]
            };
            playSound('ufo');
        }

        function updateUFO(dt) {
            if (ufo) {
                ufo.x += ufo.vx * dt;
                if (ufo.x < -ufoWidth - 50 || ufo.x > canvas.width + 50) {
                    ufo = null;
                }
            } else {
                ufoTimer += dt;
                if (ufoTimer > 15) {
                    spawnUFO();
                    ufoTimer = 0;
                }
            }
        }

        // Barriers
        let barriers = [];
        const barrierBlockSize = 8;

        function createBarriers() {
            barriers = [];
            const numBarriers = 4;
            const barrierWidth = barrierBlockSize * 10;
            const barrierHeight = barrierBlockSize * 6;
            const spacing = canvas.width / (numBarriers + 1);

            for (let i = 0; i < numBarriers; i++) {
                const barrier = [];
                const startX = spacing * (i + 1) - barrierWidth / 2;
                const startY = canvas.height - 200;

                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 10; col++) {
                        // Create dome shape
                        if (row === 0 && (col < 2 || col > 7)) continue;
                        if (row === 1 && (col < 1 || col > 8)) continue;
                        if (row >= 4 && col >= 3 && col <= 6) continue; // Cut out bottom middle
                        
                        barrier.push({
                            x: startX + col * barrierBlockSize,
                            y: startY + row * barrierBlockSize,
                            size: barrierBlockSize
                        });
                    }
                }
                barriers.push(barrier);
            }
        }

        // Collision detection
        function checkCollisions() {
            // Bullet vs Invaders
            if (bullet) {
                for (let i = invaders.length - 1; i >= 0; i--) {
                    const inv = invaders[i];
                    if (bullet.x < inv.x + inv.width &&
                        bullet.x + bullet.width > inv.x &&
                        bullet.y < inv.y + inv.height &&
                        bullet.y + bullet.height > inv.y) {
                        gameState.score += inv.points;
                        invaders.splice(i, 1);
                        bullet = null;
                        playSound('invader_kill');
                        break;
                    }
                }
            }

            // Bullet vs UFO
            if (bullet && ufo) {
                if (bullet.x < ufo.x + ufo.width &&
                    bullet.x + bullet.width > ufo.x &&
                    bullet.y < ufo.y + ufo.height &&
                    bullet.y + bullet.height > ufo.y) {
                    gameState.score += ufo.points;
                    ufo = null;
                    bullet = null;
                    playSound('invader_kill');
                }
            }

            // Bullet vs Barriers
            if (bullet) {
                for (const barrier of barriers) {
                    for (let i = barrier.length - 1; i >= 0; i--) {
                        const block = barrier[i];
                        if (bullet.x < block.x + block.size &&
                            bullet.x + bullet.width > block.x &&
                            bullet.y < block.y + block.size &&
                            bullet.y + bullet.height > block.y) {
                            barrier.splice(i, 1);
                            bullet = null;
                            break;
                        }
                    }
                    if (!bullet) break;
                }
            }

            // Bombs vs Player
            for (let i = bombs.length - 1; i >= 0; i--) {
                const bomb = bombs[i];
                if (bomb.x < player.x + player.width &&
                    bomb.x + bomb.width > player.x &&
                    bomb.y < player.y + player.height &&
                    bomb.y + bomb.height > player.y) {
                    bombs.splice(i, 1);
                    playerHit();
                }
            }

            // Bombs vs Barriers
            for (let i = bombs.length - 1; i >= 0; i--) {
                const bomb = bombs[i];
                for (const barrier of barriers) {
                    for (let j = barrier.length - 1; j >= 0; j--) {
                        const block = barrier[j];
                        if (bomb.x < block.x + block.size &&
                            bomb.x + bomb.width > block.x &&
                            bomb.y < block.y + block.size &&
                            bomb.y + bomb.height > block.y) {
                            barrier.splice(j, 1);
                            bombs.splice(i, 1);
                            break;
                        }
                    }
                    if (i >= bombs.length) break;
                }
            }

            // Check if invaders reached bottom
            for (const inv of invaders) {
                if (inv.y + inv.height >= player.y) {
                    endGame();
                    return;
                }
            }
        }

        function playerHit() {
            gameState.lives--;
            playSound('explosion');
            
            if (gameState.lives <= 0) {
                endGame();
            } else {
                // Reset player position
                player.x = canvas.width / 2 - player.width / 2;
                bombs = [];
                bullet = null;
            }
        }

        function nextWave() {
            gameState.wave++;
            invaderDirection = 1;
            invaderSpeed = 30;
            invaderMoveDelay = 0.5;
            createInvaders();
            createBarriers();
            bombs = [];
            bullet = null;
            ufo = null;
            ufoTimer = 0;
        }

        // Drawing functions
        function drawPlayer() {
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Draw cannon
            ctx.fillRect(player.x + player.width / 2 - 3, player.y - 8, 6, 8);
        }

        function drawBullet() {
            if (bullet) {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            }
        }

        function drawInvaders() {
            for (const inv of invaders) {
                ctx.fillStyle = inv.color;
                ctx.fillRect(inv.x, inv.y, inv.width, inv.height);
                
                // Draw simple eyes
                ctx.fillStyle = '#000';
                ctx.fillRect(inv.x + 6, inv.y + 6, 4, 4);
                ctx.fillRect(inv.x + 14, inv.y + 6, 4, 4);
            }
        }

        function drawBombs() {
            ctx.fillStyle = '#ff0000';
            for (const bomb of bombs) {
                ctx.fillRect(bomb.x, bomb.y, bomb.width, bomb.height);
            }
        }

        function drawUFO() {
            if (ufo) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillRect(ufo.x, ufo.y, ufo.width, ufo.height);
                ctx.fillRect(ufo.x + 5, ufo.y - 8, ufo.width - 10, 8);
            }
        }

        function drawBarriers() {
            ctx.fillStyle = '#00ff00';
            for (const barrier of barriers) {
                for (const block of barrier) {
                    ctx.fillRect(block.x, block.y, block.size, block.size);
                }
            }
        }

        function drawLives() {
            const livesDisplay = document.getElementById('lives-display');
            livesDisplay.innerHTML = '';
            for (let i = 0; i < gameState.lives; i++) {
                const ship = document.createElement('span');
                ship.style.color = '#00ff00';
                ship.style.fontSize = '30px';
                ship.style.marginRight = '10px';
                ship.style.textShadow = '0 0 10px #00ff00';
                ship.textContent = '‚ñ≤';
                livesDisplay.appendChild(ship);
            }
        }

        // Update function
        function update(dt) {
            if (!gameState.gameRunning) return;

            // Update player position
            const speed = player.speed * dt;
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                player.x -= speed;
            }
            if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                player.x += speed;
            }
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

            // Update bullet
            if (bullet) {
                bullet.y -= bulletSpeed * dt;
                if (bullet.y < 0) {
                    bullet = null;
                }
            }

            // Update game objects
            updateInvaders(dt);
            updateBombs(dt);
            updateUFO(dt);

            // Check collisions
            checkCollisions();

            // Check for wave complete
            if (invaders.length === 0) {
                nextWave();
            }

            // Update UI
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('wave').textContent = gameState.wave;
            document.getElementById('highScore').textContent = gameState.highScore;
            drawLives();
        }

        function endGame() {
            gameState.gameRunning = false;
            
            // Submit to Supabase
            scoreManager.submitGameResult(gameState.score);
            
            const endDiv = document.getElementById('gameOver');
            document.getElementById('endMessage').textContent = 'GAME OVER!';
            
            const playTime = scoreManager.getElapsedTimeFormatted();
            document.getElementById('finalScore').textContent = `FINAL SCORE: ${gameState.score} | TIME: ${playTime}`;
            
            // Update local high score
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('squareInvadersHighScore', gameState.highScore);
                document.getElementById('currentHighScore').textContent = `NEW HIGH SCORE: ${gameState.highScore}!`;
                document.getElementById('currentHighScore').style.color = '#00ff00';
            } else {
                document.getElementById('currentHighScore').textContent = `HIGH SCORE: ${gameState.highScore}`;
                document.getElementById('currentHighScore').style.color = '#00ff00';
            }
            endDiv.style.display = 'block';
            
            // Auto-redirect to arcade after 5 seconds
            setTimeout(() => {
                window.location.href = '/arcade.html';
            }, 5000);
        }

        window.startGame = function() {
            document.getElementById('startScreen').style.display = 'none';
            gameState.gameRunning = true;
            gameState.score = 0;
            gameState.lives = 3;
            gameState.wave = 1;
            
            player.x = canvas.width / 2 - player.width / 2;
            player.y = canvas.height - 80;
            
            bullet = null;
            bombs = [];
            ufo = null;
            ufoTimer = 0;
            invaderDirection = 1;
            invaderSpeed = 30;
            invaderMoveDelay = 0.5;
            
            createInvaders();
            createBarriers();
            
            scoreManager.sessionStartTime = Date.now();
        }

        // Game loop
        let lastTime = 0;
        function gameLoop(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw everything
            drawBarriers();
            drawInvaders();
            drawUFO();
            drawBombs();
            drawBullet();
            drawPlayer();
            
            // Update game state
            update(dt);
            
            requestAnimationFrame(gameLoop);
        }
        gameLoop(0);
    </script>
</body>
</html>