<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ASCII DOOM</title>

<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden !important;
        background: black;
        height: 100%;
    }

    /* FIXED TERMINAL GRID */
    #gameContainer {
        position: absolute;
        top: 0;
        left: 0;

        /* Hardcoded ASCII DOOM grid size */
        width: calc(80 * 8.4px);   /* 80 columns */
        height: calc(40 * 14px);   /* 40 rows */

        background: black;
        color: lime;

        white-space: pre !important;
        font-family: monospace !important;

        font-size: 14px !important;
        line-height: 14px !important;

        overflow: hidden !important;
        padding: 10px;
        box-sizing: border-box;
    }

    #ui {
        position: absolute;
        top: 10px;
        left: calc(80 * 8.6px); /* Slight offset to appear right of grid */
        color: lime;
        font-family: monospace;
        font-size: 18px;
        text-shadow: 0 0 5px lime;
        z-index: 10;
    }

    #gameOver {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 30px;
        background: rgba(0, 0, 0, 0.85);
        border: 2px solid lime;
        color: lime;
        text-align: center;
        display: none;
        z-index: 50;
    }

    #gameOver button {
        margin-top: 15px;
        padding: 10px 20px;
        background: lime;
        color: black;
        border: none;
        font-weight: bold;
        cursor: pointer;
    }
</style>
</head>
<body>

<div id="ui">
    <div>Kills: <span id="kills">0</span></div>
    <div>Health: <span id="health">100</span></div>
    <div>Level: <span id="level">1</span></div>
</div>

<div id="gameContainer"></div>

<div id="gameOver">
    <h1>GAME OVER</h1>
    <div id="finalScore"></div>
    <button onclick="restartGame()">Restart</button>
</div>

<script type="module">
/* =========================================================
    SUPABASE AUTH + SCORE SUBMISSION
   ========================================================= */
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://pknhslxhpohrzgsfkisr.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_-zZw-pi_3q1sdNGhITKuhQ_ECyDARzc";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

class ScoreManager {
    constructor(gameName) {
        this.gameName = gameName;
        this.sessionStart = Date.now();
        this.user = null;
        this.loadUser();
    }

    async loadUser() {
        const { data: { user } } = await supabase.auth.getUser();
        this.user = user || null;
        if (!user) console.log("ASCII DOOM running without Supabase user â€” local only.");
    }

    getTimePlayed() {
        return Math.floor((Date.now() - this.sessionStart) / 1000);
    }

    async submitScore(score) {
        if (!this.user || score <= 0) return;

        const payload = {
            user_id: this.user.id,
            game: this.gameName,
            score: score,
            time_played: this.getTimePlayed()
        };

        const { error } = await supabase.from("stats").insert(payload);

        if (error) console.warn("Supabase insert failed:", error.message);
        else console.log("ASCII DOOM score saved:", payload);
    }
}

const scoreManager = new ScoreManager("ascii-doom");

/* =========================================================
    ASCII DOOM GAME ENGINE
   ========================================================= */
const gameContainer = document.getElementById("gameContainer");

let gameState = {
    width: 80,
    height: 40,
    playerX: 40,
    playerY: 20,
    kills: 0,
    health: 100,
    level: 1,
    enemies: [],
    bullets: [],
    running: true
};

function render() {
    let grid = Array.from({ length: gameState.height }, () =>
        Array(gameState.width).fill(" ")
    );

    grid[gameState.playerY][gameState.playerX] = "@";

    gameState.enemies.forEach(e => {
        if (e.alive) grid[e.y][e.x] = "D";
    });

    gameState.bullets.forEach(b => {
        grid[b.y][b.x] = "-";
    });

    gameContainer.textContent = grid.map(r => r.join("")).join("\n");

    document.getElementById("kills").textContent = gameState.kills;
    document.getElementById("health").textContent = gameState.health;
    document.getElementById("level").textContent = gameState.level;
}

function spawnEnemy() {
    gameState.enemies.push({
        x: Math.floor(Math.random() * gameState.width),
        y: Math.floor(Math.random() * gameState.height),
        alive: true
    });
}

function shoot() {
    gameState.bullets.push({
        x: gameState.playerX,
        y: gameState.playerY
    });
}

function updateEnemies() {
    gameState.enemies.forEach(e => {
        if (!e.alive) return;

        if (e.x < gameState.playerX) e.x++;
        if (e.x > gameState.playerX) e.x--;
        if (e.y < gameState.playerY) e.y++;
        if (e.y > gameState.playerY) e.y--;

        if (e.x === gameState.playerX && e.y === gameState.playerY) {
            gameState.health -= 10;
            if (gameState.health <= 0) endGame();
        }
    });
}

function updateBullets() {
    gameState.bullets.forEach(b => {
        b.x++;
        gameState.enemies.forEach(e => {
            if (e.alive && e.x === b.x && e.y === b.y) {
                e.alive = false;
                gameState.kills++;
            }
        });
    });

    gameState.bullets = gameState.bullets.filter(b => b.x < gameState.width);
}

function endGame() {
    gameState.running = false;

    const score = gameState.kills;
    scoreManager.submitScore(score);

    document.getElementById("finalScore").textContent =
        `Final Score: ${score} Kills`;

    document.getElementById("gameOver").style.display = "block";
}

window.restartGame = function() {
    gameState = {
        width: 80,
        height: 40,
        playerX: 40,
        playerY: 20,
        kills: 0,
        health: 100,
        level: gameState.level,
        enemies: [],
        bullets: [],
        running: true
    };
    scoreManager.sessionStart = Date.now();
    document.getElementById("gameOver").style.display = "none";
};

document.addEventListener("keydown", (e) => {
    if (!gameState.running) return;

    if (e.key === "w" && gameState.playerY > 0) gameState.playerY--;
    if (e.key === "s" && gameState.playerY < gameState.height - 1) gameState.playerY++;
    if (e.key === "a" && gameState.playerX > 0) gameState.playerX--;
    if (e.key === "d" && gameState.playerX < gameState.width - 1) gameState.playerX++;
    if (e.key === " ") shoot();
});

setInterval(() => {
    if (!gameState.running) return;
    updateEnemies();
    updateBullets();
    render();
}, 100);

setInterval(() => {
    if (!gameState.running) return;
    spawnEnemy();
}, 2000);

render();
</script>

</body>
</html>
