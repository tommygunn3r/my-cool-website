<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GunnersGames Multiplayer</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold: #d4af37;
            --gold-dark: #b8941f;
            --gold-light: #f4e5a7;
            --cream: #f5f3e8;
            --dark: #1a1410;
            --red: #8b0000;
            --green: #0a4a2e;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            color: var(--cream);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 3rem;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--gold);
        }

        .logo {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--gold);
            letter-spacing: 0.15em;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .balance {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .coin-icon {
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, var(--gold-light) 0%, var(--gold) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--dark);
            font-size: 1.1rem;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.5);
        }

        .username {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.2rem;
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .page-title {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            text-align: center;
            color: var(--gold);
            margin-bottom: 1rem;
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        }

        .page-subtitle {
            text-align: center;
            font-size: 1.2rem;
            color: var(--gold-light);
            margin-bottom: 3rem;
            opacity: 0.8;
        }

        /* Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .tab-btn {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            padding: 1rem 3rem;
            background: transparent;
            color: var(--gold-light);
            border: 2px solid var(--gold-dark);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 0.1em;
        }

        .tab-btn:hover {
            background: var(--gold-dark);
            color: var(--dark);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--dark);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.6);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Room Grid */
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .room-card {
            background: rgba(0,0,0,0.6);
            border: 2px solid var(--gold-dark);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            border-color: var(--gold);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .room-game {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
            font-weight: 600;
        }

        .room-status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .room-status.waiting {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            border: 1px solid #ffa500;
        }

        .room-status.playing {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .room-status.full {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
            border: 1px solid #ff4444;
        }

        .room-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--cream);
            font-size: 1.1rem;
        }

        .room-players {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .room-buy-in {
            color: var(--gold);
            font-weight: 600;
        }

        .room-host {
            font-size: 0.9rem;
            color: var(--gold-light);
            opacity: 0.7;
        }

        /* Create Room Section */
        .create-room-section {
            background: rgba(0,0,0,0.6);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--gold-dark);
            border-radius: 8px;
            color: var(--cream);
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .toggle-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .toggle-btn {
            flex: 1;
            padding: 0.8rem;
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--gold-dark);
            border-radius: 8px;
            color: var(--cream);
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .toggle-btn:hover {
            border-color: var(--gold);
        }

        .toggle-btn.active {
            background: var(--gold);
            color: var(--dark);
            border-color: var(--gold);
        }

        .create-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            border: none;
            border-radius: 50px;
            color: var(--dark);
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 0.1em;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.6);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gold-light);
            font-size: 1.2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(212, 175, 55, 0.2);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark) 0%, #2a1f1a 100%);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal-text {
            color: var(--cream);
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.primary {
            background: var(--gold);
            color: var(--dark);
        }

        .modal-btn.secondary {
            background: transparent;
            color: var(--gold);
            border: 2px solid var(--gold);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        /* Room Code Display */
        .room-code-display {
            background: rgba(0,0,0,0.4);
            border: 2px dashed var(--gold);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            margin: 1rem 0;
        }

        .room-code {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--gold);
            letter-spacing: 0.3em;
            font-weight: 700;
        }

        .copy-hint {
            font-size: 0.9rem;
            color: var(--gold-light);
            margin-top: 0.5rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem 1.5rem;
            }

            .logo {
                font-size: 1.5rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .tabs {
                flex-direction: column;
                gap: 1rem;
            }

            .tab-btn {
                width: 100%;
            }

            .room-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">GUNNERSGAMES</div>
        <div class="user-info">
            <div class="balance">
                <div class="coin-icon">G</div>
                <span id="userBalance">0</span>
            </div>
            <div class="username" id="username">Guest</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <h1 class="page-title">MULTIPLAYER LOBBY</h1>
        <p class="page-subtitle">Join a table or create your own room</p>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="browse">BROWSE ROOMS</button>
            <button class="tab-btn" data-tab="create">CREATE ROOM</button>
            <button class="tab-btn" data-tab="join">JOIN PRIVATE</button>
        </div>

        <!-- Browse Rooms Tab -->
        <div class="tab-content active" id="browse-tab">
            <div id="roomsLoading" class="loading">
                <div class="spinner"></div>
                Loading rooms...
            </div>
            <div id="roomsContainer" class="room-grid" style="display: none;"></div>
            <div id="emptyRooms" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ðŸŽ°</div>
                <div>No active rooms found</div>
                <div style="margin-top: 1rem; opacity: 0.7;">Be the first to create one!</div>
            </div>
        </div>

        <!-- Create Room Tab -->
        <div class="tab-content" id="create-tab">
            <div class="create-room-section">
                <h2 class="section-title">CREATE NEW ROOM</h2>
                
                <div class="form-group">
                    <label class="form-label">Game Type</label>
                    <select class="form-select" id="gameType">
                        <option value="texas-holdem">Texas Hold'em Poker</option>
                        <option value="roulette">Roulette</option>
                        <option value="blackjack">Blackjack</option>
                        <option value="liars-dice" disabled>Liar's Dice (Coming Soon)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Buy-In Amount</label>
                    <select class="form-select" id="buyIn">
                        <option value="500">500 GunnerCoins</option>
                        <option value="1000">1,000 GunnerCoins</option>
                        <option value="2000" selected>2,000 GunnerCoins</option>
                        <option value="5000">5,000 GunnerCoins</option>
                        <option value="10000">10,000 GunnerCoins</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Room Privacy</label>
                    <div class="toggle-group">
                        <button class="toggle-btn active" data-privacy="public">PUBLIC</button>
                        <button class="toggle-btn" data-privacy="private">PRIVATE</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Max Players</label>
                    <select class="form-select" id="maxPlayers">
                        <option value="2">2 Players</option>
                        <option value="3">3 Players</option>
                        <option value="4" selected>4 Players</option>
                        <option value="6">6 Players</option>
                        <option value="8">8 Players</option>
                    </select>
                </div>

                <button class="create-btn" id="createRoomBtn">CREATE ROOM</button>
            </div>
        </div>

        <!-- Join Private Room Tab -->
        <div class="tab-content" id="join-tab">
            <div class="create-room-section">
                <h2 class="section-title">JOIN PRIVATE ROOM</h2>
                
                <div class="form-group">
                    <label class="form-label">Enter Room Code</label>
                    <input type="text" class="form-input" id="roomCodeInput" placeholder="ABCD-1234" maxlength="9" style="text-transform: uppercase; text-align: center; font-size: 1.5rem; letter-spacing: 0.2em;">
                </div>

                <button class="create-btn" id="joinPrivateBtn">JOIN ROOM</button>
            </div>
        </div>
    </div>

    <!-- Room Code Modal -->
    <div class="modal" id="roomCodeModal">
        <div class="modal-content">
            <h2 class="modal-title">ROOM CREATED!</h2>
            <p class="modal-text">Share this code with your friends:</p>
            <div class="room-code-display">
                <div class="room-code" id="displayRoomCode">XXXX-XXXX</div>
                <div class="copy-hint">Click to copy</div>
            </div>
            <p class="modal-text" style="font-size: 0.9rem; opacity: 0.7;">Waiting for players to join...</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancelRoomBtn">CANCEL</button>
                <button class="modal-btn primary" id="enterRoomBtn">ENTER ROOM</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // ====== FIREBASE CONFIG ======
        // TODO: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database(); // Realtime Database for rooms
        const firestore = firebase.firestore(); // Firestore for user balance

        console.log('Firebase initialized');
        console.log('Auth domain:', firebaseConfig.authDomain);

        // ====== STATE ======
        let currentUser = null;
        let userBalance = 0;
        let roomsListener = null;
        let selectedPrivacy = 'public';

        // ====== INIT ======
        console.log('Waiting for auth state...');
        auth.onAuthStateChanged(user => {
            console.log('Auth state changed:', user ? user.email : 'No user');
            if (user) {
                currentUser = user;
                document.getElementById('username').innerText = user.displayName || user.email?.split('@')[0] || 'Player';
                loadUserBalance();
                loadRooms();
            } else {
                // Not authenticated - show message instead of redirect for debugging
                console.log('No user logged in');
                document.getElementById('username').innerText = 'Not Logged In';
                document.getElementById('userBalance').innerText = '0';
                
                // Uncomment this line once Firebase config is correct:
                // window.location.href = '/index.html';
            }
        });

        function loadUserBalance() {
            // Load balance from Firestore (where your GunnerCoins are stored)
            firestore.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    userBalance = doc.data().gunnercoins || 0;
                } else {
                    userBalance = 0;
                }
                document.getElementById('userBalance').innerText = userBalance.toLocaleString();
            }).catch(error => {
                console.error('Error loading balance:', error);
                userBalance = 0;
                document.getElementById('userBalance').innerText = '0';
            });
        }

        // ====== TAB SYSTEM ======
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`${tab}-tab`).classList.add('active');
            });
        });

        // ====== PRIVACY TOGGLE ======
        document.querySelectorAll('[data-privacy]').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedPrivacy = btn.dataset.privacy;
                document.querySelectorAll('[data-privacy]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // ====== LOAD ROOMS ======
        function loadRooms() {
            // Clean up old listener
            if (roomsListener) {
                database.ref('rooms').off('value', roomsListener);
            }

            document.getElementById('roomsLoading').style.display = 'block';
            document.getElementById('roomsContainer').style.display = 'none';
            document.getElementById('emptyRooms').style.display = 'none';

            // Listen for room changes
            roomsListener = database.ref('rooms').on('value', snapshot => {
                const rooms = snapshot.val();
                document.getElementById('roomsLoading').style.display = 'none';
                
                if (!rooms) {
                    document.getElementById('emptyRooms').style.display = 'block';
                    return;
                }

                // Clean up old rooms (older than 1 hour or finished with no players)
                const now = Date.now();
                const ONE_HOUR = 60 * 60 * 1000;
                
                Object.entries(rooms).forEach(([roomId, room]) => {
                    const roomAge = now - (room.createdAt || 0);
                    const hasPlayers = room.players && Object.keys(room.players).length > 0;
                    
                    // Delete if: finished with no players, or older than 1 hour
                    if ((room.status === 'finished' && !hasPlayers) || roomAge > ONE_HOUR) {
                        database.ref(`rooms/${roomId}`).remove();
                        console.log(`Cleaned up old room: ${roomId}`);
                    }
                });

                const container = document.getElementById('roomsContainer');
                container.innerHTML = '';
                container.style.display = 'grid';

                // Filter and display public rooms
                Object.entries(rooms).forEach(([roomId, room]) => {
                    if (room.privacy === 'public' && room.status !== 'finished') {
                        container.appendChild(createRoomCard(roomId, room));
                    }
                });

                if (container.children.length === 0) {
                    container.style.display = 'none';
                    document.getElementById('emptyRooms').style.display = 'block';
                }
            });
        }

        function createRoomCard(roomId, room) {
            const card = document.createElement('div');
            card.className = 'room-card';
            
            const playerCount = room.players ? Object.keys(room.players).length : 0;
            const statusClass = room.status === 'playing' ? 'playing' : 
                               playerCount >= room.maxPlayers ? 'full' : 'waiting';
            const statusText = room.status === 'playing' ? 'IN GAME' : 
                              playerCount >= room.maxPlayers ? 'FULL' : 'WAITING';

            card.innerHTML = `
                <div class="room-header">
                    <div class="room-game">${getGameName(room.gameType)}</div>
                    <div class="room-status ${statusClass}">${statusText}</div>
                </div>
                <div class="room-info">
                    <div class="room-players">
                        <span>ðŸ‘¥</span>
                        <span>${playerCount}/${room.maxPlayers}</span>
                    </div>
                    <div class="room-buy-in">ðŸ’° ${room.buyIn.toLocaleString()}</div>
                </div>
                <div class="room-host">Host: ${room.hostName}</div>
            `;

            if (statusClass !== 'full' && room.status !== 'playing') {
                card.addEventListener('click', () => joinRoom(roomId, room));
            } else {
                card.style.cursor = 'not-allowed';
                card.style.opacity = '0.6';
            }

            return card;
        }

        function getGameName(type) {
            const names = {
                'texas-holdem': 'Texas Hold\'em',
                'roulette': 'Roulette',
                'blackjack': 'Blackjack',
                'liars-dice': 'Liar\'s Dice'
            };
            return names[type] || type;
        }

        // ====== CREATE ROOM ======
        document.getElementById('createRoomBtn').addEventListener('click', createRoom);

        async function createRoom() {
            const gameType = document.getElementById('gameType').value;
            const buyIn = parseInt(document.getElementById('buyIn').value);
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);

            // Validate balance
            if (userBalance < buyIn) {
                alert(`Insufficient funds! You need ${buyIn.toLocaleString()} GunnerCoins.`);
                return;
            }

            // Generate room code for private rooms
            const roomCode = selectedPrivacy === 'private' ? generateRoomCode() : null;

            // Create room in database
            const roomRef = database.ref('rooms').push();
            const roomData = {
                gameType,
                buyIn,
                maxPlayers,
                privacy: selectedPrivacy,
                roomCode,
                hostId: currentUser.uid,
                hostName: currentUser.displayName || 'Player',
                status: 'waiting',
                createdAt: Date.now(),
                players: {
                    [currentUser.uid]: {
                        name: currentUser.displayName || 'Player',
                        chips: buyIn,
                        ready: false,
                        joinedAt: Date.now()
                    }
                }
            };

            try {
                await roomRef.set(roomData);
                
                // Deduct buy-in from Firestore balance
                await firestore.collection('users').doc(currentUser.uid).update({
                    gunnercoins: firebase.firestore.FieldValue.increment(-buyIn)
                });
                userBalance -= buyIn;
                document.getElementById('userBalance').innerText = userBalance.toLocaleString();

                if (selectedPrivacy === 'private') {
                    // Show room code modal
                    document.getElementById('displayRoomCode').innerText = roomCode;
                    document.getElementById('roomCodeModal').classList.add('active');
                    
                    // Set up modal buttons
                    document.getElementById('cancelRoomBtn').onclick = async () => {
                        await roomRef.remove();
                        // Refund buy-in to Firestore
                        await firestore.collection('users').doc(currentUser.uid).update({
                            gunnercoins: firebase.firestore.FieldValue.increment(buyIn)
                        });
                        userBalance += buyIn;
                        document.getElementById('userBalance').innerText = userBalance.toLocaleString();
                        document.getElementById('roomCodeModal').classList.remove('active');
                    };
                    
                    document.getElementById('enterRoomBtn').onclick = () => {
                        document.getElementById('roomCodeModal').classList.remove('active');
                        enterGameRoom(roomRef.key, gameType);
                    };

                    // Copy code on click
                    document.getElementById('displayRoomCode').onclick = () => {
                        navigator.clipboard.writeText(roomCode);
                        const hint = document.querySelector('.copy-hint');
                        hint.innerText = 'Copied!';
                        setTimeout(() => hint.innerText = 'Click to copy', 2000);
                    };
                } else {
                    // Public room - enter immediately
                    enterGameRoom(roomRef.key, gameType);
                }
            } catch (error) {
                console.error('Error creating room:', error);
                alert('Failed to create room. Please try again.');
            }
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                if (i === 4) code += '-';
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        // ====== JOIN ROOM ======
        async function joinRoom(roomId, room) {
            // Validate balance
            if (userBalance < room.buyIn) {
                alert(`Insufficient funds! You need ${room.buyIn.toLocaleString()} GunnerCoins.`);
                return;
            }

            try {
                // Add player to room
                await database.ref(`rooms/${roomId}/players/${currentUser.uid}`).set({
                    name: currentUser.displayName || 'Player',
                    chips: room.buyIn,
                    ready: false,
                    joinedAt: Date.now()
                });

                // Deduct buy-in from Firestore
                await firestore.collection('users').doc(currentUser.uid).update({
                    gunnercoins: firebase.firestore.FieldValue.increment(-room.buyIn)
                });
                userBalance -= room.buyIn;
                document.getElementById('userBalance').innerText = userBalance.toLocaleString();

                // Enter game room
                enterGameRoom(roomId, room.gameType);
            } catch (error) {
                console.error('Error joining room:', error);
                alert('Failed to join room. Please try again.');
            }
        }

        // ====== JOIN PRIVATE ROOM ======
        document.getElementById('joinPrivateBtn').addEventListener('click', async () => {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!code || code.length < 8) {
                alert('Please enter a valid room code.');
                return;
            }

            try {
                // Search for room with this code
                const snapshot = await database.ref('rooms')
                    .orderByChild('roomCode')
                    .equalTo(code)
                    .once('value');

                const rooms = snapshot.val();
                
                if (!rooms) {
                    alert('Room not found. Please check the code and try again.');
                    return;
                }

                const roomId = Object.keys(rooms)[0];
                const room = rooms[roomId];

                if (room.status === 'finished') {
                    alert('This room has ended.');
                    return;
                }

                const playerCount = room.players ? Object.keys(room.players).length : 0;
                if (playerCount >= room.maxPlayers) {
                    alert('This room is full.');
                    return;
                }

                await joinRoom(roomId, room);
            } catch (error) {
                console.error('Error finding room:', error);
                alert('Failed to find room. Please try again.');
            }
        });

        // ====== ENTER GAME ROOM ======
        function enterGameRoom(roomId, gameType) {
            // Store room info in session storage
            sessionStorage.setItem('currentRoom', roomId);
            
            // Redirect to appropriate game
            const gameUrls = {
                'texas-holdem': '/games/multiplayer/texas-holdem.html',
                'roulette': '/games/multiplayer/roulette.html',
                'blackjack': '/games/multiplayer/blackjack.html'
            };

            window.location.href = `${gameUrls[gameType]}?room=${roomId}`;
        }

        // ====== CLEANUP ======
        window.addEventListener('beforeunload', () => {
            if (roomsListener) {
                database.ref('rooms').off('value', roomsListener);
            }
        });
    </script>
</body>
</html>