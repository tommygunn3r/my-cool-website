<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GunnersGames Multiplayer Lobby</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #050509;
            --bg-alt: #131321;
            --card-bg: #141422;
            --gold: #f5c25c;
            --gold-light: #ffe29b;
            --accent: #36c2ff;
            --accent-soft: rgba(54, 194, 255, 0.2);
            --danger: #ff4d4d;
            --text-main: #f5f5f5;
            --text-soft: #b0b0c0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: radial-gradient(circle at top, #202040 0%, #050509 60%);
            color: var(--text-main);
            font-family: "Roboto", sans-serif;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 3rem;
            background: linear-gradient(to right, #0b0b14, #141428);
            border-bottom: 1px solid rgba(245, 194, 92, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .logo {
            font-family: "Cinzel", serif;
            font-size: 1.8rem;
            letter-spacing: 0.25em;
            color: var(--gold);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .balance {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(0,0,0,0.4);
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            border: 1px solid rgba(245, 194, 92, 0.7);
        }

        .coin-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 20%, var(--gold-light), var(--gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: #3b2b10;
            box-shadow: 0 0 10px rgba(245, 194, 92, 0.6);
        }

        .username {
            font-weight: 500;
            color: var(--text-main);
        }

        .name-input {
            padding: 0.4rem 0.7rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.35);
            color: var(--text-main);
            min-width: 160px;
        }

        .name-input::placeholder {
            color: var(--text-soft);
        }

        /* Main Layout */
        .container {
            max-width: 1100px;
            margin: 2rem auto 3rem;
            padding: 0 1rem;
        }

        .page-title {
            text-align: center;
            font-size: 2.6rem;
            margin-bottom: 0.4rem;
            font-family: "Cinzel", serif;
            letter-spacing: 0.15em;
        }

        .page-subtitle {
            text-align: center;
            color: var(--text-soft);
            margin-bottom: 2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.7rem 1.7rem;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(7, 7, 20, 0.9);
            color: var(--text-soft);
            cursor: pointer;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 0.85rem;
            transition: all 0.15s ease;
        }

        .tab-btn.active {
            background: radial-gradient(circle at top, var(--accent), var(--accent-soft));
            color: #021018;
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(54, 194, 255, 0.6);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Browse Rooms */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
            color: var(--text-soft);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: var(--accent);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .room-card {
            background: linear-gradient(145deg, #15152a, #1c1c38);
            border-radius: 14px;
            padding: 1.2rem 1.3rem;
            box-shadow: 0 4px 18px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.08);
            position: relative;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        }

        .room-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 26px rgba(0,0,0,0.8);
            border-color: rgba(54, 194, 255, 0.7);
        }

        .room-title {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
            letter-spacing: 0.1em;
        }

        .room-subtitle {
            font-size: 0.85rem;
            color: var(--text-soft);
            margin-bottom: 0.7rem;
        }

        .room-meta {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .room-badge {
            position: absolute;
            top: 0.8rem;
            right: 0.9rem;
            padding: 0.2rem 0.7rem;
            border-radius: 999px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .room-badge.empty {
            background: rgba(0,0,0,0.35);
            color: var(--text-soft);
        }

        .room-badge.waiting {
            background: rgba(245, 194, 92, 0.15);
            color: var(--gold-light);
            border-color: var(--gold);
        }

        .room-badge.playing {
            background: rgba(0, 200, 120, 0.15);
            color: #7cfac2;
            border-color: #00d08a;
        }

        .empty-state {
            text-align: center;
            padding: 2.5rem 1rem;
            color: var(--text-soft);
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 0.7rem;
        }

        /* Create Room */
        .create-room-section {
            background: rgba(10, 10, 20, 0.9);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 6px 22px rgba(0,0,0,0.7);
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--text-soft);
        }

        .form-select,
        .form-input {
            width: 100%;
            padding: 0.55rem 0.7rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(8,8,18,0.95);
            color: var(--text-main);
        }

        .form-select:focus,
        .form-input:focus,
        .name-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(54, 194, 255, 0.4);
        }

        .create-room-hint {
            font-size: 0.85rem;
            color: var(--text-soft);
            margin-bottom: 1rem;
        }

        .btn-primary {
            display: inline-block;
            padding: 0.7rem 1.4rem;
            border-radius: 999px;
            border: none;
            background: radial-gradient(circle at top, var(--gold-light), var(--gold));
            color: #2b1c08;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(245, 194, 92, 0.5);
        }

        /* Join Private (placeholder) */
        .coming-soon {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-soft);
        }

        /* Status Bar */
        #statusBar {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-soft);
            opacity: 0.8;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header {
                padding: 1rem 1.5rem;
            }
            .logo {
                font-size: 1.4rem;
                letter-spacing: 0.18em;
            }
            .container {
                margin-top: 1.5rem;
            }
            .page-title {
                font-size: 2rem;
            }
            .tabs {
                flex-direction: column;
                gap: 0.7rem;
            }
            .tab-btn {
                width: 100%;
            }
            .room-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="logo">GUNNERSGAMES</div>
        <div class="user-info">
            <div class="balance">
                <div class="coin-icon">G</div>
                <span id="userBalance">0</span>
            </div>
            <div class="username" id="usernameLabel">Guest</div>
            <input id="playerNameInput" class="name-input" type="text" placeholder="Enter name..." />
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <h1 class="page-title">MULTIPLAYER LOBBY</h1>
        <p class="page-subtitle">Join a static room or reserve one as host</p>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="browse">BROWSE ROOMS</button>
            <button class="tab-btn" data-tab="create">CREATE / HOST</button>
            <button class="tab-btn" data-tab="join">JOIN PRIVATE (Coming Soon)</button>
        </div>

        <!-- Browse Rooms Tab -->
        <div class="tab-content active" id="browse-tab">
            <div id="roomsLoading" class="loading">
                <div class="spinner"></div>
                Loading rooms...
            </div>
            <div id="roomsContainer" class="room-grid" style="display: none;"></div>
            <div id="emptyRooms" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ðŸŽ°</div>
                <div>No rooms found</div>
                <div style="margin-top: 1rem; opacity: 0.7;">You can host one in the Create / Host tab.</div>
            </div>
        </div>

        <!-- Create Room Tab -->
        <div class="tab-content" id="create-tab">
            <div class="create-room-section">
                <h2 class="section-title">RESERVE A STATIC ROOM</h2>
                <p class="create-room-hint">
                    The backend currently provides 4 static rooms (<strong>room1â€“room4</strong>).  
                    As the first player to join a room, you become the <strong>host</strong> and can set game type & max players.
                </p>

                <div class="form-group">
                    <label class="form-label">Room Slot</label>
                    <select class="form-select" id="roomSlot">
                        <option value="room1">Room 1</option>
                        <option value="room2">Room 2</option>
                        <option value="room3">Room 3</option>
                        <option value="room4">Room 4</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Game Type</label>
                    <select class="form-select" id="gameType">
                        <option value="who-wrote-it-better">Who Wrote It Better? ðŸŽµ</option>
                        <option value="texas-holdem" disabled>Texas Hold'em (Soon)</option>
                        <option value="roulette" disabled>Roulette (Soon)</option>
                        <option value="blackjack" disabled>Blackjack (Soon)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Max Players</label>
                    <select class="form-select" id="maxPlayers">
                        <option value="2">2 Players</option>
                        <option value="3">3 Players</option>
                        <option value="4" selected>4 Players</option>
                    </select>
                </div>

                <p class="create-room-hint">
                    <strong>Note:</strong> GunnerCoin buy-ins and private invite codes will be wired in later once the backend supports it.
                </p>

                <button class="btn-primary" id="hostRoomBtn">
                    HOST ROOM & START GAME
                </button>
            </div>
        </div>

        <!-- Join Private Tab (placeholder for now) -->
        <div class="tab-content" id="join-tab">
            <div class="coming-soon">
                <h3>Private Rooms Coming Soon</h3>
                <p>
                    The new backend is live and using static rooms (<code>room1â€“room4</code>).
                    Once we add support for invite codes / extra rooms, this tab will let you join by code.
                </p>
            </div>
        </div>

        <div id="statusBar">Connecting to backend...</div>
    </div>

    <script src="multiplayer-core.js"></script>
    <script>
        const BACKEND = "https://gunnersgames-backend.onrender.com";

        // Basic local identity
        let playerId = localStorage.getItem("gg_playerId");
        if (!playerId) {
            playerId = "p_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem("gg_playerId", playerId);
        }

        const playerNameInput = document.getElementById("playerNameInput");
        const usernameLabel = document.getElementById("usernameLabel");
        const storedName = localStorage.getItem("gg_playerName") || "";
        playerNameInput.value = storedName;
        usernameLabel.innerText = storedName || "Guest";

        playerNameInput.addEventListener("input", () => {
            const name = playerNameInput.value.trim();
            localStorage.setItem("gg_playerName", name);
            usernameLabel.innerText = name || "Guest";
        });

        // Tabs
        document.querySelectorAll(".tab-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
                document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

                btn.classList.add("active");
                document.getElementById(tab + "-tab").classList.add("active");
            });
        });

        // Lobby status
        const statusBar = document.getElementById("statusBar");
        function setStatus(msg) {
            statusBar.innerText = msg;
        }

        // Fetch and render rooms
        async function loadRooms() {
            setStatus("Loading rooms...");
            document.getElementById("roomsLoading").style.display = "flex";
            document.getElementById("roomsContainer").style.display = "none";
            document.getElementById("emptyRooms").style.display = "none";

            try {
                const rooms = await MultiplayerGame.fetchRooms(BACKEND);
                renderRooms(rooms);
                if (rooms && rooms.length > 0) {
                    document.getElementById("roomsLoading").style.display = "none";
                    document.getElementById("roomsContainer").style.display = "grid";
                    setStatus("Lobby updated.");
                } else {
                    document.getElementById("roomsLoading").style.display = "none";
                    document.getElementById("emptyRooms").style.display = "block";
                    setStatus("No rooms available.");
                }
            } catch (err) {
                console.error(err);
                document.getElementById("roomsLoading").style.display = "none";
                document.getElementById("emptyRooms").style.display = "block";
                setStatus("Error loading rooms.");
            }
        }

        function renderRooms(rooms) {
            const container = document.getElementById("roomsContainer");
            container.innerHTML = "";

            rooms.forEach(room => {
                const card = document.createElement("div");
                card.className = "room-card";

                const status = room.status || "empty";
                const players = parseInt(room.player_count || 0, 10);
                const maxPlayers = room.max_players || 4;
                const gameType = room.game_type || null;

                const badge = document.createElement("div");
                badge.className = "room-badge " + status;
                badge.innerText = status.toUpperCase();
                card.appendChild(badge);

                const title = document.createElement("div");
                title.className = "room-title";
                title.innerText = room.id.toUpperCase();
                card.appendChild(title);

                const subtitle = document.createElement("div");
                subtitle.className = "room-subtitle";
                subtitle.innerText = gameType
                    ? ("Game: " + getGameName(gameType))
                    : "Game not set yet (host decides)";
                card.appendChild(subtitle);

                const meta1 = document.createElement("div");
                meta1.className = "room-meta";
                meta1.innerText = "Players: " + players + "/" + maxPlayers;
                card.appendChild(meta1);

                const meta2 = document.createElement("div");
                meta2.className = "room-meta";
                const hostName = room.host_name || "None";
                meta2.innerText = "Host: " + hostName;
                card.appendChild(meta2);

                if (status === "playing" && players >= maxPlayers) {
                    card.style.opacity = "0.6";
                    card.style.cursor = "not-allowed";
                } else {
                    card.addEventListener("click", () => {
                        joinRoomAndEnter(room.id);
                    });
                }

                container.appendChild(card);
            });
        }

        function getGameName(type) {
            const names = {
                "who-wrote-it-better": "Who Wrote It Better?",
                "texas-holdem": "Texas Hold'em",
                "roulette": "Roulette",
                "blackjack": "Blackjack"
            };
            return names[type] || type;
        }

        async function joinRoomAndEnter(roomId) {
            const playerName = (playerNameInput.value || "").trim();
            if (!playerName) {
                alert("Please enter a player name in the top-right first.");
                return;
            }

            try {
                setStatus("Joining " + roomId + "...");
                const res = await fetch(`${BACKEND}/rooms/${encodeURIComponent(roomId)}/join`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        playerId,
                        playerName
                    })
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || "Failed to join room");
                }

                const data = await res.json();
                const room = data.room || data; // depending on backend shape

                const gameType = room.game_type || "who-wrote-it-better";

                // Save a bit of context
                sessionStorage.setItem("currentRoom", roomId);
                sessionStorage.setItem("currentPlayerId", playerId);
                sessionStorage.setItem("currentPlayerName", playerName);

                const gameUrls = {
                    "who-wrote-it-better": "/games/multiplayer/who-wrote-it-better.html",
                    "texas-holdem": "/games/multiplayer/texas-holdem.html",
                    "roulette": "/games/multiplayer/roulette.html",
                    "blackjack": "/games/multiplayer/blackjack.html"
                };

                const targetUrl = gameUrls[gameType] || gameUrls["who-wrote-it-better"];

                setStatus(`Joined ${roomId}. Launching ${getGameName(gameType)}...`);
                window.location.href = `${targetUrl}?room=${roomId}`;
            } catch (err) {
                console.error(err);
                alert("Failed to join room: " + err.message);
                setStatus("Failed to join room.");
            }
        }

        // Host room via Create tab
        document.getElementById("hostRoomBtn").addEventListener("click", async () => {
            const playerName = (playerNameInput.value || "").trim();
            if (!playerName) {
                alert("Please enter a player name in the top-right first.");
                return;
            }

            const roomId = document.getElementById("roomSlot").value;
            const gameType = document.getElementById("gameType").value;
            const maxPlayers = parseInt(document.getElementById("maxPlayers").value, 10);

            try {
                setStatus("Reserving " + roomId + " as host...");

                // 1) Join the room (this will make us host if it's empty)
                const joinRes = await fetch(`${BACKEND}/rooms/${encodeURIComponent(roomId)}/join`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        playerId,
                        playerName
                    })
                });

                if (!joinRes.ok) {
                    const errData = await joinRes.json().catch(() => ({}));
                    throw new Error(errData.error || "Failed to join room");
                }

                // 2) Set room settings (requires us to be host)
                const settingsRes = await fetch(`${BACKEND}/rooms/${encodeURIComponent(roomId)}/settings`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        hostId: playerId,
                        gameType,
                        maxPlayers,
                        buyIn: 0
                    })
                });

                if (!settingsRes.ok) {
                    const errData = await settingsRes.json().catch(() => ({}));
                    throw new Error(errData.error || "Failed to set room settings");
                }

                // 3) (Optional) set status to waiting
                await fetch(`${BACKEND}/rooms/${encodeURIComponent(roomId)}/status`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        hostId: playerId,
                        status: "waiting"
                    })
                }).catch(() => {});

                // Save context and go to game
                sessionStorage.setItem("currentRoom", roomId);
                sessionStorage.setItem("currentPlayerId", playerId);
                sessionStorage.setItem("currentPlayerName", playerName);

                const gameUrls = {
                    "who-wrote-it-better": "/games/multiplayer/who-wrote-it-better.html",
                    "texas-holdem": "/games/multiplayer/texas-holdem.html",
                    "roulette": "/games/multiplayer/roulette.html",
                    "blackjack": "/games/multiplayer/blackjack.html"
                };

                const targetUrl = gameUrls[gameType] || gameUrls["who-wrote-it-better"];

                setStatus(`Hosting ${roomId}. Launching ${getGameName(gameType)}...`);
                window.location.href = `${targetUrl}?room=${roomId}`;
            } catch (err) {
                console.error(err);
                alert("Failed to host room: " + err.message);
                setStatus("Failed to host room.");
            }
        });

        // Initial load + polling
        loadRooms();
        // Simple polling every 4 seconds so lobby updates while open
        setInterval(loadRooms, 4000);
    </script>
</body>
</html>
